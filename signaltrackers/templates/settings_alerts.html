{% extends "base.html" %}

{% block title %}Alert Settings - SignalTrackers{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="bi bi-bell"></i> Alert & Notification Settings
            </h1>
            <p class="lead text-muted">Customize when and how you receive market notifications</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <form id="alert-settings-form" method="POST" action="{{ url_for('save_alert_settings') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <!-- Daily Briefing Section -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-envelope"></i> Daily Briefing Email</h5>
                    </div>
                    <div class="card-body">
                        <!-- Enable/Disable -->
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="daily_briefing_enabled"
                                       name="daily_briefing_enabled" {{ 'checked' if prefs.daily_briefing_enabled }}>
                                <label class="form-check-label" for="daily_briefing_enabled">
                                    <strong>Enable Daily Briefing Email</strong>
                                </label>
                            </div>
                            <small class="text-muted">Receive a comprehensive market summary via email</small>
                        </div>

                        <div id="briefing-options" style="{{ 'display: none;' if not prefs.daily_briefing_enabled }}">
                            <!-- Frequency -->
                            <div class="mb-3">
                                <label for="briefing_frequency" class="form-label">Frequency</label>
                                <select class="form-select" id="briefing_frequency" name="briefing_frequency">
                                    <option value="daily" {{ 'selected' if prefs.briefing_frequency == 'daily' }}>Daily</option>
                                    <option value="weekly" {{ 'selected' if prefs.briefing_frequency == 'weekly' }}>Weekly (Monday)</option>
                                </select>
                            </div>

                            <!-- Send Time -->
                            <div class="mb-3">
                                <label for="briefing_time" class="form-label">Preferred Time</label>
                                <input type="time" class="form-control" id="briefing_time" name="briefing_time"
                                       value="{{ prefs.briefing_time.strftime('%H:%M') }}">
                                <small class="text-muted">Email will be sent at this time in your timezone</small>
                            </div>

                            <!-- Timezone -->
                            <div class="mb-3">
                                <label for="briefing_timezone" class="form-label">Timezone</label>
                                <select class="form-select" id="briefing_timezone" name="briefing_timezone">
                                    {% for tz in timezones %}
                                    <option value="{{ tz }}" {{ 'selected' if prefs.briefing_timezone == tz }}>{{ tz }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Portfolio Analysis -->
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="include_portfolio_analysis"
                                           name="include_portfolio_analysis" {{ 'checked' if prefs.include_portfolio_analysis }}>
                                    <label class="form-check-label" for="include_portfolio_analysis">
                                        Include personalized portfolio analysis
                                    </label>
                                </div>
                                <small class="text-muted">Adds AI-generated context for your portfolio allocation</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Smart Alerts Section -->
                <div class="card mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Smart Market Alerts</h5>
                    </div>
                    <div class="card-body">
                        <!-- Master Toggle -->
                        <div class="mb-4 pb-3 border-bottom">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="alerts_enabled"
                                       name="alerts_enabled" {{ 'checked' if prefs.alerts_enabled }}>
                                <label class="form-check-label" for="alerts_enabled">
                                    <strong>Enable All Alerts</strong>
                                </label>
                            </div>
                            <small class="text-muted">Master control for all alert notifications</small>
                        </div>

                        <div id="alert-options" style="{{ 'display: none;' if not prefs.alerts_enabled }}">
                            <!-- Individual Alert Toggles -->
                            <h6 class="mb-3">Alert Types</h6>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="vix_threshold_25"
                                           name="vix_threshold_25" {{ 'checked' if prefs.vix_threshold_25 }}>
                                    <label class="form-check-label" for="vix_threshold_25">
                                        <strong>VIX Spike (>25)</strong>
                                    </label>
                                </div>
                                <small class="text-muted d-block ms-4">Notify when VIX crosses 25 (elevated volatility)</small>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="vix_threshold_30"
                                           name="vix_threshold_30" {{ 'checked' if prefs.vix_threshold_30 }}>
                                    <label class="form-check-label" for="vix_threshold_30">
                                        <strong>VIX Spike (>30)</strong>
                                    </label>
                                </div>
                                <small class="text-muted d-block ms-4">Notify when VIX crosses 30 (extreme volatility)</small>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="credit_spread_threshold_50bp"
                                           name="credit_spread_threshold_50bp" {{ 'checked' if prefs.credit_spread_threshold_50bp }}>
                                    <label class="form-check-label" for="credit_spread_threshold_50bp">
                                        <strong>Credit Spreads Widening</strong>
                                    </label>
                                </div>
                                <small class="text-muted d-block ms-4">Notify when spreads widen >50bp in a week</small>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="yield_curve_inversion"
                                           name="yield_curve_inversion" {{ 'checked' if prefs.yield_curve_inversion }}>
                                    <label class="form-check-label" for="yield_curve_inversion">
                                        <strong>Yield Curve Changes</strong>
                                    </label>
                                </div>
                                <small class="text-muted d-block ms-4">Notify when curve inverts or un-inverts</small>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="equity_breadth_deterioration"
                                           name="equity_breadth_deterioration" {{ 'checked' if prefs.equity_breadth_deterioration }}>
                                    <label class="form-check-label" for="equity_breadth_deterioration">
                                        <strong>Equity Breadth Deterioration</strong>
                                    </label>
                                </div>
                                <small class="text-muted d-block ms-4">Notify when market breadth weakens significantly</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="d-grid gap-2 mb-4">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-check-circle"></i> Save Preferences
                    </button>
                </div>

                <!-- Success/Error Messages -->
                <div id="alert-message" class="alert alert-dismissible fade" role="alert" style="display: none;">
                    <span id="alert-message-text"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </form>
        </div>

        <!-- Sidebar Info -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> How Alerts Work</h6>
                </div>
                <div class="card-body">
                    <ul class="small mb-0">
                        <li class="mb-2">Alerts check market conditions every 15 minutes</li>
                        <li class="mb-2">You'll receive immediate email notifications when thresholds are crossed</li>
                        <li class="mb-2">Duplicate alerts are suppressed (24-48 hour cooldown)</li>
                        <li class="mb-2">All alerts are logged in <a href="{{ url_for('alert_history') }}">Alert History</a></li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-shield-check"></i> Privacy</h6>
                </div>
                <div class="card-body">
                    <p class="small mb-0">
                        Your email preferences are private to your account.
                        You can unsubscribe from any email type using the link in each email.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Toggle visibility of sub-options
document.getElementById('daily_briefing_enabled').addEventListener('change', function() {
    document.getElementById('briefing-options').style.display = this.checked ? 'block' : 'none';
});

document.getElementById('alerts_enabled').addEventListener('change', function() {
    document.getElementById('alert-options').style.display = this.checked ? 'block' : 'none';
});

// Handle form submission
document.getElementById('alert-settings-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const response = await fetch(this.action, {
        method: 'POST',
        body: formData
    });

    const result = await response.json();
    const alertDiv = document.getElementById('alert-message');
    const alertText = document.getElementById('alert-message-text');

    alertDiv.className = 'alert alert-dismissible fade show ' + (result.success ? 'alert-success' : 'alert-danger');
    alertText.textContent = result.message;
    alertDiv.style.display = 'block';

    // Scroll to message
    alertDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
});
</script>
{% endblock %}
