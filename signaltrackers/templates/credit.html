{% extends "base.html" %}

{% block title %}Credit Markets - SignalTrackers{% endblock %}

{% block extra_css %}
<!-- Component Styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/chart-container.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/collapsible-section.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/key-stats-panel.css') }}">
<style>
/* Mobile-First Credit Page Styles */
:root {
    /* Design system custom properties */
    --space-1: 0.25rem;
    --space-2: 0.5rem;
    --space-3: 0.75rem;
    --space-4: 1rem;
    --space-5: 1.5rem;
    --space-6: 2rem;
    --space-8: 3rem;
    --space-10: 4rem;

    --text-xs: 0.75rem;
    --text-sm: 0.875rem;
    --text-base: 1rem;
    --text-lg: 1.125rem;
    --text-xl: 1.25rem;
    --text-2xl: 1.5rem;
    --text-3xl: 1.875rem;

    --neutral-50: #f8f9fa;
    --neutral-100: #f1f3f5;
    --neutral-200: #dee2e6;
    --neutral-300: #ced4da;
    --neutral-500: #6c757d;
    --neutral-600: #495057;
    --neutral-700: #343a40;
    --neutral-800: #212529;

    --brand-blue-100: #cfe2ff;
    --brand-blue-500: #0d6efd;
    --success-600: #198754;
    --danger-600: #dc3545;
    --warning-600: #ffc107;
    --info-600: #0dcaf0;

    --container-xl: 1280px;
}

/* Page header */
.credit-header {
    padding: var(--space-4);
    background: white;
    border-bottom: 1px solid var(--neutral-200);
}

.credit-header__title {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--neutral-800);
    margin: 0 0 var(--space-2) 0;
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.credit-header__description {
    font-size: var(--text-sm);
    color: var(--neutral-600);
    margin: 0 0 var(--space-2) 0;
}

.credit-header__updated {
    font-size: var(--text-sm);
    color: var(--neutral-500);
    margin: 0;
}

/* Content page */
.content-page {
    background: var(--neutral-50);
    min-height: calc(100vh - 64px);
}

/* Content grid (mobile: stacked, tablet+: side-by-side) */
.content-grid {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    padding: var(--space-4);
}

/* Time range controls */
.time-range-controls {
    display: flex;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    background: white;
    margin: 0 var(--space-4);
    border-radius: 8px;
    flex-wrap: wrap;
}

.time-range-controls__button {
    min-height: 44px;
    min-width: 60px;
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-sm);
    font-weight: 600;
    border: 1px solid var(--neutral-300);
    border-radius: 6px;
    background: white;
    color: var(--neutral-700);
    cursor: pointer;
    transition: all 150ms ease-out;
}

.time-range-controls__button:hover {
    background: var(--neutral-50);
    border-color: var(--brand-blue-500);
}

.time-range-controls__button.active {
    background: var(--brand-blue-500);
    color: white;
    border-color: var(--brand-blue-500);
}

.time-range-controls__button:focus {
    outline: 2px solid var(--brand-blue-500);
    outline-offset: 2px;
}

/* Statistics grid within collapsible section */
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
}

.stat-item {
    text-align: center;
    padding: var(--space-3);
    background: var(--neutral-50);
    border-radius: 8px;
}

.stat-item__label {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--neutral-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-2);
}

.stat-item__value {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--neutral-800);
    font-family: monospace;
}

.stat-item__value--large {
    font-size: var(--text-2xl);
}

.stat-item__secondary {
    font-size: var(--text-xs);
    color: var(--neutral-500);
    margin-top: var(--space-1);
}

/* Analysis cards within collapsible section */
.analysis-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-4);
}

.analysis-card {
    padding: var(--space-4);
    background: var(--neutral-50);
    border-radius: 8px;
    border-left: 4px solid var(--info-600);
}

.analysis-card--warning {
    border-left-color: var(--danger-600);
}

.analysis-card--info {
    border-left-color: var(--info-600);
}

.analysis-card__title {
    font-size: var(--text-base);
    font-weight: 600;
    color: var(--neutral-700);
    margin-bottom: var(--space-3);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.analysis-card__content {
    font-size: var(--text-sm);
    color: var(--neutral-600);
    line-height: 1.6;
}

.analysis-card__content ul {
    margin: 0;
    padding-left: var(--space-5);
}

.analysis-card__content li {
    margin-bottom: var(--space-2);
}

.analysis-card__content hr {
    margin: var(--space-3) 0;
    border: 0;
    border-top: 1px solid var(--neutral-200);
}

/* ETF table */
.etf-table {
    width: 100%;
    font-size: var(--text-sm);
    border-collapse: collapse;
}

.etf-table thead th {
    background: var(--neutral-100);
    padding: var(--space-3);
    text-align: left;
    font-weight: 600;
    color: var(--neutral-700);
    border-bottom: 2px solid var(--neutral-300);
}

.etf-table tbody td {
    padding: var(--space-3);
    border-bottom: 1px solid var(--neutral-200);
}

.etf-table tbody tr:hover {
    background: var(--neutral-50);
}

/* Tablet+ layouts */
@media (min-width: 768px) {
    .credit-header {
        padding: var(--space-6);
    }

    .credit-header__title {
        font-size: var(--text-3xl);
    }

    .content-grid {
        display: grid;
        grid-template-columns: 1.5fr 1fr; /* 60/40 split */
        gap: var(--space-6);
        padding: var(--space-6);
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .analysis-grid {
        grid-template-columns: 1fr;
    }
}

/* Desktop layouts */
@media (min-width: 1024px) {
    .content-grid {
        grid-template-columns: 2fr 1fr; /* 66/33 split */
        gap: var(--space-8);
        max-width: var(--container-xl);
        margin: 0 auto;
        padding: var(--space-8);
    }

    .stats-grid {
        grid-template-columns: 1fr 1fr;
    }

    .analysis-grid {
        grid-template-columns: 1fr 1fr;
    }
}

@media (min-width: 1280px) {
    .content-grid {
        gap: var(--space-10);
    }
}
</style>
{% endblock %}

{% block content %}
<main class="content-page">
    <!-- Page Header -->
    <header class="credit-header">
        <h1 class="credit-header__title">
            <i class="bi bi-bank"></i> Credit Markets
        </h1>
        <p class="credit-header__description">Tracking credit spreads, ETF performance, and corporate debt markets</p>
        <p class="credit-header__updated">Last Updated: <span id="last-updated-time">Loading...</span></p>
    </header>

    <!-- Content Grid: Stacked on mobile, side-by-side on tablet+ -->
    <div class="content-grid">
        <!-- Left Column: Chart (mobile: full width, tablet+: 60-66% width) -->
        <div>
            <!-- Chart Container (HERO ELEMENT on mobile) -->
            <div class="chart-container">
                <canvas id="credit-spreads-chart"></canvas>
            </div>

            <!-- Time Range Controls (below chart) -->
            <div class="time-range-controls">
                <button type="button" class="time-range-controls__button" data-timeframe="30">1M</button>
                <button type="button" class="time-range-controls__button" data-timeframe="90">3M</button>
                <button type="button" class="time-range-controls__button" data-timeframe="180">6M</button>
                <button type="button" class="time-range-controls__button active" data-timeframe="365">1Y</button>
                <button type="button" class="time-range-controls__button" data-timeframe="1825">5Y</button>
                <button type="button" class="time-range-controls__button" data-timeframe="3650">10Y</button>
                <button type="button" class="time-range-controls__button" data-timeframe="all">All</button>
            </div>
        </div>

        <!-- Right Column: Key Stats Panel (hidden on mobile, visible tablet+) -->
        <aside class="key-stats-panel">
            <h3 class="key-stats-panel__title">Key Metrics</h3>

            <div class="stat-card stat-card--danger">
                <div class="stat-card__label">High-Yield Spreads</div>
                <div class="stat-card__value" id="key-hy-spread">-- bp</div>
                <div class="stat-card__secondary" id="key-hy-change">--</div>
            </div>

            <div class="stat-card stat-card--info">
                <div class="stat-card__label">Investment Grade</div>
                <div class="stat-card__value" id="key-ig-spread">-- bp</div>
                <div class="stat-card__secondary">Quality debt</div>
            </div>

            <div class="stat-card stat-card--warning">
                <div class="stat-card__label">CCC/HY Ratio</div>
                <div class="stat-card__value" id="key-ccc-ratio">--x</div>
                <div class="stat-card__secondary">Distress indicator</div>
            </div>
        </aside>
    </div>

    <!-- Collapsible Section: Market Statistics -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="market-stats">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title">Market Statistics</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-item__label">High-Yield Spread</div>
                    <div class="stat-item__value stat-item__value--large" id="credit-hy-spread">-- bp</div>
                    <div class="stat-item__secondary" id="credit-hy-change">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">Investment Grade</div>
                    <div class="stat-item__value" id="credit-ig-spread">-- bp</div>
                    <div class="stat-item__secondary">Extremely tight</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">CCC/HY Ratio</div>
                    <div class="stat-item__value" id="credit-ccc-ratio">--x</div>
                    <div class="stat-item__secondary">Distressed lagging</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: About Credit Markets -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="about-credit">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title">About Credit Markets</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div class="analysis-card">
                <div class="analysis-card__content">
                    <p><strong>Credit spreads</strong> measure the risk premium investors demand to hold corporate bonds over risk-free Treasuries. Wider spreads indicate higher perceived credit risk, while tighter spreads suggest investor complacency.</p>
                    <p><strong>High-Yield (HY) spreads</strong> are the difference between junk bond yields and Treasury yields. Historically, spreads below 300 basis points (bp) signal extreme complacency, while spreads above 800bp indicate crisis conditions.</p>
                    <p><strong>Investment Grade (IG) spreads</strong> track higher-quality corporate debt. Current levels near 80bp are extremely tight, suggesting minimal default risk priced in.</p>
                    <p><strong>CCC/HY Ratio</strong> compares distressed debt spreads to the broader high-yield market. A rising ratio indicates quality bifurcation and increased stress among the weakest borrowers.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: Warning Signs -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="warning-signs">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title">‚ö†Ô∏è Warning Signs</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div class="analysis-card analysis-card--warning">
                <div class="analysis-card__content">
                    <ul>
                        <li><strong>HY at 276 bp:</strong> Tightest in dataset (0th percentile)</li>
                        <li><strong>IG at 79 bp:</strong> Rock-solid confidence in quality debt</li>
                        <li><strong>Tightening trend:</strong> Spreads still compressing despite warnings</li>
                        <li><strong>CCC lagging:</strong> Quality bifurcation emerging</li>
                    </ul>
                    <hr>
                    <p class="mb-0">
                        <strong>Implication:</strong> Credit markets pricing ZERO systemic risk.
                        Historically, this level of complacency precedes sharp widening.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: What to Watch -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="what-to-watch">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title">üìä What to Watch</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div class="analysis-card analysis-card--info">
                <div class="analysis-card__title">Critical Levels</div>
                <div class="analysis-card__content">
                    <ul>
                        <li><strong>300 bp:</strong> First warning (early widening)</li>
                        <li><strong>350 bp:</strong> Clear deterioration beginning</li>
                        <li><strong>500 bp:</strong> Significant stress</li>
                        <li><strong>800+ bp:</strong> Crisis mode</li>
                    </ul>
                    <hr>
                    <p class="mb-0">
                        <strong>Expected:</strong> Spreads begin widening in Q2 2026 (6-9 months from Bitcoin crash).
                        Target: 320-400 bp by June 2026.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: ETF Performance -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="etf-performance">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-bar-chart-line"></i> Credit ETF Performance</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div style="background: white; padding: var(--space-4); border-radius: 8px;">
                <table class="etf-table">
                    <thead>
                        <tr>
                            <th>ETF</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>30-Day</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="credit-etf-table">
                        <tr><td colspan="5" style="text-align: center;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</main>
{% endblock %}

{% block extra_js %}
<script>
let recessionData = []; // Store recession periods for shading
let creditChart = null;
let currentTimeframe = 365; // Default to 1Y

// Fetch recession data on load
fetch('/api/recessions')
    .then(response => response.json())
    .then(data => {
        recessionData = data;
    })
    .catch(error => {
        console.error('Error loading recession data:', error);
    });

// Generate recession annotations for chart
function getRecessionAnnotations(startDate, endDate) {
    if (!recessionData || recessionData.length === 0) return {};

    const chartStart = new Date(startDate);
    const chartEnd = new Date(endDate);
    const annotations = {};

    recessionData.forEach((recession, idx) => {
        const recStart = new Date(recession.start_date);
        const recEnd = new Date(recession.end_date);

        // Check if recession overlaps with chart date range
        if (recEnd >= chartStart && recStart <= chartEnd) {
            // Clamp to chart boundaries
            const displayStart = recStart < chartStart ? chartStart : recStart;
            const displayEnd = recEnd > chartEnd ? chartEnd : recEnd;

            annotations[`recession_${idx}`] = {
                type: 'box',
                xMin: displayStart.toISOString().split('T')[0],
                xMax: displayEnd.toISOString().split('T')[0],
                backgroundColor: 'rgba(128, 128, 128, 0.15)',
                borderWidth: 0,
                label: {
                    display: false
                }
            };
        }
    });

    return annotations;
}

// Load credit data
async function loadCreditData() {
    try {
        const response = await fetch('/api/dashboard');
        const data = await response.json();

        if (data.metrics.hy_spread) {
            document.getElementById('credit-hy-spread').textContent = `${data.metrics.hy_spread.current} bp`;
            document.getElementById('key-hy-spread').textContent = `${data.metrics.hy_spread.current} bp`;
            document.getElementById('credit-hy-change').textContent =
                (data.metrics.hy_spread.change_30d >= 0 ? '+' : '') + data.metrics.hy_spread.change_30d + ' bp (30d)';
            document.getElementById('key-hy-change').textContent =
                (data.metrics.hy_spread.change_30d >= 0 ? '+' : '') + data.metrics.hy_spread.change_30d + ' bp (30d)';
        }

        if (data.metrics.ccc_hy_ratio) {
            document.getElementById('credit-ccc-ratio').textContent = data.metrics.ccc_hy_ratio.toFixed(2);
            document.getElementById('key-ccc-ratio').textContent = data.metrics.ccc_hy_ratio.toFixed(2) + 'x';
        }

        // Update ETF table
        const etfData = [
            { ticker: 'HYG', name: 'High Yield Bond', price: '--', change: '--', status: 'Tracking' },
            { ticker: 'LQD', name: 'Investment Grade', price: '--', change: '--', status: 'Tracking' },
            { ticker: 'BKLN', name: 'Leveraged Loans', price: '--', change: '--', status: 'Tracking' }
        ];

        const tableBody = document.getElementById('credit-etf-table');
        tableBody.innerHTML = etfData.map(etf => `
            <tr>
                <td><strong>${etf.ticker}</strong></td>
                <td>${etf.name}</td>
                <td>${etf.price}</td>
                <td>${etf.change}</td>
                <td><span class="badge bg-secondary">${etf.status}</span></td>
            </tr>
        `).join('');

        // Update last updated time
        const now = new Date();
        document.getElementById('last-updated-time').textContent = now.toLocaleString();

    } catch (error) {
        console.error('Error loading credit data:', error);
    }
}

// Load credit spreads chart
async function loadCreditChart() {
    try {
        const response = await fetch('/api/chart/credit_spreads');
        const data = await response.json();

        // Get recession annotations for the current date range
        const startDate = data.dates[0];
        const endDate = data.dates[data.dates.length - 1];
        const recessionAnnotations = getRecessionAnnotations(startDate, endDate);

        if (creditChart) {
            creditChart.destroy();
        }

        const ctx = document.getElementById('credit-spreads-chart');
        creditChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.dates,
                datasets: [
                    {
                        label: 'High Yield',
                        data: data.hy_spread,
                        borderColor: 'rgb(220, 53, 69)',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        pointRadius: 0,
                        tension: 0.1
                    },
                    {
                        label: 'Investment Grade',
                        data: data.ig_spread,
                        borderColor: 'rgb(13, 110, 253)',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0,
                        tension: 0.1
                    },
                    {
                        label: 'CCC-Rated',
                        data: data.ccc_spread,
                        borderColor: 'rgb(255, 193, 7)',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(0) + ' bp';
                            }
                        }
                    },
                    annotation: {
                        annotations: recessionAnnotations
                    }
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'Spread (basis points)'
                        }
                    }
                }
            }
        });

    } catch (error) {
        console.error('Error loading credit chart:', error);
    }
}

// Initialize collapsible sections
function initCollapsibleSections() {
    const sections = document.querySelectorAll('.collapsible-section');

    sections.forEach(section => {
        const header = section.querySelector('.collapsible-section__header');
        const content = section.querySelector('.collapsible-section__content');

        header.addEventListener('click', () => {
            const isExpanded = header.getAttribute('aria-expanded') === 'true';

            // Toggle state
            header.setAttribute('aria-expanded', !isExpanded);
            content.hidden = isExpanded;
        });

        // Keyboard support
        header.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                header.click();
            }
        });
    });
}

// Initialize time range controls
function initTimeRangeControls() {
    const buttons = document.querySelectorAll('.time-range-controls__button');

    buttons.forEach(button => {
        button.addEventListener('click', () => {
            // Remove active class from all buttons
            buttons.forEach(btn => btn.classList.remove('active'));

            // Add active class to clicked button
            button.classList.add('active');

            // Get timeframe
            const timeframe = button.getAttribute('data-timeframe');

            // TODO: Implement timeframe filtering for chart
            // This would require backend API support for filtered data
            console.log('Selected timeframe:', timeframe);
        });
    });
}

document.addEventListener('DOMContentLoaded', function() {
    loadCreditData();
    loadCreditChart();
    initCollapsibleSections();
    initTimeRangeControls();

    setInterval(loadCreditData, 60000);
});
</script>
{% endblock %}
