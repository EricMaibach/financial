{% extends "base.html" %}

{% block title %}Metric Explorer - SignalTrackers{% endblock %}

{% block extra_css %}
<!-- Component Styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/sticky-selector.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/chart-container.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/collapsible-section.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/key-stats-panel.css') }}">
<style>
/* Mobile-First Explorer Page Styles */
:root {
    /* Design system custom properties */
    --space-1: 0.25rem;
    --space-2: 0.5rem;
    --space-3: 0.75rem;
    --space-4: 1rem;
    --space-5: 1.5rem;
    --space-6: 2rem;
    --space-8: 3rem;
    --space-10: 4rem;

    --text-xs: 0.75rem;
    --text-sm: 0.875rem;
    --text-base: 1rem;
    --text-lg: 1.125rem;
    --text-xl: 1.25rem;
    --text-2xl: 1.5rem;
    --text-3xl: 1.875rem;
    --text-4xl: 2.25rem;

    --neutral-50: #f8f9fa;
    --neutral-100: #f1f3f5;
    --neutral-200: #dee2e6;
    --neutral-300: #ced4da;
    --neutral-400: #adb5bd;
    --neutral-500: #6c757d;
    --neutral-600: #495057;
    --neutral-700: #343a40;
    --neutral-800: #212529;

    --brand-blue-100: #cfe2ff;
    --brand-blue-500: #0d6efd;

    --success-600: #198754;
    --success-700: #157347;
    --danger-600: #dc3545;
    --danger-700: #bb2d3b;
    --warning-600: #ffc107;
    --info-600: #0dcaf0;

    --container-xl: 1280px;
}

/* Page header */
.explorer-header {
    padding: var(--space-4);
    background: white;
    border-bottom: 1px solid var(--neutral-200);
}

.explorer-header__title {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--neutral-800);
    margin: 0 0 var(--space-2) 0;
}

.explorer-header__updated {
    font-size: var(--text-sm);
    color: var(--neutral-500);
    margin: 0;
}

/* Content grid (mobile: stacked, tablet+: side-by-side) */
.content-page {
    background: var(--neutral-50);
    min-height: calc(100vh - 64px);
}

.content-grid {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    padding: var(--space-4);
}

/* Time range controls */
.time-range-controls {
    display: flex;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    background: white;
    margin: 0 var(--space-4);
    border-radius: 8px;
    flex-wrap: wrap;
}

.time-range-controls__button {
    min-height: 44px;
    min-width: 60px;
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-sm);
    font-weight: 600;
    border: 1px solid var(--neutral-300);
    border-radius: 6px;
    background: white;
    color: var(--neutral-700);
    cursor: pointer;
    transition: all 150ms ease-out;
}

.time-range-controls__button:hover {
    background: var(--neutral-50);
    border-color: var(--brand-blue-500);
}

.time-range-controls__button.active {
    background: var(--brand-blue-500);
    color: white;
    border-color: var(--brand-blue-500);
}

.time-range-controls__button:focus {
    outline: 2px solid var(--brand-blue-500);
    outline-offset: 2px;
}

/* Statistics grid within collapsible section */
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
}

.stat-item {
    text-align: center;
    padding: var(--space-3);
    background: var(--neutral-50);
    border-radius: 8px;
}

.stat-item__label {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--neutral-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-2);
}

.stat-item__value {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--neutral-800);
    font-family: monospace;
}

.stat-item__value--large {
    font-size: var(--text-2xl);
}

.stat-item__secondary {
    font-size: var(--text-xs);
    color: var(--neutral-500);
    margin-top: var(--space-1);
}

/* About section content */
.about-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-4);
}

.about-card {
    padding: var(--space-4);
    background: var(--neutral-50);
    border-radius: 8px;
    border-left: 4px solid var(--info-600);
}

.about-card__title {
    font-size: var(--text-base);
    font-weight: 600;
    color: var(--neutral-700);
    margin-bottom: var(--space-2);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.about-card__content {
    font-size: var(--text-sm);
    color: var(--neutral-600);
    line-height: 1.6;
}

/* Tablet+ layouts */
@media (min-width: 768px) {
    .explorer-header {
        padding: var(--space-6);
    }

    .explorer-header__title {
        font-size: var(--text-3xl);
    }

    .content-grid {
        display: grid;
        grid-template-columns: 1.5fr 1fr; /* 60/40 split */
        gap: var(--space-6);
        padding: var(--space-6);
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .stat-item__value {
        font-size: var(--text-2xl);
    }

    .about-grid {
        grid-template-columns: 1fr;
    }
}

/* Desktop layouts */
@media (min-width: 1024px) {
    .content-grid {
        grid-template-columns: 2fr 1fr; /* 66/33 split */
        gap: var(--space-8);
        max-width: var(--container-xl);
        margin: 0 auto;
        padding: var(--space-8);
    }

    .stats-grid {
        grid-template-columns: 1fr 1fr;
    }

    .about-grid {
        grid-template-columns: 1fr;
    }
}

@media (min-width: 1280px) {
    .content-grid {
        gap: var(--space-10);
    }

    .stats-grid {
        grid-template-columns: 1fr 1fr;
    }
}

/* Hidden by default, shown when metric selected */
.hidden {
    display: none;
}

/* Comparison indicator */
.comparison-indicator {
    background: var(--neutral-100);
    padding: var(--space-3);
    border-radius: 6px;
    margin: var(--space-4);
    font-size: var(--text-sm);
}

.comparison-legend {
    margin-left: var(--space-2);
}
</style>
{% endblock %}

{% block content %}
<main class="content-page">
    <!-- Page Header -->
    <header class="explorer-header">
        <h1 class="explorer-header__title">Metric Explorer</h1>
        <p class="explorer-header__updated">Select any metric to view its complete historical data and trends</p>
    </header>

    <!-- Sticky Metric Selector (Explorer-specific) -->
    <div class="sticky-selector" data-stuck="false">
        <label for="metricSelector" class="sticky-selector__label">
            Select Metric:
        </label>
        <select id="metricSelector" class="sticky-selector__dropdown">
            <option value="">-- Choose a metric --</option>
        </select>
    </div>

    <!-- Content Grid: Stacked on mobile, side-by-side on tablet+ -->
    <div id="metricContent" class="hidden">
        <div class="content-grid">
            <!-- Left Column: Chart (mobile: full width, tablet+: 60-66% width) -->
            <div>
                <!-- Chart Container (HERO ELEMENT on mobile) -->
                <div class="chart-container">
                    <canvas id="explorerChart"></canvas>
                </div>

                <!-- Time Range Controls (below chart) -->
                <div class="time-range-controls">
                    <button type="button" class="time-range-controls__button" data-timeframe="7">1W</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="30">1M</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="90">3M</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="180">6M</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="365">1Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="1825">5Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="3650">10Y</button>
                    <button type="button" class="time-range-controls__button active" data-timeframe="all">All</button>
                </div>
            </div>

            <!-- Right Column: Key Stats Panel (hidden on mobile, visible tablet+) -->
            <aside class="key-stats-panel">
                <h3 class="key-stats-panel__title">Key Statistics</h3>

                <div class="stat-card">
                    <div class="stat-card__label">Current Value</div>
                    <div class="stat-card__value" id="key-current-value">--</div>
                </div>

                <div class="stat-card stat-card--success">
                    <div class="stat-card__label">1-Day Change</div>
                    <div class="stat-card__value" id="key-change-1d">--</div>
                </div>

                <div class="stat-card stat-card--info">
                    <div class="stat-card__label">30-Day Change</div>
                    <div class="stat-card__value" id="key-change-30d">--</div>
                </div>

                <div class="stat-card stat-card--neutral">
                    <div class="stat-card__label">Average</div>
                    <div class="stat-card__value" id="key-avg-value">--</div>
                </div>

                <div class="stat-card stat-card--neutral">
                    <div class="stat-card__label">Data Points</div>
                    <div class="stat-card__value" id="key-data-points">--</div>
                </div>
            </aside>
        </div>

        <!-- Comparison Indicator (when comparing metrics) -->
        <div id="comparisonIndicator" class="comparison-indicator hidden">
            <strong><i class="bi bi-graph-up"></i> Comparing Metrics:</strong>
            <span id="comparisonLegend" class="comparison-legend"></span>
            <div id="unitWarning" class="hidden" style="margin-top: 0.5rem;">
                <small><i class="bi bi-info-circle"></i> <em>Comparison metrics are scaled to fit the primary metric's range.</em></small>
            </div>
        </div>

        <!-- Collapsible Section: Market Statistics -->
        <div class="collapsible-section" data-collapsed="true" data-section-id="market-stats">
            <button class="collapsible-section__header" aria-expanded="false">
                <h2 class="collapsible-section__title">Market Statistics</h2>
                <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
            <div class="collapsible-section__content" hidden>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-item__label">Current Value</div>
                        <div class="stat-item__value stat-item__value--large" id="current-value">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item__label">1-Day Change</div>
                        <div class="stat-item__value" id="change-1d">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item__label">30-Day Change</div>
                        <div class="stat-item__value" id="change-30d">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item__label">Data Points</div>
                        <div class="stat-item__value" id="data-points">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item__label">Minimum</div>
                        <div class="stat-item__value" id="min-value">--</div>
                        <div class="stat-item__secondary" id="min-date"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item__label">Average</div>
                        <div class="stat-item__value" id="avg-value">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item__label">Maximum</div>
                        <div class="stat-item__value" id="max-value">--</div>
                        <div class="stat-item__secondary" id="max-date"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item__label">Date Range</div>
                        <div class="stat-item__value" id="date-range" style="font-size: var(--text-sm);">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Collapsible Section: About This Metric -->
        <div class="collapsible-section" data-collapsed="true" data-section-id="about-metric">
            <button class="collapsible-section__header" aria-expanded="false">
                <h2 class="collapsible-section__title">About This Metric</h2>
                <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
            <div class="collapsible-section__content" hidden>
                <div class="about-grid">
                    <div class="about-card" style="border-left-color: var(--brand-blue-500);">
                        <h3 class="about-card__title">
                            <i class="bi bi-question-circle"></i> What It Is
                        </h3>
                        <p class="about-card__content" id="info-what">--</p>
                    </div>
                    <div class="about-card" style="border-left-color: var(--success-600);">
                        <h3 class="about-card__title">
                            <i class="bi bi-lightbulb"></i> Why It Matters
                        </h3>
                        <p class="about-card__content" id="info-why">--</p>
                    </div>
                    <div class="about-card" style="border-left-color: var(--warning-600);">
                        <h3 class="about-card__title">
                            <i class="bi bi-eye"></i> What To Watch
                        </h3>
                        <p class="about-card__content" id="info-watch">--</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<!-- Component Scripts -->
<script src="{{ url_for('static', filename='js/components/collapsible-section.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/sticky-selector.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
let currentChart = null;
let availableMetrics = [];
let fullDataCache = null;
let currentMetricsToLoad = [];
let recessionData = [];
const metricColors = [
    'rgb(75, 192, 192)',
    'rgb(153, 102, 255)',
    'rgb(255, 159, 64)'
];

// Fetch recession data on load
fetch('/api/recessions')
    .then(response => response.json())
    .then(data => {
        recessionData = data;
    })
    .catch(error => {
        console.error('Error loading recession data:', error);
    });

// Generate recession annotations for chart
function getRecessionAnnotations(startDate, endDate) {
    if (!recessionData || recessionData.length === 0) return {};

    const chartStart = new Date(startDate);
    const chartEnd = new Date(endDate);
    const annotations = {};

    recessionData.forEach((recession, idx) => {
        const recStart = new Date(recession.start_date);
        const recEnd = new Date(recession.end_date);

        if (recEnd >= chartStart && recStart <= chartEnd) {
            const displayStart = recStart < chartStart ? chartStart : recStart;
            const displayEnd = recEnd > chartEnd ? chartEnd : recEnd;

            annotations[`recession_${idx}`] = {
                type: 'box',
                xMin: displayStart.toISOString().split('T')[0],
                xMax: displayEnd.toISOString().split('T')[0],
                backgroundColor: 'rgba(128, 128, 128, 0.15)',
                borderWidth: 0,
                label: {
                    display: false
                }
            };
        }
    });

    return annotations;
}

// Load all available metrics
fetch('/api/metrics/list')
    .then(response => response.json())
    .then(metrics => {
        availableMetrics = metrics;

        const selector = document.getElementById('metricSelector');
        metrics.forEach(metric => {
            const option = document.createElement('option');
            option.value = metric.value;
            option.textContent = metric.label;
            selector.appendChild(option);
        });

        // Check for metric query parameter
        const urlParams = new URLSearchParams(window.location.search);
        const metricParam = urlParams.get('metric');
        if (metricParam) {
            const metricExists = metrics.some(m => m.value === metricParam);
            if (metricExists) {
                selector.value = metricParam;
                loadMetrics();
            }
        }
    })
    .catch(error => {
        console.error('Error loading metrics list:', error);
    });

// Handle metric selection
document.getElementById('metricSelector').addEventListener('change', function() {
    const metricName = this.value;
    if (!metricName) {
        document.getElementById('metricContent').classList.add('hidden');
        return;
    }

    loadMetrics();
});

// Time frame selector button handlers
document.querySelectorAll('.time-range-controls__button').forEach(button => {
    button.addEventListener('click', function() {
        document.querySelectorAll('.time-range-controls__button').forEach(btn => {
            btn.classList.remove('active');
        });
        this.classList.add('active');

        const timeFrame = this.getAttribute('data-timeframe');
        applyTimeFrameFilter(timeFrame);
    });
});

function getMetricUnit(metricName) {
    if (metricName.includes('price') || metricName.includes('gold') || metricName.includes('bitcoin')) {
        return '$';
    } else if (metricName.includes('spread') || metricName.includes('gap')) {
        return ' bp';
    }
    return '';
}

function applyTimeFrameFilter(timeFrame) {
    if (!fullDataCache || !currentMetricsToLoad.length) return;

    let filteredData = fullDataCache;

    if (timeFrame !== 'all') {
        const days = parseInt(timeFrame);
        const now = new Date();
        const cutoffDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);

        filteredData = fullDataCache.map(data => {
            const filteredDates = [];
            const filteredValues = [];

            data.dates.forEach((dateStr, idx) => {
                const date = new Date(dateStr);
                if (date >= cutoffDate) {
                    filteredDates.push(dateStr);
                    filteredValues.push(data.values[idx]);
                }
            });

            return {
                ...data,
                dates: filteredDates,
                values: filteredValues
            };
        });
    }

    renderChart(filteredData, currentMetricsToLoad);
}

function renderChart(dataArray, metricsToLoad) {
    const primaryData = dataArray[0];
    const primaryMetric = metricsToLoad[0];
    const unit = getMetricUnit(primaryMetric);

    if (currentChart) {
        currentChart.destroy();
    }

    const datasets = dataArray.map((data, idx) => {
        const color = metricColors[idx];
        return {
            label: data.column_name,
            data: data.values,
            borderColor: color,
            backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.1)'),
            borderWidth: 2,
            tension: 0.1,
            fill: idx === 0,
            yAxisID: 'y'
        };
    });

    const startDate = primaryData.dates[0];
    const endDate = primaryData.dates[primaryData.dates.length - 1];
    const recessionAnnotations = getRecessionAnnotations(startDate, endDate);

    const ctx = document.getElementById('explorerChart').getContext('2d');
    currentChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: primaryData.dates,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: true
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';

                            const val = context.parsed.y;
                            if (val !== null && val !== undefined) {
                                if (unit === '$') {
                                    label += '$' + val.toFixed(2);
                                } else {
                                    label += val.toFixed(2) + unit;
                                }
                            } else {
                                label += 'N/A';
                            }
                            return label;
                        }
                    }
                },
                annotation: {
                    annotations: recessionAnnotations
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'day',
                        displayFormats: {
                            day: 'MMM d'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: unit ? `Value (${unit})` : 'Value'
                    },
                    beginAtZero: false
                }
            }
        }
    });
}

function loadMetrics() {
    const primaryMetric = document.getElementById('metricSelector').value;
    if (!primaryMetric) return;

    const metricsToLoad = [primaryMetric];
    currentMetricsToLoad = metricsToLoad;

    // Load metric description
    fetch(`/api/metrics/description/${primaryMetric}`)
        .then(response => response.json())
        .then(description => {
            if (!description.error) {
                document.getElementById('info-what').textContent = description.what || 'No description available.';
                document.getElementById('info-why').textContent = description.why || 'No description available.';
                document.getElementById('info-watch').textContent = description.watch || 'No description available.';
            }
        })
        .catch(error => {
            console.error('Error loading metric description:', error);
        });

    // Load metric data
    Promise.all(metricsToLoad.map(metric =>
        fetch(`/api/metrics/${metric}`).then(r => r.json())
    ))
    .then(dataArray => {
        const primaryData = dataArray[0];
        fullDataCache = dataArray;

        // Show content
        document.getElementById('metricContent').classList.remove('hidden');

        // Update statistics
        const unit = getMetricUnit(primaryMetric);

        const formatValue = (val) => {
            if (val === null || val === undefined) return '--';
            if (unit === '$') {
                return `$${val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            } else {
                return val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + unit;
            }
        };

        const formatChange = (val) => {
            if (val === null || val === undefined) return '--';
            const formatted = unit === '$' ? `$${Math.abs(val).toFixed(2)}` : `${Math.abs(val).toFixed(2)}${unit}`;
            const sign = val >= 0 ? '+' : '-';
            const color = val >= 0 ? 'text-success' : 'text-danger';
            return `<span class="${color}">${sign}${formatted}</span>`;
        };

        // Update both mobile statistics and key stats panel
        document.getElementById('current-value').innerHTML = formatValue(primaryData.stats.current);
        document.getElementById('key-current-value').innerHTML = formatValue(primaryData.stats.current);

        document.getElementById('change-1d').innerHTML = formatChange(primaryData.stats.change_1d);
        document.getElementById('key-change-1d').innerHTML = formatChange(primaryData.stats.change_1d);

        document.getElementById('change-30d').innerHTML = formatChange(primaryData.stats.change_30d);
        document.getElementById('key-change-30d').innerHTML = formatChange(primaryData.stats.change_30d);

        document.getElementById('min-value').innerHTML = formatValue(primaryData.stats.min);
        document.getElementById('avg-value').innerHTML = formatValue(primaryData.stats.average);
        document.getElementById('key-avg-value').innerHTML = formatValue(primaryData.stats.average);

        document.getElementById('max-value').innerHTML = formatValue(primaryData.stats.max);
        document.getElementById('data-points').textContent = primaryData.values.length;
        document.getElementById('key-data-points').textContent = primaryData.values.length;

        // Find dates for min/max
        const minIdx = primaryData.values.indexOf(primaryData.stats.min);
        const maxIdx = primaryData.values.indexOf(primaryData.stats.max);
        if (minIdx >= 0) {
            document.getElementById('min-date').textContent = new Date(primaryData.dates[minIdx]).toLocaleDateString();
        }
        if (maxIdx >= 0) {
            document.getElementById('max-date').textContent = new Date(primaryData.dates[maxIdx]).toLocaleDateString();
        }

        // Update date range
        if (primaryData.dates.length > 0) {
            const firstDate = new Date(primaryData.dates[0]).toLocaleDateString();
            const lastDate = new Date(primaryData.dates[primaryData.dates.length - 1]).toLocaleDateString();
            document.getElementById('date-range').textContent = `${firstDate} - ${lastDate}`;
        }

        // Reset time frame to "All"
        document.querySelectorAll('.time-range-controls__button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector('.time-range-controls__button[data-timeframe="all"]').classList.add('active');

        // Render chart
        renderChart(dataArray, metricsToLoad);

        // Scroll to chart (smooth)
        document.querySelector('.chart-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
    })
    .catch(error => {
        console.error('Error loading metric data:', error);
        alert('Error loading metric data. Please try again.');
    });
}
</script>
{% endblock %}
