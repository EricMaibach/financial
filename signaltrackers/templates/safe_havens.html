{% extends "base.html" %}

{% block title %}Safe Havens - SignalTrackers{% endblock %}

{% block extra_css %}
<!-- Component Styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/chart-container.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/collapsible-section.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/key-stats-panel.css') }}">
<style>
/* Mobile-First Safe Havens Page Styles */
:root {
    /* Design system custom properties */
    --space-1: 0.25rem;
    --space-2: 0.5rem;
    --space-3: 0.75rem;
    --space-4: 1rem;
    --space-5: 1.5rem;
    --space-6: 2rem;
    --space-8: 3rem;
    --space-10: 4rem;

    --text-xs: 0.75rem;
    --text-sm: 0.875rem;
    --text-base: 1rem;
    --text-lg: 1.125rem;
    --text-xl: 1.25rem;
    --text-2xl: 1.5rem;
    --text-3xl: 1.875rem;

    --neutral-50: #f8f9fa;
    --neutral-100: #f1f3f5;
    --neutral-200: #dee2e6;
    --neutral-300: #ced4da;
    --neutral-500: #6c757d;
    --neutral-600: #495057;
    --neutral-700: #343a40;
    --neutral-800: #212529;

    --success-600: #198754;
    --brand-blue-500: #0d6efd;
    --warning-600: #ffc107;
    --info-600: #0dcaf0;
    --danger-600: #dc3545;

    --container-xl: 1280px;
}

/* Page header */
.safe-havens-header {
    padding: var(--space-4);
    background: white;
    border-bottom: 1px solid var(--neutral-200);
}

.safe-havens-header__title {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--neutral-800);
    margin: 0 0 var(--space-2) 0;
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.safe-havens-header__description {
    font-size: var(--text-sm);
    color: var(--neutral-600);
    margin: 0 0 var(--space-2) 0;
}

.safe-havens-header__updated {
    font-size: var(--text-sm);
    color: var(--neutral-500);
    margin: 0;
}

/* Content page */
.content-page {
    background: var(--neutral-50);
    min-height: calc(100vh - 64px);
}

/* Content grid (mobile: stacked, tablet+: side-by-side) */
.content-grid {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    padding: var(--space-4);
}

/* Time range controls */
.time-range-controls {
    display: flex;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    background: white;
    margin: 0 var(--space-4);
    border-radius: 8px;
    flex-wrap: wrap;
}

.time-range-controls__button {
    min-height: 44px;
    min-width: 60px;
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-sm);
    font-weight: 600;
    border: 1px solid var(--neutral-300);
    border-radius: 6px;
    background: white;
    color: var(--neutral-700);
    cursor: pointer;
    transition: all 150ms ease-out;
}

.time-range-controls__button:hover {
    background: var(--neutral-50);
    border-color: var(--warning-600);
}

.time-range-controls__button.active {
    background: var(--warning-600);
    color: white;
    border-color: var(--warning-600);
}

.time-range-controls__button:focus {
    outline: 2px solid var(--warning-600);
    outline-offset: 2px;
}

/* Statistics grid within collapsible section */
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
}

.stat-item {
    text-align: center;
    padding: var(--space-3);
    background: var(--neutral-50);
    border-radius: 8px;
}

.stat-item__label {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--neutral-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-2);
}

.stat-item__value {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--neutral-800);
    font-family: monospace;
}

.stat-item__value--large {
    font-size: var(--text-2xl);
}

.stat-item__secondary {
    font-size: var(--text-xs);
    color: var(--neutral-500);
    margin-top: var(--space-1);
}

/* Info cards */
.info-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-4);
}

.info-card {
    padding: var(--space-4);
    background: var(--neutral-50);
    border-radius: 8px;
    border-left: 4px solid var(--info-600);
}

.info-card__title {
    font-size: var(--text-base);
    font-weight: 600;
    color: var(--neutral-700);
    margin-bottom: var(--space-2);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.info-card__content {
    font-size: var(--text-sm);
    color: var(--neutral-600);
    line-height: 1.6;
}

.info-card__content ul {
    margin: 0;
    padding-left: var(--space-5);
}

.info-card__content li {
    margin-bottom: var(--space-2);
}

/* Tablet+ layouts */
@media (min-width: 768px) {
    .safe-havens-header {
        padding: var(--space-6);
    }

    .safe-havens-header__title {
        font-size: var(--text-3xl);
    }

    .content-grid {
        display: grid;
        grid-template-columns: 1.5fr 1fr; /* 60/40 split */
        gap: var(--space-6);
        padding: var(--space-6);
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .info-grid {
        grid-template-columns: 1fr 1fr;
    }
}

/* Desktop layouts */
@media (min-width: 1024px) {
    .content-grid {
        grid-template-columns: 2fr 1fr; /* 66/33 split */
        gap: var(--space-8);
        max-width: var(--container-xl);
        margin: 0 auto;
        padding: var(--space-8);
    }

    .stats-grid {
        grid-template-columns: 1fr 1fr;
    }

    .info-grid {
        grid-template-columns: 1fr 1fr 1fr;
    }
}

@media (min-width: 1280px) {
    .content-grid {
        gap: var(--space-10);
    }
}
</style>
{% endblock %}

{% from '_macros.html' import regime_annotation %}
{% block content %}
<main class="content-page">
    <!-- Page Header -->
    <header class="safe-havens-header">
        <h1 class="safe-havens-header__title">
            <i class="bi bi-shield-check text-warning"></i> Safe Havens & Precious Metals
        </h1>
        <p class="safe-havens-header__description">Key drivers and indicators for gold and silver</p>
        <p class="safe-havens-header__updated">Last Updated: <span id="last-updated-time">Loading...</span></p>
    </header>

    <!-- Compact Regime Strip -->
    {% set page_category = 'Safe Havens' %}
    {% include '_regime_strip.html' %}

    <!-- Content Grid: Stacked on mobile, side-by-side on tablet+ -->
    <div class="content-grid">
        <!-- Left Column: Chart (mobile: full width, tablet+: 60-66% width) -->
        <div>
            <!-- Chart Container (HERO ELEMENT on mobile) -->
            <div class="chart-container">
                <canvas id="gold-real-yields-chart"></canvas>
            </div>

            <!-- Time Range Controls (below chart) -->
            <div class="time-range-controls" id="gold-timeframe-buttons">
                <button type="button" class="time-range-controls__button" data-timeframe="90">3M</button>
                <button type="button" class="time-range-controls__button" data-timeframe="180">6M</button>
                <button type="button" class="time-range-controls__button active" data-timeframe="365">1Y</button>
                <button type="button" class="time-range-controls__button" data-timeframe="1825">5Y</button>
                <button type="button" class="time-range-controls__button" data-timeframe="3650">10Y</button>
                <button type="button" class="time-range-controls__button" data-timeframe="7300">20Y</button>
                <button type="button" class="time-range-controls__button" data-timeframe="0">All</button>
            </div>
        </div>

        <!-- Right Column: Key Stats Panel (hidden on mobile, visible tablet+) -->
        <aside class="key-stats-panel">
            <h3 class="key-stats-panel__title">Key Metrics</h3>

            <div class="stat-card stat-card--warning">
                <div class="stat-card__label">Gold Price</div>
                <div class="stat-card__value" id="key-gold-value">$--</div>
                <div class="stat-card__secondary" id="key-gold-change">--</div>
            </div>

            <div class="stat-card stat-card--danger">
                <div class="stat-card__label">Real Yield (10Y TIPS)</div>
                <div class="stat-card__value" id="key-real-yield-value">--%</div>
                <div class="stat-card__secondary" id="key-real-yield-status">--</div>
            </div>

            <div class="stat-card stat-card--info">
                <div class="stat-card__label">Breakeven Inflation</div>
                <div class="stat-card__value" id="key-breakeven-value">--%</div>
                <div class="stat-card__secondary">Expected inflation</div>
            </div>

            <div class="stat-card stat-card--success">
                <div class="stat-card__label">DXY</div>
                <div class="stat-card__value" id="key-dxy-value">--</div>
                <div class="stat-card__secondary" id="key-dxy-status">--</div>
            </div>

            <div class="stat-card stat-card--neutral">
                <div class="stat-card__label">Gold/Silver Ratio</div>
                <div class="stat-card__value" id="key-gold-silver-ratio">--</div>
                <div class="stat-card__secondary">Avg ~60</div>
            </div>
        </aside>
    </div>

    <!-- Collapsible Section: AI Briefing -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="ai-briefing">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-chat-square-text-fill"></i> AI Safe Haven Analysis</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div style="background: white; padding: var(--space-4); border-radius: 8px;">
                <p class="text-muted mb-0"><i class="bi bi-info-circle"></i> AI analysis coming soon. Use Explorer page for detailed gold analysis.</p>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: Market Statistics -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="market-stats">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title">Market Statistics</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-item__label">Gold Price</div>
                    <div class="stat-item__value stat-item__value--large" id="gold-price">$--</div>
                    <div class="stat-item__secondary">
                        <span id="gold-change-5d">--</span>% (5d) | <span id="gold-change-30d">--</span>% (30d)
                    </div>
                    <div class="stat-item__secondary" id="gold-status">Loading</div>
                    {{ regime_annotation('gold') }}
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">Silver Price</div>
                    <div class="stat-item__value" id="silver-price">$--</div>
                    <div class="stat-item__secondary">
                        <span id="silver-change-5d">--</span>% (5d) | <span id="silver-change-30d">--</span>% (30d)
                    </div>
                    <div class="stat-item__secondary" id="silver-status">Loading</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">Real Yield (10Y TIPS)</div>
                    <div class="stat-item__value" id="real-yield-value">--%</div>
                    <div class="stat-item__secondary">
                        <span id="real-yield-change">--</span> bps (30d)
                    </div>
                    <div class="stat-item__secondary" id="real-yield-status">Loading</div>
                    {{ regime_annotation('real_yield_10y') }}
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">Breakeven Inflation</div>
                    <div class="stat-item__value" id="breakeven-value">--%</div>
                    <div class="stat-item__secondary">
                        <span id="breakeven-change">--</span> bps (30d)
                    </div>
                    <div class="stat-item__secondary" id="breakeven-status">Loading</div>
                    {{ regime_annotation('breakeven_inflation_10y') }}
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">Dollar Index (DXY)</div>
                    <div class="stat-item__value" id="dxy-value">--</div>
                    <div class="stat-item__secondary">
                        <span id="dxy-change">--</span>% (30d)
                    </div>
                    <div class="stat-item__secondary" id="dxy-status">Loading</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">Gold/Silver Ratio</div>
                    <div class="stat-item__value" id="gold-silver-ratio">--</div>
                    <div class="stat-item__secondary">
                        <span id="gold-silver-change">--</span>% (30d)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: Additional Charts -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="additional-charts">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-graph-up"></i> Additional Charts</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div style="margin-bottom: var(--space-6);">
                <h4 style="margin: 0 0 var(--space-3) 0; font-size: var(--text-lg); font-weight: 600;">Gold vs Dollar Index (DXY)</h4>
                <div class="chart-container" style="height: 400px; margin: 0;">
                    <canvas id="gold-dxy-chart"></canvas>
                </div>
                <div class="time-range-controls" id="gold-dxy-timeframe-buttons">
                    <button type="button" class="time-range-controls__button" data-timeframe="90">3M</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="180">6M</button>
                    <button type="button" class="time-range-controls__button active" data-timeframe="365">1Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="1825">5Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="3650">10Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="7300">20Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="0">All</button>
                </div>
                <div style="margin-top: var(--space-3); font-size: var(--text-xs); color: var(--neutral-500);">
                    <i class="bi bi-info-circle"></i> Gold typically moves inversely to the dollar. Dollar strength creates headwinds for gold; dollar weakness is supportive.
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: Understanding Safe Havens -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="understanding-safe-havens">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-lightbulb-fill"></i> Understanding Gold's Key Drivers</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-card__title"><i class="bi bi-percent text-danger"></i> Real Yields (Most Important)</div>
                    <div class="info-card__content">
                        <p class="mb-0">Gold has a strong inverse correlation with real yields (TIPS yield). When real yields fall, gold's opportunity cost decreases - bullish. Rising real yields are a headwind for gold.</p>
                    </div>
                </div>
                <div class="info-card">
                    <div class="info-card__title"><i class="bi bi-graph-up-arrow text-warning"></i> Inflation Expectations</div>
                    <div class="info-card__content">
                        <p class="mb-0">Breakeven inflation reflects market's expected inflation over 10 years. Rising inflation expectations tend to support gold as an inflation hedge. Watch for divergences between nominal and real yields.</p>
                    </div>
                </div>
                <div class="info-card">
                    <div class="info-card__title"><i class="bi bi-currency-dollar text-success"></i> Dollar Strength</div>
                    <div class="info-card__content">
                        <p class="mb-0">Gold is priced in dollars globally, creating an inverse relationship. A weakening dollar makes gold cheaper for foreign buyers - bullish. Dollar strength is typically a headwind.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: Gold Analysis -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="gold-analysis">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-coin"></i> Gold Market Analysis</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-item__label">GDX/GLD Ratio</div>
                    <div class="stat-item__value" id="gdx-gld-ratio">--</div>
                    <div class="stat-item__secondary">
                        <span id="gdx-gld-change">--</span>% (30d)
                    </div>
                    <div class="stat-item__secondary">Miners vs gold</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">Gold Miners (GDX)</div>
                    <div class="stat-item__value" id="gdx-value">$--</div>
                    <div class="stat-item__secondary">
                        <span id="gdx-change">--</span>% (30d)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: Silver & Bonds -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="silver-bonds">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-gem"></i> Silver & Bonds</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-item__label">VIX (Fear Gauge)</div>
                    <div class="stat-item__value" id="vix-value">--</div>
                    <div class="stat-item__secondary">
                        <span id="vix-change">--</span>% (5d)
                    </div>
                    <div class="stat-item__secondary" id="vix-status">Loading</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">10Y Treasury (Nominal)</div>
                    <div class="stat-item__value" id="treasury-10y-value">--%</div>
                    <div class="stat-item__secondary">
                        <span id="treasury-10y-change">--</span> bps (30d)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: Historical Context -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="historical-context">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-clock-history"></i> Historical Context</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-card__title">Real Yield Framework</div>
                    <div class="info-card__content">
                        <p class="mb-0">Real yields above 2% historically create significant headwinds for gold. Near-zero or negative real yields are very bullish. The 2020-2022 gold rally coincided with deeply negative real yields.</p>
                    </div>
                </div>
                <div class="info-card">
                    <div class="info-card__title">Gold/Silver Ratio</div>
                    <div class="info-card__content">
                        <p class="mb-0">Historical average ~60. Ratios above 80 indicate silver is historically cheap vs gold (often at market stress peaks). Below 50 suggests silver is relatively expensive.</p>
                    </div>
                </div>
                <div class="info-card">
                    <div class="info-card__title">Central Bank Demand</div>
                    <div class="info-card__content">
                        <p class="mb-0">Since 2022, central banks have been net buyers at multi-decade highs. De-dollarization trend provides structural support. China, Russia, India leading buyers.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: Bullish Signals -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="bullish-signals">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-arrow-up-circle"></i> Bullish Signals for Gold</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div class="info-card" style="border-left-color: var(--success-600);">
                <div class="info-card__content">
                    <ul class="mb-0">
                        <li><strong>Real yields falling</strong> - Lower opportunity cost for holding gold</li>
                        <li><strong>Breakeven inflation rising</strong> - Inflation hedge demand increases</li>
                        <li><strong>Dollar weakening (DXY down)</strong> - Gold becomes cheaper globally</li>
                        <li><strong>GDX/GLD ratio rising</strong> - Miners outperforming gold = bullish confirmation</li>
                        <li><strong>Gold/Silver ratio falling</strong> - Risk-on sentiment in metals</li>
                        <li><strong>Central bank buying</strong> - De-dollarization trend</li>
                        <li><strong>Negative real yields</strong> - Cash is guaranteed to lose purchasing power</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: Bearish Signals -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="bearish-signals">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-arrow-down-circle"></i> Bearish Signals for Gold</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div class="info-card" style="border-left-color: var(--danger-600);">
                <div class="info-card__content">
                    <ul class="mb-0">
                        <li><strong>Real yields rising sharply</strong> - Higher opportunity cost, bonds more attractive</li>
                        <li><strong>Breakeven inflation falling</strong> - Deflation fears reduce inflation hedge demand</li>
                        <li><strong>Dollar strengthening (DXY up)</strong> - Flight to safety often hurts gold short-term</li>
                        <li><strong>GDX/GLD ratio falling</strong> - Miners underperforming = negative divergence</li>
                        <li><strong>Gold/Silver ratio spiking (>80)</strong> - Extreme fear, but silver historically cheap</li>
                        <li><strong>Fed hawkish pivot</strong> - Higher rates ahead = real yield risk</li>
                        <li><strong>Risk-on rally</strong> - Capital flows to equities instead</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

</main>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
let recessionData = [];
let goldRealYieldsChart = null;
let goldDxyChart = null;
let fullGoldData = null;
let fullRealYieldData = null;
let fullDxyData = null;
let currentGoldTimeframe = 365;
let currentGoldDxyTimeframe = 365;

// Fetch recession data on load
fetch('/api/recessions')
    .then(response => response.json())
    .then(data => {
        recessionData = data;
        if (fullGoldData) {
            buildGoldRealYieldsChart();
            buildGoldDxyChart();
        }
    })
    .catch(error => {
        console.error('Error loading recession data:', error);
    });

// Generate recession annotations for chart
function getRecessionAnnotations(startDate, endDate) {
    if (!recessionData || recessionData.length === 0) return {};

    const chartStart = new Date(startDate);
    const chartEnd = new Date(endDate);
    const annotations = {};

    recessionData.forEach((recession, idx) => {
        const recStart = new Date(recession.start_date);
        const recEnd = new Date(recession.end_date);

        if (recEnd >= chartStart && recStart <= chartEnd) {
            const displayStart = recStart < chartStart ? chartStart : recStart;
            const displayEnd = recEnd > chartEnd ? chartEnd : recEnd;

            annotations[`recession_${idx}`] = {
                type: 'box',
                xMin: displayStart.toISOString().split('T')[0],
                xMax: displayEnd.toISOString().split('T')[0],
                backgroundColor: 'rgba(128, 128, 128, 0.15)',
                borderWidth: 0,
                label: { display: false }
            };
        }
    });

    return annotations;
}

// Filter data by timeframe
function filterByTimeframe(dates, values, days) {
    if (days === 0) return { dates, values };

    const now = new Date();
    const cutoffDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);

    const filteredDates = [];
    const filteredValues = [];

    dates.forEach((dateStr, idx) => {
        const date = new Date(dateStr);
        if (date >= cutoffDate) {
            filteredDates.push(dateStr);
            filteredValues.push(values[idx]);
        }
    });

    return { dates: filteredDates, values: filteredValues };
}

// Align datasets by date
function alignDataByDate(primaryDates, secondaryDates, secondaryValues) {
    const dateMap = new Map();
    secondaryDates.forEach((date, i) => {
        dateMap.set(date, secondaryValues[i]);
    });

    return primaryDates.map(date => dateMap.has(date) ? dateMap.get(date) : null);
}

// Determine time unit based on date range
function getTimeUnit(startDate, endDate) {
    const dateRange = new Date(endDate) - new Date(startDate);
    const dayRange = dateRange / (1000 * 60 * 60 * 24);
    if (dayRange <= 90) return 'day';
    if (dayRange <= 365) return 'week';
    if (dayRange <= 1825) return 'month';
    return 'year';
}

// Load all metrics data
async function loadSafeHavensData() {
    try {
        // Load Gold data
        const goldResponse = await fetch('/api/metrics/gold_price');
        const goldData = await goldResponse.json();

        if (goldData && goldData.values) {
            const currentGold = goldData.values[goldData.values.length - 1] * 10;
            document.getElementById('gold-price').textContent = `$${Math.round(currentGold).toLocaleString()}`;
            document.getElementById('key-gold-value').textContent = `$${Math.round(currentGold).toLocaleString()}`;

            if (goldData.values.length > 5) {
                const change5d = ((goldData.values[goldData.values.length - 1] / goldData.values[goldData.values.length - 6]) - 1) * 100;
                document.getElementById('gold-change-5d').textContent = (change5d >= 0 ? '+' : '') + change5d.toFixed(1);
            }
            if (goldData.values.length > 30) {
                const change30d = ((goldData.values[goldData.values.length - 1] / goldData.values[goldData.values.length - 31]) - 1) * 100;
                document.getElementById('gold-change-30d').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(1);
                document.getElementById('key-gold-change').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(1) + '% (30d)';

                const statusEl = document.getElementById('gold-status');
                if (change30d > 5) {
                    statusEl.textContent = 'BULLISH';
                } else if (change30d < -5) {
                    statusEl.textContent = 'BEARISH';
                } else {
                    statusEl.textContent = 'NEUTRAL';
                }
            }

            fullGoldData = goldData;
        }

        // Load Silver data
        const silverResponse = await fetch('/api/metrics/silver_price');
        const silverData = await silverResponse.json();

        if (silverData && silverData.values && silverData.values.length > 0) {
            const currentSilver = silverData.values[silverData.values.length - 1];
            document.getElementById('silver-price').textContent = `$${currentSilver.toFixed(2)}`;

            if (silverData.values.length > 5) {
                const change5d = ((currentSilver / silverData.values[silverData.values.length - 6]) - 1) * 100;
                document.getElementById('silver-change-5d').textContent = (change5d >= 0 ? '+' : '') + change5d.toFixed(1);
            }
            if (silverData.values.length > 30) {
                const change30d = ((currentSilver / silverData.values[silverData.values.length - 31]) - 1) * 100;
                document.getElementById('silver-change-30d').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(1);

                const statusEl = document.getElementById('silver-status');
                if (change30d > 5) {
                    statusEl.textContent = 'BULLISH';
                } else if (change30d < -5) {
                    statusEl.textContent = 'BEARISH';
                } else {
                    statusEl.textContent = 'NEUTRAL';
                }
            }
        }

        // Load Gold/Silver Ratio
        const gsRatioResponse = await fetch('/api/metrics/gold_silver_ratio');
        const gsRatioData = await gsRatioResponse.json();

        if (gsRatioData && gsRatioData.values && gsRatioData.values.length > 0) {
            const currentRatio = gsRatioData.values[gsRatioData.values.length - 1];
            document.getElementById('gold-silver-ratio').textContent = currentRatio.toFixed(1);
            document.getElementById('key-gold-silver-ratio').textContent = currentRatio.toFixed(1);

            if (gsRatioData.values.length > 30) {
                const change30d = ((currentRatio / gsRatioData.values[gsRatioData.values.length - 31]) - 1) * 100;
                document.getElementById('gold-silver-change').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(1);
            }
        }

        // Load GDX/GLD Ratio
        const gdxGldResponse = await fetch('/api/metrics/gdx_gld_ratio');
        const gdxGldData = await gdxGldResponse.json();

        if (gdxGldData && gdxGldData.values && gdxGldData.values.length > 0) {
            const currentGdxGld = gdxGldData.values[gdxGldData.values.length - 1];
            document.getElementById('gdx-gld-ratio').textContent = currentGdxGld.toFixed(2);

            if (gdxGldData.values.length > 30) {
                const change30d = ((currentGdxGld / gdxGldData.values[gdxGldData.values.length - 31]) - 1) * 100;
                document.getElementById('gdx-gld-change').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(1);
            }
        }

        // Load Real Yield
        const realYieldResponse = await fetch('/api/metrics/real_yield_10y');
        const realYieldData = await realYieldResponse.json();

        if (realYieldData && realYieldData.values && realYieldData.values.length > 0) {
            const currentRealYield = realYieldData.values[realYieldData.values.length - 1];
            document.getElementById('real-yield-value').textContent = currentRealYield.toFixed(2) + '%';
            document.getElementById('key-real-yield-value').textContent = currentRealYield.toFixed(2) + '%';

            if (realYieldData.values.length > 30) {
                const change30d = (currentRealYield - realYieldData.values[realYieldData.values.length - 31]) * 100;
                document.getElementById('real-yield-change').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(0);

                const statusEl = document.getElementById('real-yield-status');
                const keyStatusEl = document.getElementById('key-real-yield-status');
                let status;
                if (currentRealYield < 0) {
                    status = 'NEGATIVE (BULLISH)';
                } else if (currentRealYield < 1) {
                    status = 'LOW';
                } else if (currentRealYield < 2) {
                    status = 'MODERATE';
                } else {
                    status = 'HIGH (BEARISH)';
                }
                statusEl.textContent = status;
                keyStatusEl.textContent = status;
            }

            fullRealYieldData = realYieldData;
        }

        // Load Breakeven Inflation
        const breakevenResponse = await fetch('/api/metrics/breakeven_inflation_10y');
        const breakevenData = await breakevenResponse.json();

        if (breakevenData && breakevenData.values && breakevenData.values.length > 0) {
            const currentBreakeven = breakevenData.values[breakevenData.values.length - 1];
            document.getElementById('breakeven-value').textContent = currentBreakeven.toFixed(2) + '%';
            document.getElementById('key-breakeven-value').textContent = currentBreakeven.toFixed(2) + '%';

            if (breakevenData.values.length > 30) {
                const change30d = (currentBreakeven - breakevenData.values[breakevenData.values.length - 31]) * 100;
                document.getElementById('breakeven-change').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(0);

                const statusEl = document.getElementById('breakeven-status');
                if (currentBreakeven > 2.5) {
                    statusEl.textContent = 'ELEVATED';
                } else if (currentBreakeven > 2) {
                    statusEl.textContent = 'ABOVE TARGET';
                } else if (currentBreakeven > 1.5) {
                    statusEl.textContent = 'ANCHORED';
                } else {
                    statusEl.textContent = 'LOW';
                }
            }
        }

        // Load DXY
        const dxyResponse = await fetch('/api/metrics/dollar_index_price');
        const dxyData = await dxyResponse.json();

        if (dxyData && dxyData.values && dxyData.values.length > 0) {
            const currentDXY = dxyData.values[dxyData.values.length - 1];
            document.getElementById('dxy-value').textContent = currentDXY.toFixed(2);
            document.getElementById('key-dxy-value').textContent = currentDXY.toFixed(2);

            if (dxyData.values.length > 30) {
                const change30d = ((currentDXY / dxyData.values[dxyData.values.length - 31]) - 1) * 100;
                document.getElementById('dxy-change').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(1);

                const statusEl = document.getElementById('dxy-status');
                const keyStatusEl = document.getElementById('key-dxy-status');
                let status;
                if (change30d > 2) {
                    status = 'STRENGTHENING';
                } else if (change30d < -2) {
                    status = 'WEAKENING';
                } else {
                    status = 'STABLE';
                }
                statusEl.textContent = status;
                keyStatusEl.textContent = status;
            }

            fullDxyData = dxyData;
        }

        // Load 10Y Treasury
        const treasuryResponse = await fetch('/api/metrics/treasury_10y');
        const treasuryData = await treasuryResponse.json();

        if (treasuryData && treasuryData.values && treasuryData.values.length > 0) {
            const currentTreasury = treasuryData.values[treasuryData.values.length - 1];
            document.getElementById('treasury-10y-value').textContent = currentTreasury.toFixed(2) + '%';

            if (treasuryData.values.length > 30) {
                const change30d = (currentTreasury - treasuryData.values[treasuryData.values.length - 31]) * 100;
                document.getElementById('treasury-10y-change').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(0);
            }
        }

        // Load GDX
        const gdxResponse = await fetch('/api/metrics/gold_miners_price');
        const gdxData = await gdxResponse.json();

        if (gdxData && gdxData.values && gdxData.values.length > 0) {
            const currentGDX = gdxData.values[gdxData.values.length - 1];
            document.getElementById('gdx-value').textContent = `$${currentGDX.toFixed(2)}`;

            if (gdxData.values.length > 30) {
                const change30d = ((currentGDX / gdxData.values[gdxData.values.length - 31]) - 1) * 100;
                document.getElementById('gdx-change').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(1);
            }
        }

        // Load VIX
        const vixResponse = await fetch('/api/metrics/vix_price');
        const vixData = await vixResponse.json();

        if (vixData && vixData.values && vixData.values.length > 0) {
            const currentVIX = vixData.values[vixData.values.length - 1];
            document.getElementById('vix-value').textContent = currentVIX.toFixed(1);

            if (vixData.values.length > 5) {
                const change5d = ((currentVIX / vixData.values[vixData.values.length - 6]) - 1) * 100;
                document.getElementById('vix-change').textContent = (change5d >= 0 ? '+' : '') + change5d.toFixed(1);
            }

            const statusEl = document.getElementById('vix-status');
            if (currentVIX > 30) {
                statusEl.textContent = 'HIGH FEAR';
            } else if (currentVIX > 20) {
                statusEl.textContent = 'ELEVATED';
            } else {
                statusEl.textContent = 'LOW';
            }
        }

        // Build charts
        buildGoldRealYieldsChart();
        buildGoldDxyChart();

        // Update last updated time
        const now = new Date();
        document.getElementById('last-updated-time').textContent = now.toLocaleString();

    } catch (error) {
        console.error('Error loading safe havens data:', error);
    }
}

function buildGoldRealYieldsChart() {
    if (!fullGoldData || !fullRealYieldData) return;

    const goldFiltered = filterByTimeframe(fullGoldData.dates, fullGoldData.values, currentGoldTimeframe);
    if (goldFiltered.dates.length === 0) return;

    const goldScaled = goldFiltered.values.map(v => v * 10);
    const realYieldAligned = alignDataByDate(goldFiltered.dates, fullRealYieldData.dates, fullRealYieldData.values);

    const startDate = goldFiltered.dates[0];
    const endDate = goldFiltered.dates[goldFiltered.dates.length - 1];
    const recessionAnnotations = getRecessionAnnotations(startDate, endDate);
    const timeUnit = getTimeUnit(startDate, endDate);

    if (goldRealYieldsChart) goldRealYieldsChart.destroy();

    const ctx = document.getElementById('gold-real-yields-chart').getContext('2d');
    goldRealYieldsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: goldFiltered.dates,
            datasets: [
                {
                    label: 'Gold Price ($)',
                    data: goldScaled,
                    borderColor: 'rgb(255, 193, 7)',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    yAxisID: 'y',
                    pointRadius: 0,
                    tension: 0.1
                },
                {
                    label: '10Y Real Yield (%)',
                    data: realYieldAligned,
                    borderColor: 'rgb(220, 53, 69)',
                    borderWidth: 2,
                    fill: false,
                    yAxisID: 'y1',
                    pointRadius: 0,
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                annotation: { annotations: recessionAnnotations }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: timeUnit, displayFormats: { day: 'MMM d', week: 'MMM d', month: 'MMM yyyy', year: 'yyyy' } }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'Gold ($)' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    reverse: true,
                    title: { display: true, text: '10Y Real Yield (%, inverted)' },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
}

function buildGoldDxyChart() {
    if (!fullGoldData || !fullDxyData) return;

    const goldFiltered = filterByTimeframe(fullGoldData.dates, fullGoldData.values, currentGoldDxyTimeframe);
    if (goldFiltered.dates.length === 0) return;

    const goldScaled = goldFiltered.values.map(v => v * 10);
    const dxyAligned = alignDataByDate(goldFiltered.dates, fullDxyData.dates, fullDxyData.values);

    const startDate = goldFiltered.dates[0];
    const endDate = goldFiltered.dates[goldFiltered.dates.length - 1];
    const recessionAnnotations = getRecessionAnnotations(startDate, endDate);
    const timeUnit = getTimeUnit(startDate, endDate);

    if (goldDxyChart) goldDxyChart.destroy();

    const ctx = document.getElementById('gold-dxy-chart').getContext('2d');
    goldDxyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: goldFiltered.dates,
            datasets: [
                {
                    label: 'Gold Price ($)',
                    data: goldScaled,
                    borderColor: 'rgb(255, 193, 7)',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    yAxisID: 'y',
                    pointRadius: 0,
                    tension: 0.1
                },
                {
                    label: 'Dollar Index (DXY)',
                    data: dxyAligned,
                    borderColor: 'rgb(25, 135, 84)',
                    borderWidth: 2,
                    fill: false,
                    yAxisID: 'y1',
                    pointRadius: 0,
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                annotation: { annotations: recessionAnnotations }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: timeUnit, displayFormats: { day: 'MMM d', week: 'MMM d', month: 'MMM yyyy', year: 'yyyy' } }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'Gold ($)' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: { display: true, text: 'Dollar Index (DXY)' },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
}

// Initialize collapsible sections
function initCollapsibleSections() {
    const sections = document.querySelectorAll('.collapsible-section');

    sections.forEach(section => {
        const header = section.querySelector('.collapsible-section__header');
        const content = section.querySelector('.collapsible-section__content');

        header.addEventListener('click', () => {
            const isExpanded = header.getAttribute('aria-expanded') === 'true';

            header.setAttribute('aria-expanded', !isExpanded);
            content.hidden = isExpanded;
        });

        header.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                header.click();
            }
        });
    });
}

// Initialize time range controls
function initTimeRangeControls() {
    // Gold real yields chart
    document.querySelectorAll('#gold-timeframe-buttons button[data-timeframe]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('#gold-timeframe-buttons button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            currentGoldTimeframe = parseInt(this.getAttribute('data-timeframe'));
            buildGoldRealYieldsChart();
        });
    });

    // Gold vs DXY chart
    document.querySelectorAll('#gold-dxy-timeframe-buttons button[data-timeframe]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('#gold-dxy-timeframe-buttons button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            currentGoldDxyTimeframe = parseInt(this.getAttribute('data-timeframe'));
            buildGoldDxyChart();
        });
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSafeHavensData();
    initCollapsibleSections();
    initTimeRangeControls();
});
</script>
{% endblock %}
