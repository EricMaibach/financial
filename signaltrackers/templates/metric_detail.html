{% extends "base.html" %}

{% block title %}{{ metric_title }} - Market Divergence Dashboard{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ metric_title }}</li>
                </ol>
            </nav>
            <h1 class="display-4 mb-3">{{ metric_title }}</h1>
        </div>
    </div>

    <!-- Metric Info Panel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle-fill"></i> About This Metric
                    </h5>
                    <button class="btn btn-sm btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#infoCollapse" aria-expanded="true" aria-controls="infoCollapse">
                        <i class="bi bi-chevron-down" id="collapseIcon"></i>
                    </button>
                </div>
                <div class="collapse show" id="infoCollapse">
                    <hr>
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="text-primary"><i class="bi bi-question-circle"></i> What It Is</h6>
                            <p id="info-what">Loading...</p>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-success"><i class="bi bi-lightbulb"></i> Why It Matters</h6>
                            <p id="info-why">Loading...</p>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-warning"><i class="bi bi-eye"></i> What To Watch</h6>
                            <p id="info-watch">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Statistics -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="text-muted">CURRENT VALUE</h6>
                    <h2 class="mb-0" id="current-value">--</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="text-muted">1-DAY CHANGE</h6>
                    <h2 class="mb-0" id="change-1d">--</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="text-muted">30-DAY CHANGE</h6>
                    <h2 class="mb-0" id="change-30d">--</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="text-muted">DATE RANGE</h6>
                    <h6 class="mb-0" id="date-range">--</h6>
                </div>
            </div>
        </div>
    </div>

    <!-- Min/Max/Avg Row -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="text-muted">MINIMUM</h6>
                    <h4 class="mb-0 text-success" id="min-value">--</h4>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="text-muted">AVERAGE</h6>
                    <h4 class="mb-0 text-info" id="avg-value">--</h4>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="text-muted">MAXIMUM</h6>
                    <h4 class="mb-0 text-danger" id="max-value">--</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Time Frame Selector -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center justify-content-between flex-wrap">
                        <small class="text-muted me-3"><i class="bi bi-calendar-range"></i> Time Frame:</small>
                        <div class="btn-group btn-group-sm" role="group" id="timeFrameSelector">
                            <button type="button" class="btn btn-outline-secondary" data-timeframe="7">1W</button>
                            <button type="button" class="btn btn-outline-secondary" data-timeframe="30">1M</button>
                            <button type="button" class="btn btn-outline-secondary" data-timeframe="90">3M</button>
                            <button type="button" class="btn btn-outline-secondary" data-timeframe="180">6M</button>
                            <button type="button" class="btn btn-outline-secondary" data-timeframe="365">1Y</button>
                            <button type="button" class="btn btn-outline-secondary" data-timeframe="1825">5Y</button>
                            <button type="button" class="btn btn-outline-secondary" data-timeframe="3650">10Y</button>
                            <button type="button" class="btn btn-outline-secondary" data-timeframe="5475">15Y</button>
                            <button type="button" class="btn btn-outline-secondary" data-timeframe="7300">20Y</button>
                            <button type="button" class="btn btn-outline-secondary" data-timeframe="9125">25Y</button>
                            <button type="button" class="btn btn-outline-secondary" data-timeframe="10950">30Y</button>
                            <button type="button" class="btn btn-outline-secondary active" data-timeframe="all">All</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Historical Trend</h5>
                </div>
                <div class="card-body">
                    <canvas id="metricChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const metricName = "{{ metric_name }}";
const metricFile = "{{ metric_file }}";
const metricUnit = "{{ metric_unit }}";

let currentChart = null;
let fullDataCache = null; // Store full unfiltered data for time frame filtering
let recessionData = []; // Store recession periods for shading

// Fetch recession data on load
fetch('/api/recessions')
    .then(response => response.json())
    .then(data => {
        recessionData = data;
    })
    .catch(error => {
        console.error('Error loading recession data:', error);
    });

// Generate recession annotations for chart
function getRecessionAnnotations(startDate, endDate) {
    if (!recessionData || recessionData.length === 0) return {};

    const chartStart = new Date(startDate);
    const chartEnd = new Date(endDate);
    const annotations = {};

    recessionData.forEach((recession, idx) => {
        const recStart = new Date(recession.start_date);
        const recEnd = new Date(recession.end_date);

        // Check if recession overlaps with chart date range
        if (recEnd >= chartStart && recStart <= chartEnd) {
            // Clamp to chart boundaries
            const displayStart = recStart < chartStart ? chartStart : recStart;
            const displayEnd = recEnd > chartEnd ? chartEnd : recEnd;

            annotations[`recession_${idx}`] = {
                type: 'box',
                xMin: displayStart.toISOString().split('T')[0],
                xMax: displayEnd.toISOString().split('T')[0],
                backgroundColor: 'rgba(128, 128, 128, 0.15)',
                borderWidth: 0,
                label: {
                    display: false
                }
            };
        }
    });

    return annotations;
}

// Toggle collapse icon
document.getElementById('infoCollapse')?.addEventListener('shown.bs.collapse', function() {
    document.getElementById('collapseIcon').className = 'bi bi-chevron-up';
});
document.getElementById('infoCollapse')?.addEventListener('hidden.bs.collapse', function() {
    document.getElementById('collapseIcon').className = 'bi bi-chevron-down';
});

// Time frame selector button handlers
document.querySelectorAll('#timeFrameSelector button[data-timeframe]').forEach(button => {
    button.addEventListener('click', function() {
        // Update active button
        document.querySelectorAll('#timeFrameSelector button').forEach(btn => {
            btn.classList.remove('active');
        });
        this.classList.add('active');

        // Apply time frame filter
        const timeFrame = this.getAttribute('data-timeframe');
        applyTimeFrameFilter(timeFrame);
    });
});

function applyTimeFrameFilter(timeFrame) {
    if (!fullDataCache) return;

    // Filter data based on time frame
    let filteredData = fullDataCache;

    if (timeFrame !== 'all') {
        const days = parseInt(timeFrame);
        const now = new Date();
        const cutoffDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);

        const filteredDates = [];
        const filteredValues = [];

        fullDataCache.dates.forEach((dateStr, idx) => {
            const date = new Date(dateStr);
            if (date >= cutoffDate) {
                filteredDates.push(dateStr);
                filteredValues.push(fullDataCache.values[idx]);
            }
        });

        filteredData = {
            ...fullDataCache,
            dates: filteredDates,
            values: filteredValues
        };
    }

    // Update date range display
    if (filteredData.dates.length > 0) {
        const firstDate = new Date(filteredData.dates[0]).toLocaleDateString();
        const lastDate = new Date(filteredData.dates[filteredData.dates.length - 1]).toLocaleDateString();
        document.getElementById('date-range').textContent = `${firstDate} - ${lastDate}`;
    }

    // Render the chart with filtered data
    renderChart(filteredData);
}

function renderChart(data) {
    const ctx = document.getElementById('metricChart').getContext('2d');

    // Destroy existing chart if it exists
    if (currentChart) {
        currentChart.destroy();
    }

    // Get recession annotations for the current date range
    const startDate = data.dates[0];
    const endDate = data.dates[data.dates.length - 1];
    const recessionAnnotations = getRecessionAnnotations(startDate, endDate);

    currentChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [{
                label: data.column_name,
                data: data.values,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                borderWidth: 2,
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: true
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            const val = context.parsed.y;
                            if (metricUnit === '$') {
                                label += '$' + val.toFixed(2);
                            } else if (metricUnit === 'bp') {
                                label += val.toFixed(2) + ' bp';
                            } else {
                                label += val.toFixed(2);
                            }
                            return label;
                        }
                    }
                },
                annotation: {
                    annotations: recessionAnnotations
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'day',
                        displayFormats: {
                            day: 'MMM d'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: metricUnit ? `Value (${metricUnit})` : 'Value'
                    },
                    beginAtZero: false
                }
            }
        }
    });
}

// Fetch metric description
fetch(`/api/metrics/description/${metricFile}`)
    .then(response => response.json())
    .then(description => {
        if (!description.error) {
            document.getElementById('info-what').textContent = description.what || 'No description available.';
            document.getElementById('info-why').textContent = description.why || 'No description available.';
            document.getElementById('info-watch').textContent = description.watch || 'No description available.';
        }
    })
    .catch(error => {
        console.error('Error loading metric description:', error);
        document.getElementById('info-what').textContent = 'Description not available.';
        document.getElementById('info-why').textContent = 'Description not available.';
        document.getElementById('info-watch').textContent = 'Description not available.';
    });

// Fetch metric data
fetch(`/api/metrics/${metricFile}`)
    .then(response => response.json())
    .then(data => {
        // Cache the full data for time frame filtering
        fullDataCache = data;

        // Update statistics
        const formatValue = (val) => {
            if (val === null || val === undefined) return '--';
            if (metricUnit === '$') {
                return `$${val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            } else if (metricUnit === 'bp') {
                return `${val.toFixed(2)} bp`;
            } else {
                return val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }
        };

        const formatChange = (val) => {
            if (val === null || val === undefined) return '--';
            const formatted = metricUnit === '$' ? `$${Math.abs(val).toFixed(2)}` : `${Math.abs(val).toFixed(2)}`;
            const sign = val >= 0 ? '+' : '-';
            const color = val >= 0 ? 'text-success' : 'text-danger';
            return `<span class="${color}">${sign}${formatted}</span>`;
        };

        document.getElementById('current-value').innerHTML = formatValue(data.stats.current);
        document.getElementById('change-1d').innerHTML = formatChange(data.stats.change_1d);
        document.getElementById('change-30d').innerHTML = formatChange(data.stats.change_30d);
        document.getElementById('min-value').innerHTML = formatValue(data.stats.min);
        document.getElementById('avg-value').innerHTML = formatValue(data.stats.average);
        document.getElementById('max-value').innerHTML = formatValue(data.stats.max);

        if (data.dates.length > 0) {
            const firstDate = new Date(data.dates[0]).toLocaleDateString();
            const lastDate = new Date(data.dates[data.dates.length - 1]).toLocaleDateString();
            document.getElementById('date-range').textContent = `${firstDate} - ${lastDate}`;
        }

        // Render initial chart with all data
        renderChart(data);
    })
    .catch(error => {
        console.error('Error loading metric data:', error);
        document.getElementById('current-value').textContent = 'Error loading data';
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
{% endblock %}
