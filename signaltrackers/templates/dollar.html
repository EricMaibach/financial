{% extends "base.html" %}

{% block title %}Dollar & Currency - SignalTrackers{% endblock %}

{% block extra_css %}
<!-- Component Styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/chart-container.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/collapsible-section.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/key-stats-panel.css') }}">
<style>
/* Mobile-First Dollar Page Styles */
:root {
    /* Design system custom properties */
    --space-1: 0.25rem;
    --space-2: 0.5rem;
    --space-3: 0.75rem;
    --space-4: 1rem;
    --space-5: 1.5rem;
    --space-6: 2rem;
    --space-8: 3rem;
    --space-10: 4rem;

    --text-xs: 0.75rem;
    --text-sm: 0.875rem;
    --text-base: 1rem;
    --text-lg: 1.125rem;
    --text-xl: 1.25rem;
    --text-2xl: 1.5rem;
    --text-3xl: 1.875rem;

    --neutral-50: #f8f9fa;
    --neutral-100: #f1f3f5;
    --neutral-200: #dee2e6;
    --neutral-300: #ced4da;
    --neutral-500: #6c757d;
    --neutral-600: #495057;
    --neutral-700: #343a40;
    --neutral-800: #212529;

    --success-600: #198754;
    --brand-blue-500: #0d6efd;
    --warning-600: #ffc107;
    --info-600: #0dcaf0;
    --danger-600: #dc3545;

    --container-xl: 1280px;
}

/* Page header */
.dollar-header {
    padding: var(--space-4);
    background: white;
    border-bottom: 1px solid var(--neutral-200);
}

.dollar-header__title {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--neutral-800);
    margin: 0 0 var(--space-2) 0;
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.dollar-header__description {
    font-size: var(--text-sm);
    color: var(--neutral-600);
    margin: 0 0 var(--space-2) 0;
}

.dollar-header__updated {
    font-size: var(--text-sm);
    color: var(--neutral-500);
    margin: 0;
}

/* Content page */
.content-page {
    background: var(--neutral-50);
    min-height: calc(100vh - 64px);
}

/* Content grid (mobile: stacked, tablet+: side-by-side) */
.content-grid {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    padding: var(--space-4);
}

/* Time range controls */
.time-range-controls {
    display: flex;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    background: white;
    margin: 0 var(--space-4);
    border-radius: 8px;
    flex-wrap: wrap;
}

.time-range-controls__button {
    min-height: 44px;
    min-width: 60px;
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-sm);
    font-weight: 600;
    border: 1px solid var(--neutral-300);
    border-radius: 6px;
    background: white;
    color: var(--neutral-700);
    cursor: pointer;
    transition: all 150ms ease-out;
}

.time-range-controls__button:hover {
    background: var(--neutral-50);
    border-color: var(--success-600);
}

.time-range-controls__button.active {
    background: var(--success-600);
    color: white;
    border-color: var(--success-600);
}

.time-range-controls__button:focus {
    outline: 2px solid var(--success-600);
    outline-offset: 2px;
}

/* Statistics grid within collapsible section */
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
}

.stat-item {
    text-align: center;
    padding: var(--space-3);
    background: var(--neutral-50);
    border-radius: 8px;
}

.stat-item__label {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--neutral-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-2);
}

.stat-item__value {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--neutral-800);
    font-family: monospace;
}

.stat-item__value--large {
    font-size: var(--text-2xl);
}

.stat-item__secondary {
    font-size: var(--text-xs);
    color: var(--neutral-500);
    margin-top: var(--space-1);
}

/* Info cards */
.info-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-4);
}

.info-card {
    padding: var(--space-4);
    background: var(--neutral-50);
    border-radius: 8px;
    border-left: 4px solid var(--info-600);
}

.info-card__title {
    font-size: var(--text-base);
    font-weight: 600;
    color: var(--neutral-700);
    margin-bottom: var(--space-2);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.info-card__content {
    font-size: var(--text-sm);
    color: var(--neutral-600);
    line-height: 1.6;
}

.info-card__content ul {
    margin: 0;
    padding-left: var(--space-5);
}

.info-card__content li {
    margin-bottom: var(--space-2);
}

/* Tablet+ layouts */
@media (min-width: 768px) {
    .dollar-header {
        padding: var(--space-6);
    }

    .dollar-header__title {
        font-size: var(--text-3xl);
    }

    .content-grid {
        display: grid;
        grid-template-columns: 1.5fr 1fr; /* 60/40 split */
        gap: var(--space-6);
        padding: var(--space-6);
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .info-grid {
        grid-template-columns: 1fr 1fr;
    }
}

/* Desktop layouts */
@media (min-width: 1024px) {
    .content-grid {
        grid-template-columns: 2fr 1fr; /* 66/33 split */
        gap: var(--space-8);
        max-width: var(--container-xl);
        margin: 0 auto;
        padding: var(--space-8);
    }

    .stats-grid {
        grid-template-columns: 1fr 1fr;
    }

    .info-grid {
        grid-template-columns: 1fr 1fr 1fr 1fr;
    }
}

@media (min-width: 1280px) {
    .content-grid {
        gap: var(--space-10);
    }
}
</style>
{% endblock %}

{% block content %}
<main class="content-page">
    <!-- Page Header -->
    <header class="dollar-header">
        <h1 class="dollar-header__title">
            <i class="bi bi-currency-dollar text-success"></i> Dollar & Currency Markets
        </h1>
        <p class="dollar-header__description">Tracking the US Dollar Index, major currency pairs, and global FX dynamics</p>
        <p class="dollar-header__updated">Last Updated: <span id="last-updated-time">Loading...</span></p>
    </header>

    <!-- Content Grid: Stacked on mobile, side-by-side on tablet+ -->
    <div class="content-grid">
        <!-- Left Column: Chart (mobile: full width, tablet+: 60-66% width) -->
        <div>
            <!-- Chart Container (HERO ELEMENT on mobile) -->
            <div class="chart-container">
                <canvas id="dxy-chart"></canvas>
            </div>

            <!-- Time Range Controls (below chart) -->
            <div class="time-range-controls" id="dxy-timeframe-buttons">
                <button type="button" class="time-range-controls__button" data-timeframe="30">1M</button>
                <button type="button" class="time-range-controls__button" data-timeframe="90">3M</button>
                <button type="button" class="time-range-controls__button" data-timeframe="180">6M</button>
                <button type="button" class="time-range-controls__button active" data-timeframe="365">1Y</button>
                <button type="button" class="time-range-controls__button" data-timeframe="1825">5Y</button>
                <button type="button" class="time-range-controls__button" data-timeframe="3650">10Y</button>
                <button type="button" class="time-range-controls__button" data-timeframe="0">All</button>
            </div>
        </div>

        <!-- Right Column: Key Stats Panel (hidden on mobile, visible tablet+) -->
        <aside class="key-stats-panel">
            <h3 class="key-stats-panel__title">Key Metrics</h3>

            <div class="stat-card stat-card--success">
                <div class="stat-card__label">Dollar Index (DXY)</div>
                <div class="stat-card__value" id="key-dxy-value">--</div>
                <div class="stat-card__secondary" id="key-dxy-change">--</div>
            </div>

            <div class="stat-card stat-card--info">
                <div class="stat-card__label">USD/JPY</div>
                <div class="stat-card__value" id="key-usdjpy-value">--</div>
                <div class="stat-card__secondary" id="key-usdjpy-change">--</div>
            </div>

            <div class="stat-card stat-card--neutral">
                <div class="stat-card__label">EUR/USD</div>
                <div class="stat-card__value" id="key-eurusd-value">--</div>
                <div class="stat-card__secondary" id="key-eurusd-change">--</div>
            </div>

            <div class="stat-card stat-card--warning">
                <div class="stat-card__label">US-Japan Spread</div>
                <div class="stat-card__value" id="key-usjp-spread-value">-- bps</div>
                <div class="stat-card__secondary">Rate differential</div>
            </div>

            <div class="stat-card stat-card--info">
                <div class="stat-card__label">US-Germany Spread</div>
                <div class="stat-card__value" id="key-usde-spread-value">-- bps</div>
                <div class="stat-card__secondary">Rate differential</div>
            </div>
        </aside>
    </div>

    <!-- Collapsible Section: AI Daily Briefing -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="ai-briefing">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-chat-square-text-fill"></i> Daily Currency Briefing (AI)</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div style="background: white; padding: var(--space-4); border-radius: 8px;">
                <div id="dollar-summary-content" class="summary-text">
                    <p class="text-muted mb-0"><i class="bi bi-hourglass-split"></i> Loading daily briefing...</p>
                </div>
                <div id="dollar-summary-error" class="text-muted d-none">
                    <p class="mb-0"><i class="bi bi-info-circle"></i> No briefing available yet. Click "Reload Data" on the main dashboard to generate one.</p>
                </div>
                <div id="dollar-summary-timestamp" style="margin-top: var(--space-3); font-size: var(--text-xs); color: var(--neutral-500);"></div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: Market Statistics -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="market-stats">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title">Market Statistics</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-item__label">Dollar Index (DXY)</div>
                    <div class="stat-item__value stat-item__value--large" id="dxy-value">--</div>
                    <div class="stat-item__secondary">
                        <span id="dxy-change-5d">--</span>% (5d) | <span id="dxy-change-30d">--</span>% (30d)
                    </div>
                    <div class="stat-item__secondary" id="dxy-status">Loading</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">USD/JPY</div>
                    <div class="stat-item__value" id="usdjpy-value">--</div>
                    <div class="stat-item__secondary">
                        <span id="usdjpy-change-5d">--</span>% (5d) | <span id="usdjpy-change-30d">--</span>% (30d)
                    </div>
                    <div class="stat-item__secondary" id="usdjpy-status">Loading</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">EUR/USD</div>
                    <div class="stat-item__value" id="eurusd-value">--</div>
                    <div class="stat-item__secondary">
                        <span id="eurusd-change-5d">--</span>% (5d) | <span id="eurusd-change-30d">--</span>% (30d)
                    </div>
                    <div class="stat-item__secondary" id="eurusd-status">Loading</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">DXY Percentile</div>
                    <div class="stat-item__value" id="dxy-percentile">--</div>
                    <div class="stat-item__secondary" id="dxy-percentile-status">Historical ranking</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">Dollar Trend</div>
                    <div class="stat-item__value" id="dollar-trend">--</div>
                    <div class="stat-item__secondary" id="dollar-trend-detail">Analyzing...</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">US-Japan 10Y Spread</div>
                    <div class="stat-item__value" id="usjp-spread-value">--</div>
                    <div class="stat-item__secondary" id="usjp-spread-status">Rate differential</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">US-Germany 10Y Spread</div>
                    <div class="stat-item__value" id="usde-spread-value">--</div>
                    <div class="stat-item__secondary" id="usde-spread-status">Rate differential</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">Carry Trade Indicator</div>
                    <div class="stat-item__value" id="carry-indicator">--</div>
                    <div class="stat-item__secondary" id="carry-detail">Analyzing...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: Additional Charts -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="additional-charts">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-graph-up"></i> Additional Charts</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div style="margin-bottom: var(--space-6);">
                <h4 style="margin: 0 0 var(--space-3) 0; font-size: var(--text-lg); font-weight: 600;">USD/JPY (Carry Trade Indicator)</h4>
                <div class="chart-container" style="height: 400px; margin: 0;">
                    <canvas id="usdjpy-chart"></canvas>
                </div>
                <div class="time-range-controls" id="usdjpy-timeframe-buttons">
                    <button type="button" class="time-range-controls__button" data-timeframe="30">1M</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="90">3M</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="180">6M</button>
                    <button type="button" class="time-range-controls__button active" data-timeframe="365">1Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="1825">5Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="3650">10Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="0">All</button>
                </div>
                <div style="margin-top: var(--space-3); font-size: var(--text-xs); color: var(--neutral-500);">
                    <i class="bi bi-info-circle"></i> Rising USD/JPY = yen weakening (carry trade favorable). Sharp drops = potential carry unwind, watch for broader risk-off. BOJ policy shifts can cause violent moves.
                </div>
            </div>

            <div style="margin-bottom: var(--space-6);">
                <h4 style="margin: 0 0 var(--space-3) 0; font-size: var(--text-lg); font-weight: 600;">EUR/USD Exchange Rate</h4>
                <div class="chart-container" style="height: 400px; margin: 0;">
                    <canvas id="eurusd-chart"></canvas>
                </div>
                <div class="time-range-controls" id="eurusd-timeframe-buttons">
                    <button type="button" class="time-range-controls__button" data-timeframe="30">1M</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="90">3M</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="180">6M</button>
                    <button type="button" class="time-range-controls__button active" data-timeframe="365">1Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="1825">5Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="3650">10Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="0">All</button>
                </div>
                <div style="margin-top: var(--space-3); font-size: var(--text-xs); color: var(--neutral-500);">
                    <i class="bi bi-info-circle"></i> EUR/USD is the most traded currency pair. Above 1.10 = relatively strong euro. Parity (1.00) is a psychological level. Inversely related to DXY due to euro's 57.6% weight.
                </div>
            </div>

            <div style="margin-bottom: var(--space-6);">
                <h4 style="margin: 0 0 var(--space-3) 0; font-size: var(--text-lg); font-weight: 600;">Rate Differentials (10Y Spreads)</h4>
                <div class="chart-container" style="height: 400px; margin: 0;">
                    <canvas id="spreads-chart"></canvas>
                </div>
                <div class="time-range-controls" id="spreads-timeframe-buttons">
                    <button type="button" class="time-range-controls__button" data-timeframe="30">1M</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="90">3M</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="180">6M</button>
                    <button type="button" class="time-range-controls__button active" data-timeframe="365">1Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="1825">5Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="3650">10Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="0">All</button>
                </div>
                <div style="margin-top: var(--space-3); font-size: var(--text-xs); color: var(--neutral-500);">
                    <i class="bi bi-info-circle"></i> Rate differentials drive currency flows. Higher US-Japan spread = more attractive carry trade (borrow yen, buy USD). Higher US-Germany spread = dollar strength vs euro. Widening spreads = dollar tailwind.
                </div>
            </div>

            <div style="margin-bottom: var(--space-6);">
                <h4 style="margin: 0 0 var(--space-3) 0; font-size: var(--text-lg); font-weight: 600;">Dollar vs Other Assets</h4>
                <div class="chart-container" style="height: 400px; margin: 0;">
                    <canvas id="comparison-chart"></canvas>
                </div>
                <div class="time-range-controls" id="comparison-timeframe-buttons">
                    <button type="button" class="time-range-controls__button" data-timeframe="30">1M</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="90">3M</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="180">6M</button>
                    <button type="button" class="time-range-controls__button active" data-timeframe="365">1Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="1825">5Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="0">All</button>
                </div>
                <div style="margin-top: var(--space-3); font-size: var(--text-xs); color: var(--neutral-500);">
                    <i class="bi bi-info-circle"></i> Normalized to 100. Shows inverse relationship between dollar and gold/commodities. Divergences can signal turning points.
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: Understanding Dollar & Currency -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="understanding-dollar">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-lightbulb-fill"></i> Understanding Dollar & Currency Markets</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-card__title"><i class="bi bi-globe text-success"></i> Dollar Index (DXY)</div>
                    <div class="info-card__content">
                        <p class="mb-0">Measures USD against a basket of 6 major currencies (EUR 57.6%, JPY 13.6%, GBP 11.9%, CAD 9.1%, SEK 4.2%, CHF 3.6%). A rising DXY = stronger dollar = headwind for commodities and EM.</p>
                    </div>
                </div>
                <div class="info-card">
                    <div class="info-card__title"><i class="bi bi-arrow-repeat text-warning"></i> Dollar Smile Theory</div>
                    <div class="info-card__content">
                        <p class="mb-0">The dollar strengthens in <strong>both</strong> risk-on (US growth outperformance) and risk-off (flight to safety) environments. It weakens when global growth is strong but US growth is moderate.</p>
                    </div>
                </div>
                <div class="info-card">
                    <div class="info-card__title"><i class="bi bi-currency-yen text-danger"></i> Carry Trade & Yen</div>
                    <div class="info-card__content">
                        <p class="mb-0">Investors borrow in low-yield currencies (JPY) to invest in higher-yield assets. When USD/JPY falls sharply, carry trades unwind, causing broader deleveraging across risk assets.</p>
                    </div>
                </div>
                <div class="info-card">
                    <div class="info-card__title"><i class="bi bi-graph-up-arrow text-info"></i> Rate Differentials</div>
                    <div class="info-card__content">
                        <p class="mb-0">US-Japan and US-Germany 10Y spreads drive currency flows. Wider spreads = higher yield differential = dollar strength. Central bank policy divergence is the key driver.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: Warning Signs -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="warning-signs">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-exclamation-triangle"></i> Warning Signs</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div class="info-card" style="border-left-color: var(--danger-600);">
                <div class="info-card__content">
                    <ul class="mb-0">
                        <li><strong>Sharp yen strengthening</strong> - USD/JPY down 5%+ quickly can trigger carry unwind</li>
                        <li><strong>DXY breaking 100</strong> - Psychological level, below can accelerate weakness</li>
                        <li><strong>DXY above 110</strong> - Very strong dollar, pressures EM and commodities</li>
                        <li><strong>Dollar diverging from rates</strong> - If yields rise but dollar falls, watch Fed credibility</li>
                        <li><strong>Rapid spread compression</strong> - US-Japan spread narrowing fast = carry unwind risk</li>
                        <li><strong>EUR/USD breaking parity</strong> - Euro below 1.00 signals severe dollar strength</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: Key Levels to Watch -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="key-levels">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-bookmark-check"></i> Key Levels to Watch</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div class="info-card" style="border-left-color: var(--info-600);">
                <div class="info-card__content">
                    <ul class="mb-0">
                        <li><strong>DXY 100</strong> - Psychological pivot level</li>
                        <li><strong>DXY 105</strong> - Strong dollar territory, EM/commodity headwinds</li>
                        <li><strong>DXY 110+</strong> - Very strong, last seen 2022 (Fed aggressive tightening)</li>
                        <li><strong>USD/JPY 150</strong> - BOJ intervention risk zone</li>
                        <li><strong>USD/JPY 140</strong> - Key support, break below = carry unwind risk</li>
                        <li><strong>EUR/USD 1.00</strong> - Parity level, psychological importance</li>
                        <li><strong>US-JP Spread 350+ bps</strong> - Strong carry trade incentive</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: Cross-Asset Impact -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="cross-asset-impact">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-diagram-3"></i> Dollar Impact on Other Assets</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-card__title">Commodities</div>
                    <div class="info-card__content">
                        <p class="mb-0">Strong dollar = headwind for oil, gold, copper. Most commodities priced in USD, so a stronger dollar makes them more expensive for foreign buyers.</p>
                    </div>
                </div>
                <div class="info-card">
                    <div class="info-card__title">Emerging Markets</div>
                    <div class="info-card__content">
                        <p class="mb-0">Strong dollar = pressure on EM. Many EM countries have USD-denominated debt, making servicing harder. Capital tends to flow back to US.</p>
                    </div>
                </div>
                <div class="info-card">
                    <div class="info-card__title">US Multinationals</div>
                    <div class="info-card__content">
                        <p class="mb-0">Strong dollar = earnings headwind. Foreign revenue translates to fewer dollars. ~40% of S&P 500 revenue comes from abroad.</p>
                    </div>
                </div>
                <div class="info-card">
                    <div class="info-card__title">Rate Differentials</div>
                    <div class="info-card__content">
                        <p class="mb-0">Dollar typically follows rate spreads. Higher US rates vs other countries = dollar strength. Fed hawkish vs other CBs = dollar bid.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

</main>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
let recessionData = [];
let dxyChart = null;
let usdjpyChart = null;
let eurusdChart = null;
let spreadsChart = null;
let comparisonChart = null;

// Full data storage
let fullDxyData = null;
let fullUsdjpyData = null;
let fullEurusdData = null;
let fullUsJapanSpreadData = null;
let fullUsGermanySpreadData = null;
let fullGoldData = null;
let fullOilData = null;

// Current timeframes for each chart
let dxyTimeframe = 365;
let usdjpyTimeframe = 365;
let eurusdTimeframe = 365;
let spreadsTimeframe = 365;
let comparisonTimeframe = 365;

// Fetch recession data on load
fetch('/api/recessions')
    .then(response => response.json())
    .then(data => {
        recessionData = data;
        if (fullDxyData) {
            buildDxyChart();
            buildUsdjpyChart();
            buildEurusdChart();
            buildSpreadsChart();
            buildComparisonChart();
        }
    })
    .catch(error => {
        console.error('Error loading recession data:', error);
    });

// Generate recession annotations for chart
function getRecessionAnnotations(startDate, endDate) {
    if (!recessionData || recessionData.length === 0) return {};

    const chartStart = new Date(startDate);
    const chartEnd = new Date(endDate);
    const annotations = {};

    recessionData.forEach((recession, idx) => {
        const recStart = new Date(recession.start_date);
        const recEnd = new Date(recession.end_date);

        if (recEnd >= chartStart && recStart <= chartEnd) {
            const displayStart = recStart < chartStart ? chartStart : recStart;
            const displayEnd = recEnd > chartEnd ? chartEnd : recEnd;

            annotations[`recession_${idx}`] = {
                type: 'box',
                xMin: displayStart.toISOString().split('T')[0],
                xMax: displayEnd.toISOString().split('T')[0],
                backgroundColor: 'rgba(128, 128, 128, 0.15)',
                borderWidth: 0,
                label: { display: false }
            };
        }
    });

    return annotations;
}

// Filter data by timeframe
function filterByTimeframe(dates, values, days) {
    if (days === 0) return { dates, values };

    const now = new Date();
    const cutoffDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);

    const filteredDates = [];
    const filteredValues = [];

    dates.forEach((dateStr, idx) => {
        const date = new Date(dateStr);
        if (date >= cutoffDate) {
            filteredDates.push(dateStr);
            filteredValues.push(values[idx]);
        }
    });

    return { dates: filteredDates, values: filteredValues };
}

// Align datasets by date
function alignDataByDate(primaryDates, secondaryDates, secondaryValues) {
    const dateMap = new Map();
    secondaryDates.forEach((date, i) => {
        dateMap.set(date, secondaryValues[i]);
    });

    return primaryDates.map(date => dateMap.has(date) ? dateMap.get(date) : null);
}

// Determine time unit based on date range
function getTimeUnit(startDate, endDate) {
    const dateRange = new Date(endDate) - new Date(startDate);
    const dayRange = dateRange / (1000 * 60 * 60 * 24);
    if (dayRange <= 90) return 'day';
    if (dayRange <= 365) return 'week';
    if (dayRange <= 1825) return 'month';
    return 'year';
}

// Calculate percentage change
function calcPctChange(values, periods) {
    if (!values || values.length <= periods) return null;
    const current = values[values.length - 1];
    const previous = values[values.length - 1 - periods];
    if (previous === 0) return null;
    return ((current / previous) - 1) * 100;
}

// Calculate percentile
function calcPercentile(values, current) {
    if (!values || values.length === 0) return null;
    const sorted = [...values].sort((a, b) => a - b);
    const rank = sorted.filter(v => v <= current).length;
    return (rank / sorted.length) * 100;
}

// Load all dollar data
async function loadDollarData() {
    try {
        // Load DXY
        const dxyResponse = await fetch('/api/metrics/dollar_index_price');
        const dxyData = await dxyResponse.json();

        if (dxyData && dxyData.values && dxyData.values.length > 0) {
            fullDxyData = dxyData;
            const current = dxyData.values[dxyData.values.length - 1];
            document.getElementById('dxy-value').textContent = current.toFixed(2);
            document.getElementById('key-dxy-value').textContent = current.toFixed(2);

            const change5d = calcPctChange(dxyData.values, 5);
            const change30d = calcPctChange(dxyData.values, 30);

            if (change5d !== null) {
                document.getElementById('dxy-change-5d').textContent = (change5d >= 0 ? '+' : '') + change5d.toFixed(1);
            }
            if (change30d !== null) {
                document.getElementById('dxy-change-30d').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(1);
                document.getElementById('key-dxy-change').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(1) + '% (30d)';
            }

            const percentile = calcPercentile(dxyData.values, current);
            const statusEl = document.getElementById('dxy-status');
            if (percentile !== null) {
                if (percentile > 80) {
                    statusEl.textContent = 'STRONG';
                } else if (percentile > 50) {
                    statusEl.textContent = 'FIRM';
                } else if (percentile > 20) {
                    statusEl.textContent = 'NEUTRAL';
                } else {
                    statusEl.textContent = 'WEAK';
                }
            }

            if (percentile !== null) {
                document.getElementById('dxy-percentile').textContent = percentile.toFixed(1) + '%';
                const percStatusEl = document.getElementById('dxy-percentile-status');
                if (percentile > 80) {
                    percStatusEl.textContent = 'HIGH';
                } else if (percentile > 50) {
                    percStatusEl.textContent = 'ABOVE AVG';
                } else if (percentile > 20) {
                    percStatusEl.textContent = 'BELOW AVG';
                } else {
                    percStatusEl.textContent = 'LOW';
                }
            }

            updateDollarTrend(dxyData.values, change5d, change30d);
        }

        // Load USD/JPY
        const usdjpyResponse = await fetch('/api/metrics/usdjpy_price');
        const usdjpyData = await usdjpyResponse.json();

        if (usdjpyData && usdjpyData.values && usdjpyData.values.length > 0) {
            fullUsdjpyData = usdjpyData;
            const current = usdjpyData.values[usdjpyData.values.length - 1];
            document.getElementById('usdjpy-value').textContent = current.toFixed(2);
            document.getElementById('key-usdjpy-value').textContent = current.toFixed(2);

            const change5d = calcPctChange(usdjpyData.values, 5);
            const change30d = calcPctChange(usdjpyData.values, 30);

            if (change5d !== null) {
                document.getElementById('usdjpy-change-5d').textContent = (change5d >= 0 ? '+' : '') + change5d.toFixed(1);
            }
            if (change30d !== null) {
                document.getElementById('usdjpy-change-30d').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(1);
                document.getElementById('key-usdjpy-change').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(1) + '% (30d)';
            }

            const statusEl = document.getElementById('usdjpy-status');
            if (current > 150) {
                statusEl.textContent = 'YEN VERY WEAK';
            } else if (current > 145) {
                statusEl.textContent = 'YEN WEAK';
            } else if (current > 135) {
                statusEl.textContent = 'NORMAL';
            } else {
                statusEl.textContent = 'YEN STRONG';
            }
        }

        // Load EUR/USD
        const eurusdResponse = await fetch('/api/metrics/eurusd_price');
        const eurusdData = await eurusdResponse.json();

        if (eurusdData && eurusdData.values && eurusdData.values.length > 0) {
            fullEurusdData = eurusdData;
            const current = eurusdData.values[eurusdData.values.length - 1];
            document.getElementById('eurusd-value').textContent = current.toFixed(4);
            document.getElementById('key-eurusd-value').textContent = current.toFixed(4);

            const change5d = calcPctChange(eurusdData.values, 5);
            const change30d = calcPctChange(eurusdData.values, 30);

            if (change5d !== null) {
                document.getElementById('eurusd-change-5d').textContent = (change5d >= 0 ? '+' : '') + change5d.toFixed(1);
            }
            if (change30d !== null) {
                document.getElementById('eurusd-change-30d').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(1);
                document.getElementById('key-eurusd-change').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(1) + '% (30d)';
            }

            const statusEl = document.getElementById('eurusd-status');
            if (current > 1.15) {
                statusEl.textContent = 'EURO STRONG';
            } else if (current > 1.05) {
                statusEl.textContent = 'NORMAL';
            } else if (current > 1.00) {
                statusEl.textContent = 'EURO WEAK';
            } else {
                statusEl.textContent = 'BELOW PARITY';
            }
        }

        // Load US-Japan 10Y Spread
        const usJapanSpreadResponse = await fetch('/api/metrics/us_japan_10y_spread');
        const usJapanSpreadData = await usJapanSpreadResponse.json();

        if (usJapanSpreadData && usJapanSpreadData.values && usJapanSpreadData.values.length > 0) {
            fullUsJapanSpreadData = usJapanSpreadData;
            const current = usJapanSpreadData.values[usJapanSpreadData.values.length - 1];
            const bps = (current * 100).toFixed(0);
            document.getElementById('usjp-spread-value').textContent = bps + ' bps';
            document.getElementById('key-usjp-spread-value').textContent = bps + ' bps';

            const statusEl = document.getElementById('usjp-spread-status');
            if (current > 3.5) {
                statusEl.textContent = 'WIDE';
            } else if (current > 2.5) {
                statusEl.textContent = 'NORMAL';
            } else if (current > 1.5) {
                statusEl.textContent = 'NARROW';
            } else {
                statusEl.textContent = 'VERY NARROW';
            }
        }

        // Load US-Germany 10Y Spread
        const usGermanySpreadResponse = await fetch('/api/metrics/us_germany_10y_spread');
        const usGermanySpreadData = await usGermanySpreadResponse.json();

        if (usGermanySpreadData && usGermanySpreadData.values && usGermanySpreadData.values.length > 0) {
            fullUsGermanySpreadData = usGermanySpreadData;
            const current = usGermanySpreadData.values[usGermanySpreadData.values.length - 1];
            const bps = (current * 100).toFixed(0);
            document.getElementById('usde-spread-value').textContent = bps + ' bps';
            document.getElementById('key-usde-spread-value').textContent = bps + ' bps';

            const statusEl = document.getElementById('usde-spread-status');
            if (current > 2.0) {
                statusEl.textContent = 'WIDE';
            } else if (current > 1.0) {
                statusEl.textContent = 'NORMAL';
            } else if (current > 0.5) {
                statusEl.textContent = 'NARROW';
            } else {
                statusEl.textContent = 'VERY NARROW';
            }

            updateCarryIndicator(fullUsJapanSpreadData, fullUsGermanySpreadData);
        }

        // Load Gold for comparison
        const goldResponse = await fetch('/api/metrics/gold_price');
        const goldData = await goldResponse.json();
        if (goldData && goldData.values && goldData.values.length > 0) {
            fullGoldData = goldData;
        }

        // Load Oil for comparison
        const oilResponse = await fetch('/api/metrics/oil_price');
        const oilData = await oilResponse.json();
        if (oilData && oilData.values && oilData.values.length > 0) {
            fullOilData = oilData;
        }

        // Build charts
        buildDxyChart();
        buildUsdjpyChart();
        buildEurusdChart();
        buildSpreadsChart();
        buildComparisonChart();

        // Update last updated time
        const now = new Date();
        document.getElementById('last-updated-time').textContent = now.toLocaleString();

    } catch (error) {
        console.error('Error loading dollar data:', error);
    }
}

function updateDollarTrend(values, change5d, change30d) {
    const trendEl = document.getElementById('dollar-trend');
    const detailEl = document.getElementById('dollar-trend-detail');

    if (change5d === null || change30d === null) return;

    if (change5d > 1 && change30d > 2) {
        trendEl.textContent = 'Strengthening';
        detailEl.textContent = 'Dollar gaining on multiple timeframes';
    } else if (change5d < -1 && change30d < -2) {
        trendEl.textContent = 'Weakening';
        detailEl.textContent = 'Dollar losing ground';
    } else if (Math.abs(change5d) < 0.5 && Math.abs(change30d) < 1) {
        trendEl.textContent = 'Ranging';
        detailEl.textContent = 'No clear direction';
    } else if (change5d > 0 !== change30d > 0) {
        trendEl.textContent = 'Mixed';
        detailEl.textContent = 'Short vs long-term diverging';
    } else {
        trendEl.textContent = 'Stable';
        detailEl.textContent = 'Minor moves only';
    }
}

function updateCarryIndicator(usJapanData, usGermanyData) {
    const indicatorEl = document.getElementById('carry-indicator');
    const detailEl = document.getElementById('carry-detail');

    if (!usJapanData || !usJapanData.values || usJapanData.values.length < 30) {
        return;
    }

    const currentSpread = usJapanData.values[usJapanData.values.length - 1];
    const spread30dAgo = usJapanData.values[usJapanData.values.length - 30] || usJapanData.values[0];
    const spreadChange = currentSpread - spread30dAgo;

    if (currentSpread > 3.5) {
        indicatorEl.textContent = 'Favorable';
        detailEl.textContent = 'Wide US-JP spread supports carry';
    } else if (currentSpread > 2.5 && spreadChange > 0.1) {
        indicatorEl.textContent = 'Improving';
        detailEl.textContent = 'Spreads widening, USD positive';
    } else if (currentSpread > 2.5) {
        indicatorEl.textContent = 'Neutral';
        detailEl.textContent = 'Moderate carry trade environment';
    } else if (spreadChange < -0.2) {
        indicatorEl.textContent = 'Deteriorating';
        detailEl.textContent = 'Spreads narrowing, watch for unwind';
    } else if (currentSpread < 2.0) {
        indicatorEl.textContent = 'Unfavorable';
        detailEl.textContent = 'Narrow spreads, carry trade fragile';
    } else {
        indicatorEl.textContent = 'Mixed';
        detailEl.textContent = 'No clear signal';
    }
}

function buildDxyChart() {
    if (!fullDxyData) return;

    const filtered = filterByTimeframe(fullDxyData.dates, fullDxyData.values, dxyTimeframe);
    if (filtered.dates.length === 0) return;

    const startDate = filtered.dates[0];
    const endDate = filtered.dates[filtered.dates.length - 1];
    const recessionAnnotations = getRecessionAnnotations(startDate, endDate);
    const timeUnit = getTimeUnit(startDate, endDate);

    if (dxyChart) dxyChart.destroy();

    const ctx = document.getElementById('dxy-chart').getContext('2d');
    dxyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: filtered.dates,
            datasets: [{
                label: 'Dollar Index (DXY)',
                data: filtered.values,
                borderColor: 'rgb(25, 135, 84)',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                borderWidth: 2,
                fill: true,
                pointRadius: 0,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                annotation: { annotations: recessionAnnotations },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'DXY: ' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: timeUnit, displayFormats: { day: 'MMM d', week: 'MMM d', month: 'MMM yyyy', year: 'yyyy' } }
                },
                y: {
                    title: { display: true, text: 'Dollar Index' }
                }
            }
        }
    });
}

function buildUsdjpyChart() {
    if (!fullUsdjpyData) return;

    const filtered = filterByTimeframe(fullUsdjpyData.dates, fullUsdjpyData.values, usdjpyTimeframe);
    if (filtered.dates.length === 0) return;

    const startDate = filtered.dates[0];
    const endDate = filtered.dates[filtered.dates.length - 1];
    const recessionAnnotations = getRecessionAnnotations(startDate, endDate);
    const timeUnit = getTimeUnit(startDate, endDate);

    recessionAnnotations['level150'] = {
        type: 'line',
        yMin: 150,
        yMax: 150,
        borderColor: 'rgba(220, 53, 69, 0.5)',
        borderWidth: 1,
        borderDash: [5, 5],
        label: {
            display: true,
            content: 'BOJ Watch (150)',
            position: 'end',
            backgroundColor: 'rgba(220, 53, 69, 0.7)',
            color: 'white',
            font: { size: 9 }
        }
    };

    if (usdjpyChart) usdjpyChart.destroy();

    const ctx = document.getElementById('usdjpy-chart').getContext('2d');
    usdjpyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: filtered.dates,
            datasets: [{
                label: 'USD/JPY',
                data: filtered.values,
                borderColor: 'rgb(220, 53, 69)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                borderWidth: 2,
                fill: true,
                pointRadius: 0,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                annotation: { annotations: recessionAnnotations },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'USD/JPY: ' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: timeUnit, displayFormats: { day: 'MMM d', week: 'MMM d', month: 'MMM yyyy', year: 'yyyy' } }
                },
                y: {
                    title: { display: true, text: 'USD/JPY' }
                }
            }
        }
    });
}

function buildEurusdChart() {
    if (!fullEurusdData) return;

    const filtered = filterByTimeframe(fullEurusdData.dates, fullEurusdData.values, eurusdTimeframe);
    if (filtered.dates.length === 0) return;

    const startDate = filtered.dates[0];
    const endDate = filtered.dates[filtered.dates.length - 1];
    const recessionAnnotations = getRecessionAnnotations(startDate, endDate);
    const timeUnit = getTimeUnit(startDate, endDate);

    recessionAnnotations['parity'] = {
        type: 'line',
        yMin: 1.0,
        yMax: 1.0,
        borderColor: 'rgba(220, 53, 69, 0.5)',
        borderWidth: 1,
        borderDash: [5, 5],
        label: {
            display: true,
            content: 'Parity (1.00)',
            position: 'end',
            backgroundColor: 'rgba(220, 53, 69, 0.7)',
            color: 'white',
            font: { size: 9 }
        }
    };

    if (eurusdChart) eurusdChart.destroy();

    const ctx = document.getElementById('eurusd-chart').getContext('2d');
    eurusdChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: filtered.dates,
            datasets: [{
                label: 'EUR/USD',
                data: filtered.values,
                borderColor: 'rgb(13, 110, 253)',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                borderWidth: 2,
                fill: true,
                pointRadius: 0,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                annotation: { annotations: recessionAnnotations },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'EUR/USD: ' + context.parsed.y.toFixed(4);
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: timeUnit, displayFormats: { day: 'MMM d', week: 'MMM d', month: 'MMM yyyy', year: 'yyyy' } }
                },
                y: {
                    title: { display: true, text: 'EUR/USD' }
                }
            }
        }
    });
}

function buildSpreadsChart() {
    if (!fullUsJapanSpreadData && !fullUsGermanySpreadData) return;

    const primaryData = fullUsJapanSpreadData || fullUsGermanySpreadData;
    const filtered = filterByTimeframe(primaryData.dates, primaryData.values, spreadsTimeframe);
    if (filtered.dates.length === 0) return;

    const startDate = filtered.dates[0];
    const endDate = filtered.dates[filtered.dates.length - 1];
    const recessionAnnotations = getRecessionAnnotations(startDate, endDate);
    const timeUnit = getTimeUnit(startDate, endDate);

    const datasets = [];

    if (fullUsJapanSpreadData) {
        const usJapanFiltered = filterByTimeframe(fullUsJapanSpreadData.dates, fullUsJapanSpreadData.values, spreadsTimeframe);
        const usJapanBps = usJapanFiltered.values.map(v => v * 100);
        datasets.push({
            label: 'US-Japan 10Y Spread (bps)',
            data: usJapanBps,
            borderColor: 'rgb(255, 193, 7)',
            backgroundColor: 'rgba(255, 193, 7, 0.1)',
            borderWidth: 2,
            fill: false,
            pointRadius: 0,
            tension: 0.1,
            yAxisID: 'y'
        });
    }

    if (fullUsGermanySpreadData) {
        const usGermanyFiltered = filterByTimeframe(fullUsGermanySpreadData.dates, fullUsGermanySpreadData.values, spreadsTimeframe);
        const alignedValues = alignDataByDate(filtered.dates, usGermanyFiltered.dates, usGermanyFiltered.values);
        const usGermanyBps = alignedValues.map(v => v !== null ? v * 100 : null);
        datasets.push({
            label: 'US-Germany 10Y Spread (bps)',
            data: usGermanyBps,
            borderColor: 'rgb(13, 202, 240)',
            backgroundColor: 'rgba(13, 202, 240, 0.1)',
            borderWidth: 2,
            fill: false,
            pointRadius: 0,
            tension: 0.1,
            yAxisID: 'y'
        });
    }

    if (spreadsChart) spreadsChart.destroy();

    const ctx = document.getElementById('spreads-chart').getContext('2d');
    spreadsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: filtered.dates,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                annotation: { annotations: recessionAnnotations },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(0) + ' bps';
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: timeUnit, displayFormats: { day: 'MMM d', week: 'MMM d', month: 'MMM yyyy', year: 'yyyy' } }
                },
                y: {
                    title: { display: true, text: 'Spread (basis points)' }
                }
            }
        }
    });
}

function buildComparisonChart() {
    if (!fullDxyData) return;

    const filtered = filterByTimeframe(fullDxyData.dates, fullDxyData.values, comparisonTimeframe);
    if (filtered.dates.length === 0) return;

    const dxyBase = filtered.values[0];
    const dxyNormalized = filtered.values.map(v => (v / dxyBase) * 100);

    let goldNormalized = null;
    if (fullGoldData) {
        const goldAligned = alignDataByDate(filtered.dates, fullGoldData.dates, fullGoldData.values);
        let goldBaseIdx = goldAligned.findIndex(v => v !== null);
        if (goldBaseIdx >= 0) {
            const goldBase = goldAligned[goldBaseIdx];
            goldNormalized = goldAligned.map(v => v !== null ? (v / goldBase) * 100 : null);
        }
    }

    let oilNormalized = null;
    if (fullOilData) {
        const oilAligned = alignDataByDate(filtered.dates, fullOilData.dates, fullOilData.values);
        let oilBaseIdx = oilAligned.findIndex(v => v !== null);
        if (oilBaseIdx >= 0) {
            const oilBase = oilAligned[oilBaseIdx];
            oilNormalized = oilAligned.map(v => v !== null ? (v / oilBase) * 100 : null);
        }
    }

    const startDate = filtered.dates[0];
    const endDate = filtered.dates[filtered.dates.length - 1];
    const recessionAnnotations = getRecessionAnnotations(startDate, endDate);
    const timeUnit = getTimeUnit(startDate, endDate);

    if (comparisonChart) comparisonChart.destroy();

    const datasets = [{
        label: 'Dollar Index',
        data: dxyNormalized,
        borderColor: 'rgb(25, 135, 84)',
        borderWidth: 2,
        fill: false,
        pointRadius: 0,
        tension: 0.1
    }];

    if (goldNormalized) {
        datasets.push({
            label: 'Gold',
            data: goldNormalized,
            borderColor: 'rgb(255, 193, 7)',
            borderWidth: 2,
            fill: false,
            pointRadius: 0,
            tension: 0.1
        });
    }

    if (oilNormalized) {
        datasets.push({
            label: 'Oil (WTI)',
            data: oilNormalized,
            borderColor: 'rgb(13, 110, 253)',
            borderWidth: 2,
            fill: false,
            pointRadius: 0,
            tension: 0.1
        });
    }

    const ctx = document.getElementById('comparison-chart').getContext('2d');
    comparisonChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: filtered.dates,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                annotation: { annotations: recessionAnnotations }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: timeUnit, displayFormats: { day: 'MMM d', week: 'MMM d', month: 'MMM yyyy', year: 'yyyy' } }
                },
                y: {
                    title: { display: true, text: 'Normalized (100 = Start)' }
                }
            }
        }
    });
}

// Load AI-generated dollar summary
async function loadDollarSummary() {
    try {
        const response = await fetch('/api/dollar-summary');
        const data = await response.json();

        const contentDiv = document.getElementById('dollar-summary-content');
        const errorDiv = document.getElementById('dollar-summary-error');
        const timestampDiv = document.getElementById('dollar-summary-timestamp');

        if (data.error) {
            contentDiv.classList.add('d-none');
            errorDiv.classList.remove('d-none');
            return;
        }

        if (typeof marked !== 'undefined') {
            marked.setOptions({ breaks: true, gfm: true, sanitize: false });
            contentDiv.innerHTML = marked.parse(data.summary);
        } else {
            contentDiv.innerHTML = data.summary
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        if (data.generated_at) {
            const genDate = new Date(data.generated_at);
            const dateStr = genDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const timeStr = genDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            timestampDiv.textContent = `Generated: ${dateStr} at ${timeStr}`;
        }

    } catch (error) {
        console.error('Error loading dollar summary:', error);
        document.getElementById('dollar-summary-content').classList.add('d-none');
        document.getElementById('dollar-summary-error').classList.remove('d-none');
    }
}

// Initialize collapsible sections
function initCollapsibleSections() {
    const sections = document.querySelectorAll('.collapsible-section');

    sections.forEach(section => {
        const header = section.querySelector('.collapsible-section__header');
        const content = section.querySelector('.collapsible-section__content');

        header.addEventListener('click', () => {
            const isExpanded = header.getAttribute('aria-expanded') === 'true';

            header.setAttribute('aria-expanded', !isExpanded);
            content.hidden = isExpanded;
        });

        header.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                header.click();
            }
        });
    });
}

// Initialize time range controls
function initTimeRangeControls() {
    // DXY chart
    document.querySelectorAll('#dxy-timeframe-buttons button[data-timeframe]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('#dxy-timeframe-buttons button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            dxyTimeframe = parseInt(this.getAttribute('data-timeframe'));
            buildDxyChart();
        });
    });

    // USD/JPY chart
    document.querySelectorAll('#usdjpy-timeframe-buttons button[data-timeframe]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('#usdjpy-timeframe-buttons button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            usdjpyTimeframe = parseInt(this.getAttribute('data-timeframe'));
            buildUsdjpyChart();
        });
    });

    // EUR/USD chart
    document.querySelectorAll('#eurusd-timeframe-buttons button[data-timeframe]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('#eurusd-timeframe-buttons button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            eurusdTimeframe = parseInt(this.getAttribute('data-timeframe'));
            buildEurusdChart();
        });
    });

    // Spreads chart
    document.querySelectorAll('#spreads-timeframe-buttons button[data-timeframe]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('#spreads-timeframe-buttons button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            spreadsTimeframe = parseInt(this.getAttribute('data-timeframe'));
            buildSpreadsChart();
        });
    });

    // Comparison chart
    document.querySelectorAll('#comparison-timeframe-buttons button[data-timeframe]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('#comparison-timeframe-buttons button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            comparisonTimeframe = parseInt(this.getAttribute('data-timeframe'));
            buildComparisonChart();
        });
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDollarSummary();
    loadDollarData();
    initCollapsibleSections();
    initTimeRangeControls();
});
</script>
{% endblock %}
