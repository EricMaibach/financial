{% extends "base.html" %}

{% block title %}Divergence Gap - Financial Markets{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-arrow-left-right text-danger"></i>
            Divergence Gap Analysis
        </h1>
        <p class="lead">Tracking the gap between gold-implied credit spreads and actual high-yield spreads</p>
    </div>
</div>

<!-- Explanation Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle-fill"></i> What is the Divergence Gap?
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-2">
                    The <strong>Divergence Gap</strong> measures the difference between what gold prices imply credit spreads should be
                    versus what they actually are in the high-yield bond market.
                </p>
                <ul class="mb-2">
                    <li><strong>Gold-Implied Spread:</strong> Calculated from gold prices using a historical relationship model</li>
                    <li><strong>Actual HY Spread:</strong> Real high-yield credit spreads from the bond market</li>
                    <li><strong>Divergence Gap:</strong> Gold-Implied minus Actual HY Spread</li>
                </ul>
                <p class="mb-0">
                    <strong>Interpretation:</strong> A large positive gap suggests gold is pricing in more risk/fear than credit markets,
                    potentially signaling that credit spreads may widen. Historically, large divergences tend to resolve with credit
                    spreads catching up to gold's warning.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics Row -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
        <a href="/metric/divergence_gap" class="metric-link">
            <div class="card metric-card border-danger">
                <div class="card-body">
                    <h6 class="text-muted">DIVERGENCE GAP</h6>
                    <h2 class="mb-0 text-danger" id="divergence-gap">-- bp</h2>
                    <small class="text-muted">
                        <span id="divergence-change-5d">--</span> bp (5d) / <span id="divergence-change-30d">--</span> bp (30d)
                    </small>
                    <div class="mt-2">
                        <span class="badge bg-warning" id="divergence-status">EXTREME</span>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card metric-card">
            <div class="card-body">
                <h6 class="text-muted">GOLD-IMPLIED SPREAD</h6>
                <h2 class="mb-0 text-warning" id="implied-spread">-- bp</h2>
                <small class="text-muted">What gold says spreads should be</small>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <a href="/metric/high_yield_spread" class="metric-link">
            <div class="card metric-card">
                <div class="card-body">
                    <h6 class="text-muted">ACTUAL HY SPREAD</h6>
                    <h2 class="mb-0 text-primary" id="hy-spread">-- bp</h2>
                    <small class="text-muted">
                        <span id="hy-change-5d">--</span> bp (5d) / <span id="hy-change-30d">--</span> bp (30d)
                    </small>
                    <div class="mt-2">
                        <span class="badge" id="hy-status">Loading</span>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <a href="/metric/gold_price" class="metric-link">
            <div class="card metric-card">
                <div class="card-body">
                    <h6 class="text-muted">GOLD PRICE</h6>
                    <h2 class="mb-0" id="gold-price">$--</h2>
                    <small class="text-muted">
                        <span id="gold-change-5d">--</span>% (5d) / <span id="gold-change-30d">--</span>% (30d)
                    </small>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Time Frame Selector -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body py-2">
                <div class="d-flex align-items-center justify-content-between flex-wrap">
                    <small class="text-muted me-3"><i class="bi bi-calendar-range"></i> Time Frame:</small>
                    <div class="btn-group btn-group-sm" role="group" id="timeframe-selector">
                        <button type="button" class="btn btn-outline-secondary" data-timeframe="30">1M</button>
                        <button type="button" class="btn btn-outline-secondary" data-timeframe="90">3M</button>
                        <button type="button" class="btn btn-outline-secondary" data-timeframe="180">6M</button>
                        <button type="button" class="btn btn-outline-secondary" data-timeframe="365">1Y</button>
                        <button type="button" class="btn btn-outline-secondary" data-timeframe="1825">5Y</button>
                        <button type="button" class="btn btn-outline-secondary" data-timeframe="3650">10Y</button>
                        <button type="button" class="btn btn-outline-secondary" data-timeframe="5475">15Y</button>
                        <button type="button" class="btn btn-outline-secondary" data-timeframe="7300">20Y</button>
                        <button type="button" class="btn btn-outline-secondary active" data-timeframe="all">All</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Divergence Gap Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up"></i> Divergence Gap Over Time
                </h5>
            </div>
            <div class="card-body">
                <canvas id="divergence-chart"></canvas>
            </div>
            <div class="card-footer">
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> The gap between what gold implies credit spreads should be vs actual spreads.
                    Gap widening = divergence getting worse. Grey bands indicate recession periods.
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Historical Context -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> Historical Context
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>Normal Range</h6>
                        <p class="text-muted mb-0">Divergence gap typically stays within -200 to +300 bp during normal market conditions.</p>
                    </div>
                    <div class="col-md-4">
                        <h6>Warning Signs</h6>
                        <p class="text-muted mb-0">Gap exceeding +600 bp has historically preceded credit stress events.</p>
                    </div>
                    <div class="col-md-4">
                        <h6>Extreme Levels</h6>
                        <p class="text-muted mb-0">Gap above +900 bp is rare and suggests significant market dislocation.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
let recessionData = []; // Store recession periods for shading
let fullChartData = null; // Cache full data for time filtering
let divergenceChart = null; // Chart instance
let currentTimeframe = 'all'; // Current selected timeframe

// Fetch recession data on load
fetch('/api/recessions')
    .then(response => response.json())
    .then(data => {
        recessionData = data;
        // Re-render chart if data is already loaded
        if (fullChartData) {
            applyTimeFrameFilter(currentTimeframe);
        }
    })
    .catch(error => {
        console.error('Error loading recession data:', error);
    });

// Generate recession annotations for chart
function getRecessionAnnotations(startDate, endDate) {
    if (!recessionData || recessionData.length === 0) return {};

    const chartStart = new Date(startDate);
    const chartEnd = new Date(endDate);
    const annotations = {};

    recessionData.forEach((recession, idx) => {
        const recStart = new Date(recession.start_date);
        const recEnd = new Date(recession.end_date);

        // Check if recession overlaps with chart date range
        if (recEnd >= chartStart && recStart <= chartEnd) {
            // Clamp to chart boundaries
            const displayStart = recStart < chartStart ? chartStart : recStart;
            const displayEnd = recEnd > chartEnd ? chartEnd : recEnd;

            annotations[`recession_${idx}`] = {
                type: 'box',
                xMin: displayStart.toISOString().split('T')[0],
                xMax: displayEnd.toISOString().split('T')[0],
                backgroundColor: 'rgba(128, 128, 128, 0.15)',
                borderWidth: 0,
                label: {
                    display: false
                }
            };
        }
    });

    return annotations;
}

// Load divergence data for metrics cards
async function loadDivergenceData() {
    try {
        const response = await fetch('/api/dashboard');
        const data = await response.json();

        // Update divergence metrics
        if (data.metrics.divergence) {
            document.getElementById('divergence-gap').textContent = `${data.metrics.divergence.gap} bp`;
            document.getElementById('implied-spread').textContent = `${data.metrics.divergence.gold_implied_spread} bp`;
            document.getElementById('divergence-change-5d').textContent =
                (data.metrics.divergence.gap_change_5d >= 0 ? '+' : '') + data.metrics.divergence.gap_change_5d;
            document.getElementById('divergence-change-30d').textContent =
                (data.metrics.divergence.gap_change_30d >= 0 ? '+' : '') + data.metrics.divergence.gap_change_30d;

            // Update status badge based on gap level
            const gap = data.metrics.divergence.gap;
            const statusEl = document.getElementById('divergence-status');
            if (gap > 900) {
                statusEl.textContent = 'EXTREME';
                statusEl.className = 'badge bg-danger';
            } else if (gap > 600) {
                statusEl.textContent = 'HIGH';
                statusEl.className = 'badge bg-warning';
            } else if (gap > 300) {
                statusEl.textContent = 'MODERATE';
                statusEl.className = 'badge bg-info';
            } else {
                statusEl.textContent = 'NORMAL';
                statusEl.className = 'badge bg-success';
            }
        }

        // Update HY spread
        if (data.metrics.hy_spread) {
            document.getElementById('hy-spread').textContent = `${data.metrics.hy_spread.current} bp`;
            document.getElementById('hy-change-5d').textContent =
                (data.metrics.hy_spread.change_5d >= 0 ? '+' : '') + data.metrics.hy_spread.change_5d;
            document.getElementById('hy-change-30d').textContent =
                (data.metrics.hy_spread.change_30d >= 0 ? '+' : '') + data.metrics.hy_spread.change_30d;

            const hyStatus = document.getElementById('hy-status');
            if (data.metrics.hy_spread.status === 'tight') {
                hyStatus.textContent = 'TIGHT';
                hyStatus.className = 'badge bg-danger';
            } else if (data.metrics.hy_spread.status === 'normal') {
                hyStatus.textContent = 'NORMAL';
                hyStatus.className = 'badge bg-success';
            } else {
                hyStatus.textContent = 'WIDE';
                hyStatus.className = 'badge bg-warning';
            }
        }

        // Update gold price
        if (data.metrics.gold) {
            document.getElementById('gold-price').textContent = `$${data.metrics.gold.price.toLocaleString()}`;
            document.getElementById('gold-change-5d').textContent =
                (data.metrics.gold.change_5d >= 0 ? '+' : '') + data.metrics.gold.change_5d.toFixed(1);
            document.getElementById('gold-change-30d').textContent =
                (data.metrics.gold.change_30d >= 0 ? '+' : '') + data.metrics.gold.change_30d.toFixed(1);
        }

    } catch (error) {
        console.error('Error loading divergence data:', error);
    }
}

// Load and cache full chart data
async function loadChartData() {
    try {
        const response = await fetch('/api/chart/divergence_gap');
        fullChartData = await response.json();

        // Render with default timeframe
        applyTimeFrameFilter(currentTimeframe);

    } catch (error) {
        console.error('Error loading divergence chart:', error);
    }
}

// Apply time frame filter and render chart
function applyTimeFrameFilter(timeframe) {
    if (!fullChartData) return;

    currentTimeframe = timeframe;
    let filteredData = { ...fullChartData };

    if (timeframe !== 'all') {
        const days = parseInt(timeframe);
        const now = new Date();
        const cutoffDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);

        // Filter the data
        const filteredIndices = [];
        fullChartData.dates.forEach((dateStr, idx) => {
            const date = new Date(dateStr);
            if (date >= cutoffDate) {
                filteredIndices.push(idx);
            }
        });

        filteredData = {
            dates: filteredIndices.map(i => fullChartData.dates[i]),
            divergence_gap: filteredIndices.map(i => fullChartData.divergence_gap[i]),
            implied_spread: filteredIndices.map(i => fullChartData.implied_spread[i]),
            actual_spread: filteredIndices.map(i => fullChartData.actual_spread[i])
        };
    }

    renderChart(filteredData);
}

// Render the divergence chart
function renderChart(data) {
    if (!data || !data.dates || data.dates.length === 0) {
        console.warn('No data to render');
        return;
    }

    // Get recession annotations for the filtered date range
    const startDate = data.dates[0];
    const endDate = data.dates[data.dates.length - 1];
    const recessionAnnotations = getRecessionAnnotations(startDate, endDate);

    // Destroy existing chart
    if (divergenceChart) {
        divergenceChart.destroy();
    }

    // Determine appropriate time unit based on data range
    const dateRange = new Date(endDate) - new Date(startDate);
    const dayRange = dateRange / (1000 * 60 * 60 * 24);
    let timeUnit = 'year';
    if (dayRange <= 90) {
        timeUnit = 'day';
    } else if (dayRange <= 365) {
        timeUnit = 'week';
    } else if (dayRange <= 1825) {
        timeUnit = 'month';
    }

    const ctx = document.getElementById('divergence-chart').getContext('2d');
    divergenceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [
                {
                    label: 'Divergence Gap',
                    data: data.divergence_gap,
                    borderColor: 'rgb(220, 53, 69)',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    yAxisID: 'y1',
                    pointRadius: 0,
                    pointHoverRadius: 4
                },
                {
                    label: 'Gold-Implied Spread',
                    data: data.implied_spread,
                    borderColor: 'rgb(255, 193, 7)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    yAxisID: 'y',
                    pointRadius: 0,
                    pointHoverRadius: 4
                },
                {
                    label: 'Actual HY Spread',
                    data: data.actual_spread,
                    borderColor: 'rgb(13, 110, 253)',
                    borderWidth: 2,
                    fill: false,
                    yAxisID: 'y',
                    pointRadius: 0,
                    pointHoverRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += context.parsed.y.toFixed(0) + ' bp';
                            return label;
                        }
                    }
                },
                annotation: {
                    annotations: recessionAnnotations
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: timeUnit,
                        displayFormats: {
                            day: 'MMM d',
                            week: 'MMM d',
                            month: 'MMM yyyy',
                            year: 'yyyy'
                        }
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Credit Spreads (bp)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Divergence Gap (bp)'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

// Time frame selector button handlers
document.querySelectorAll('#timeframe-selector button[data-timeframe]').forEach(button => {
    button.addEventListener('click', function() {
        // Update active button
        document.querySelectorAll('#timeframe-selector button').forEach(btn => {
            btn.classList.remove('active');
        });
        this.classList.add('active');

        // Apply time frame filter
        const timeFrame = this.getAttribute('data-timeframe');
        applyTimeFrameFilter(timeFrame);
    });
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDivergenceData();
    loadChartData();
});
</script>
{% endblock %}
