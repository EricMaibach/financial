{% extends "base.html" %}

{% block title %}Rates & Yield Curve - Financial Markets{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-graph-down-arrow text-primary"></i>
            Rates & Yield Curve
        </h1>
        <p class="lead">Tracking Treasury yields, curve shape, and inflation expectations</p>
    </div>
</div>

<!-- Educational Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-lightbulb-fill"></i> Understanding Interest Rates & The Yield Curve
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6><i class="bi bi-percent text-primary"></i> Treasury Yields</h6>
                        <p class="small mb-0">The 10-year Treasury yield is the benchmark "risk-free" rate. Higher yields = tighter financial conditions, headwind for growth stocks and bonds. Lower yields = easier conditions, tailwind for risk assets.</p>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="bi bi-arrow-left-right text-warning"></i> Yield Curve</h6>
                        <p class="small mb-0">The spread between long and short rates. <strong>Inverted curve</strong> (negative spread) has preceded every recession since 1970. <strong>Steepening</strong> after inversion often signals recession is imminent.</p>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="bi bi-fire text-danger"></i> Real Yields & Inflation</h6>
                        <p class="small mb-0">Real yield = nominal yield minus inflation expectations. Positive real yields = "restrictive" policy. Breakeven inflation shows what markets expect for inflation over the next 10 years.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Rates Briefing -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-chat-square-text-fill"></i> Daily Rates Briefing
                </h5>
                <small id="rates-summary-timestamp" class="opacity-75"></small>
            </div>
            <div class="card-body">
                <div id="rates-summary-content" class="summary-text">
                    <p class="text-muted mb-0"><i class="bi bi-hourglass-split"></i> Loading daily briefing...</p>
                </div>
                <div id="rates-summary-error" class="text-muted d-none">
                    <p class="mb-0"><i class="bi bi-info-circle"></i> No briefing available yet. Click "Reload Data" on the main dashboard to generate one.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics Row -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
        <a href="/explorer?metric=treasury_10y" class="metric-link">
            <div class="card metric-card border-primary">
                <div class="card-body">
                    <h6 class="text-muted">10-YEAR TREASURY</h6>
                    <h2 class="mb-0 text-primary" id="treasury-10y-value">--%</h2>
                    <small class="text-muted">
                        <span id="treasury-10y-change">--</span> bps (30d)
                    </small>
                    <div class="mt-2">
                        <span class="badge" id="treasury-10y-status">Loading</span>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <a href="/explorer?metric=yield_curve_10y2y" class="metric-link">
            <div class="card metric-card">
                <div class="card-body">
                    <h6 class="text-muted">YIELD CURVE (10Y-2Y)</h6>
                    <h2 class="mb-0" id="yield-curve-value">--%</h2>
                    <small class="text-muted">
                        <span id="yield-curve-change">--</span> bps (30d)
                    </small>
                    <div class="mt-2">
                        <span class="badge" id="yield-curve-status">Loading</span>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <a href="/explorer?metric=real_yield_10y" class="metric-link">
            <div class="card metric-card">
                <div class="card-body">
                    <h6 class="text-muted">REAL YIELD (10Y TIPS)</h6>
                    <h2 class="mb-0" id="real-yield-value">--%</h2>
                    <small class="text-muted">
                        <span id="real-yield-change">--</span> bps (30d)
                    </small>
                    <div class="mt-2">
                        <span class="badge" id="real-yield-status">Loading</span>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <a href="/explorer?metric=breakeven_inflation_10y" class="metric-link">
            <div class="card metric-card">
                <div class="card-body">
                    <h6 class="text-muted">BREAKEVEN INFLATION</h6>
                    <h2 class="mb-0" id="breakeven-value">--%</h2>
                    <small class="text-muted">
                        <span id="breakeven-change">--</span> bps (30d)
                    </small>
                    <div class="mt-2">
                        <span class="badge" id="breakeven-status">Loading</span>
                    </div>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Secondary Metrics Row -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
        <a href="/explorer?metric=yield_curve_10y3m" class="metric-link">
            <div class="card metric-card">
                <div class="card-body">
                    <h6 class="text-muted">YIELD CURVE (10Y-3M)</h6>
                    <h2 class="mb-0" id="yield-curve-3m-value">--%</h2>
                    <small class="text-muted">
                        <span id="yield-curve-3m-change">--</span> bps (30d)
                    </small>
                    <div class="mt-2">
                        <span class="badge" id="yield-curve-3m-status">Loading</span>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <a href="/explorer?metric=cpi_yoy" class="metric-link">
            <div class="card metric-card">
                <div class="card-body">
                    <h6 class="text-muted">CPI (YoY)</h6>
                    <h2 class="mb-0" id="cpi-value">--%</h2>
                    <small class="text-muted">Latest reading</small>
                    <div class="mt-2">
                        <span class="badge" id="cpi-status">Loading</span>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <a href="/explorer?metric=fed_funds_rate" class="metric-link">
            <div class="card metric-card">
                <div class="card-body">
                    <h6 class="text-muted">FED FUNDS RATE</h6>
                    <h2 class="mb-0" id="fed-funds-value">--%</h2>
                    <small class="text-muted">Upper bound</small>
                    <div class="mt-2">
                        <small class="text-muted">Policy rate</small>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card metric-card">
            <div class="card-body">
                <h6 class="text-muted">CURVE STATUS</h6>
                <h2 class="mb-0" id="curve-status-text">--</h2>
                <small class="text-muted" id="curve-status-detail">Analyzing...</small>
                <div class="mt-2">
                    <span class="badge" id="curve-signal-badge">Loading</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Credit Spreads Metrics Row -->
<div class="row mb-4">
    <div class="col-12">
        <h5 class="text-muted mb-3">
            <i class="bi bi-bank"></i> Credit Markets
        </h5>
    </div>
    <div class="col-xl-4 col-md-6 mb-3">
        <a href="/explorer?metric=hy_spread" class="metric-link">
            <div class="card metric-card border-danger">
                <div class="card-body">
                    <h6 class="text-muted">HIGH-YIELD SPREAD</h6>
                    <h2 class="mb-0 text-danger" id="hy-spread-value">-- bp</h2>
                    <small class="text-muted">
                        <span id="hy-spread-change">--</span> bps (30d)
                    </small>
                    <div class="mt-2">
                        <span class="badge" id="hy-spread-status">Loading</span>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <div class="col-xl-4 col-md-6 mb-3">
        <a href="/explorer?metric=ig_spread" class="metric-link">
            <div class="card metric-card">
                <div class="card-body">
                    <h6 class="text-muted">INVESTMENT GRADE SPREAD</h6>
                    <h2 class="mb-0" id="ig-spread-value">-- bp</h2>
                    <small class="text-muted">
                        <span id="ig-spread-change">--</span> bps (30d)
                    </small>
                    <div class="mt-2">
                        <span class="badge" id="ig-spread-status">Loading</span>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <div class="col-xl-4 col-md-6 mb-3">
        <div class="card metric-card">
            <div class="card-body">
                <h6 class="text-muted">CCC/HY RATIO</h6>
                <h2 class="mb-0" id="ccc-hy-ratio-value">--x</h2>
                <small class="text-muted">Distress indicator</small>
                <div class="mt-2">
                    <span class="badge" id="ccc-hy-ratio-status">Loading</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Treasury Yields Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up"></i> 10-Year Treasury Yield
                </h5>
                <div class="btn-group btn-group-sm" role="group" id="treasury-timeframe-buttons">
                    <button type="button" class="btn btn-outline-primary" data-timeframe="30">1M</button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="90">3M</button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="180">6M</button>
                    <button type="button" class="btn btn-outline-primary active" data-timeframe="365">1Y</button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="1825">5Y</button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="3650">10Y</button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="0">All</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="treasury-yield-chart"></canvas>
            </div>
            <div class="card-footer">
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> The 10-year Treasury yield is the benchmark for mortgage rates, corporate borrowing costs, and equity valuations. Grey bands = recession periods.
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Yield Curve Spreads Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-arrow-left-right"></i> Yield Curve Spreads
                </h5>
                <div class="btn-group btn-group-sm" role="group" id="curve-timeframe-buttons">
                    <button type="button" class="btn btn-outline-primary" data-timeframe="30">1M</button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="90">3M</button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="180">6M</button>
                    <button type="button" class="btn btn-outline-primary active" data-timeframe="365">1Y</button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="1825">5Y</button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="3650">10Y</button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="0">All</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="yield-curve-chart"></canvas>
            </div>
            <div class="card-footer">
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> Yield curve inversions (negative spreads) have preceded every U.S. recession since 1970. The 10Y-3M spread is Fed's preferred measure. Zero line = inversion threshold.
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Real Yields & Inflation Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-fire"></i> Real Yields & Inflation Expectations
                </h5>
                <div class="btn-group btn-group-sm" role="group" id="inflation-timeframe-buttons">
                    <button type="button" class="btn btn-outline-primary" data-timeframe="30">1M</button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="90">3M</button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="180">6M</button>
                    <button type="button" class="btn btn-outline-primary active" data-timeframe="365">1Y</button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="1825">5Y</button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="3650">10Y</button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="0">All</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="real-yield-chart"></canvas>
            </div>
            <div class="card-footer">
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> Real yield = nominal yield minus inflation expectations. Positive real yields mean policy is "restrictive." Breakeven inflation shows market's 10-year inflation forecast.
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Credit Spreads Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-bank"></i> Credit Spreads
                </h5>
                <div class="btn-group btn-group-sm" role="group" id="credit-timeframe-buttons">
                    <button type="button" class="btn btn-outline-primary" data-timeframe="30">1M</button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="90">3M</button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="180">6M</button>
                    <button type="button" class="btn btn-outline-primary active" data-timeframe="365">1Y</button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="1825">5Y</button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="3650">10Y</button>
                    <button type="button" class="btn btn-outline-primary" data-timeframe="0">All</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="credit-spreads-chart"></canvas>
            </div>
            <div class="card-footer">
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> Credit spreads measure risk premium over Treasuries. Tight spreads = complacency. Widening spreads = stress. HY at 300bp = first warning, 500bp = significant stress, 800bp+ = crisis.
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Bond ETF Performance -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-bar-chart-line"></i> Treasury ETF Performance
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ETF</th>
                                <th>Name</th>
                                <th>Price</th>
                                <th>5-Day</th>
                                <th>30-Day</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody id="bond-etf-table">
                            <tr><td colspan="6" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> Bond prices move inversely to yields. TLT (long duration) is most sensitive to rate changes. SHY (short duration) is most stable.
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Educational Sections -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header bg-danger text-white">
                <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Warning Signs</h6>
            </div>
            <div class="card-body">
                <ul class="mb-0 small">
                    <li><strong>Yield curve inversion</strong> - When short rates exceed long rates, recession risk rises</li>
                    <li><strong>Curve steepening after inversion</strong> - Often signals recession is beginning</li>
                    <li><strong>Real yields rising sharply</strong> - Tightening financial conditions, equity headwind</li>
                    <li><strong>Breakevens spiking</strong> - Inflation fears increasing, Fed may need to tighten more</li>
                    <li><strong>10Y above 5%</strong> - Historically restrictive, pressures valuations</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="bi bi-bookmark-check"></i> Key Levels to Watch</h6>
            </div>
            <div class="card-body">
                <ul class="mb-0 small">
                    <li><strong>10Y at 4.0%</strong> - Psychologically important level, below = more accommodative</li>
                    <li><strong>10Y at 5.0%</strong> - "Restrictive" territory, equity multiple compression</li>
                    <li><strong>Curve at 0%</strong> - Inversion/un-inversion threshold</li>
                    <li><strong>Real yield at 2%</strong> - Considered "tight" policy stance</li>
                    <li><strong>Breakeven at 2.5%</strong> - Above Fed's 2% target = inflation concerns</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Historical Context -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> Rate Cycle Context
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <h6>Yield Curve as Predictor</h6>
                        <p class="text-muted small mb-0">An inverted yield curve has preceded every U.S. recession since 1970 with a 6-18 month lead time. The 10Y-3M spread is the Fed's preferred measure.</p>
                    </div>
                    <div class="col-md-3">
                        <h6>Real Yields & Policy</h6>
                        <p class="text-muted small mb-0">The Fed targets a "neutral" real rate around 0.5-1%. Above 2% is considered restrictive. Negative real yields (2020-2022) were extremely accommodative.</p>
                    </div>
                    <div class="col-md-3">
                        <h6>Duration Risk</h6>
                        <p class="text-muted small mb-0">Long-duration bonds (TLT) can drop 20%+ when rates rise 1%. Short-duration (SHY) is safer but lower yielding. Duration = sensitivity to rate changes.</p>
                    </div>
                    <div class="col-md-3">
                        <h6>Rates & Equities</h6>
                        <p class="text-muted small mb-0">Rising rates compress equity multiples, especially for growth stocks. The "equity risk premium" (earnings yield minus 10Y) is key for valuations.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
let recessionData = [];
let treasuryYieldChart = null;
let yieldCurveChart = null;
let realYieldChart = null;
let creditSpreadsChart = null;

// Full data storage
let fullTreasury10yData = null;
let fullYieldCurve10y2yData = null;
let fullYieldCurve10y3mData = null;
let fullRealYieldData = null;
let fullBreakevenData = null;
let fullHYSpreadData = null;
let fullIGSpreadData = null;
let fullCCCSpreadData = null;

// Current timeframes for each chart
let treasuryTimeframe = 365;
let curveTimeframe = 365;
let inflationTimeframe = 365;
let creditTimeframe = 365;

// Fetch recession data on load
fetch('/api/recessions')
    .then(response => response.json())
    .then(data => {
        recessionData = data;
        // Re-render charts if data already loaded
        if (fullTreasury10yData) {
            buildTreasuryChart();
            buildYieldCurveChart();
            buildRealYieldChart();
            buildCreditSpreadsChart();
        }
    })
    .catch(error => {
        console.error('Error loading recession data:', error);
    });

// Generate recession annotations for chart
function getRecessionAnnotations(startDate, endDate) {
    if (!recessionData || recessionData.length === 0) return {};

    const chartStart = new Date(startDate);
    const chartEnd = new Date(endDate);
    const annotations = {};

    recessionData.forEach((recession, idx) => {
        const recStart = new Date(recession.start_date);
        const recEnd = new Date(recession.end_date);

        if (recEnd >= chartStart && recStart <= chartEnd) {
            const displayStart = recStart < chartStart ? chartStart : recStart;
            const displayEnd = recEnd > chartEnd ? chartEnd : recEnd;

            annotations[`recession_${idx}`] = {
                type: 'box',
                xMin: displayStart.toISOString().split('T')[0],
                xMax: displayEnd.toISOString().split('T')[0],
                backgroundColor: 'rgba(128, 128, 128, 0.15)',
                borderWidth: 0,
                label: { display: false }
            };
        }
    });

    return annotations;
}

// Filter data by timeframe
function filterByTimeframe(dates, values, days) {
    if (days === 0) return { dates, values }; // All data

    const now = new Date();
    const cutoffDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);

    const filteredDates = [];
    const filteredValues = [];

    dates.forEach((dateStr, idx) => {
        const date = new Date(dateStr);
        if (date >= cutoffDate) {
            filteredDates.push(dateStr);
            filteredValues.push(values[idx]);
        }
    });

    return { dates: filteredDates, values: filteredValues };
}

// Align datasets by date
function alignDataByDate(primaryDates, secondaryDates, secondaryValues) {
    const dateMap = new Map();
    secondaryDates.forEach((date, i) => {
        dateMap.set(date, secondaryValues[i]);
    });

    return primaryDates.map(date => dateMap.has(date) ? dateMap.get(date) : null);
}

// Determine time unit based on date range
function getTimeUnit(startDate, endDate) {
    const dateRange = new Date(endDate) - new Date(startDate);
    const dayRange = dateRange / (1000 * 60 * 60 * 24);
    if (dayRange <= 90) return 'day';
    if (dayRange <= 365) return 'week';
    if (dayRange <= 1825) return 'month';
    return 'year';
}

// Load all rates data
async function loadRatesData() {
    try {
        // Load 10-Year Treasury
        const treasury10yResponse = await fetch('/api/metrics/treasury_10y');
        const treasury10yData = await treasury10yResponse.json();

        if (treasury10yData && treasury10yData.values && treasury10yData.values.length > 0) {
            fullTreasury10yData = treasury10yData;
            const current = treasury10yData.values[treasury10yData.values.length - 1];
            document.getElementById('treasury-10y-value').textContent = current.toFixed(2) + '%';

            if (treasury10yData.values.length > 30) {
                const change30d = (current - treasury10yData.values[treasury10yData.values.length - 31]) * 100;
                document.getElementById('treasury-10y-change').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(0);

                const statusEl = document.getElementById('treasury-10y-status');
                if (current > 4.5) {
                    statusEl.textContent = 'ELEVATED';
                    statusEl.className = 'badge bg-warning';
                } else if (current > 3.5) {
                    statusEl.textContent = 'NORMAL';
                    statusEl.className = 'badge bg-secondary';
                } else {
                    statusEl.textContent = 'LOW';
                    statusEl.className = 'badge bg-success';
                }
            }
        }

        // Load Yield Curve 10Y-2Y
        const yc10y2yResponse = await fetch('/api/metrics/yield_curve_10y2y');
        const yc10y2yData = await yc10y2yResponse.json();

        if (yc10y2yData && yc10y2yData.values && yc10y2yData.values.length > 0) {
            fullYieldCurve10y2yData = yc10y2yData;
            const current = yc10y2yData.values[yc10y2yData.values.length - 1];
            document.getElementById('yield-curve-value').textContent = (current * 100).toFixed(0) + ' bps';

            if (yc10y2yData.values.length > 30) {
                const change30d = (current - yc10y2yData.values[yc10y2yData.values.length - 31]) * 100;
                document.getElementById('yield-curve-change').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(0);
            }

            const statusEl = document.getElementById('yield-curve-status');
            if (current < 0) {
                statusEl.textContent = 'INVERTED';
                statusEl.className = 'badge bg-danger';
            } else if (current < 0.5) {
                statusEl.textContent = 'FLAT';
                statusEl.className = 'badge bg-warning';
            } else {
                statusEl.textContent = 'NORMAL';
                statusEl.className = 'badge bg-success';
            }
        }

        // Load Yield Curve 10Y-3M
        const yc10y3mResponse = await fetch('/api/metrics/yield_curve_10y3m');
        const yc10y3mData = await yc10y3mResponse.json();

        if (yc10y3mData && yc10y3mData.values && yc10y3mData.values.length > 0) {
            fullYieldCurve10y3mData = yc10y3mData;
            const current = yc10y3mData.values[yc10y3mData.values.length - 1];
            document.getElementById('yield-curve-3m-value').textContent = (current * 100).toFixed(0) + ' bps';

            if (yc10y3mData.values.length > 30) {
                const change30d = (current - yc10y3mData.values[yc10y3mData.values.length - 31]) * 100;
                document.getElementById('yield-curve-3m-change').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(0);
            }

            const statusEl = document.getElementById('yield-curve-3m-status');
            if (current < 0) {
                statusEl.textContent = 'INVERTED';
                statusEl.className = 'badge bg-danger';
            } else if (current < 0.5) {
                statusEl.textContent = 'FLAT';
                statusEl.className = 'badge bg-warning';
            } else {
                statusEl.textContent = 'NORMAL';
                statusEl.className = 'badge bg-success';
            }

            // Update curve status summary
            updateCurveStatus(yc10y2yData, yc10y3mData);
        }

        // Load Real Yield
        const realYieldResponse = await fetch('/api/metrics/real_yield_10y');
        const realYieldData = await realYieldResponse.json();

        if (realYieldData && realYieldData.values && realYieldData.values.length > 0) {
            fullRealYieldData = realYieldData;
            const current = realYieldData.values[realYieldData.values.length - 1];
            document.getElementById('real-yield-value').textContent = current.toFixed(2) + '%';

            if (realYieldData.values.length > 30) {
                const change30d = (current - realYieldData.values[realYieldData.values.length - 31]) * 100;
                document.getElementById('real-yield-change').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(0);
            }

            const statusEl = document.getElementById('real-yield-status');
            if (current > 2) {
                statusEl.textContent = 'RESTRICTIVE';
                statusEl.className = 'badge bg-danger';
            } else if (current > 0.5) {
                statusEl.textContent = 'TIGHT';
                statusEl.className = 'badge bg-warning';
            } else if (current > 0) {
                statusEl.textContent = 'NEUTRAL';
                statusEl.className = 'badge bg-secondary';
            } else {
                statusEl.textContent = 'ACCOMMODATIVE';
                statusEl.className = 'badge bg-success';
            }
        }

        // Load Breakeven Inflation
        const breakevenResponse = await fetch('/api/metrics/breakeven_inflation_10y');
        const breakevenData = await breakevenResponse.json();

        if (breakevenData && breakevenData.values && breakevenData.values.length > 0) {
            fullBreakevenData = breakevenData;
            const current = breakevenData.values[breakevenData.values.length - 1];
            document.getElementById('breakeven-value').textContent = current.toFixed(2) + '%';

            if (breakevenData.values.length > 30) {
                const change30d = (current - breakevenData.values[breakevenData.values.length - 31]) * 100;
                document.getElementById('breakeven-change').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(0);
            }

            const statusEl = document.getElementById('breakeven-status');
            if (current > 2.5) {
                statusEl.textContent = 'ELEVATED';
                statusEl.className = 'badge bg-warning';
            } else if (current >= 2.0) {
                statusEl.textContent = 'AT TARGET';
                statusEl.className = 'badge bg-success';
            } else {
                statusEl.textContent = 'BELOW TARGET';
                statusEl.className = 'badge bg-info';
            }
        }

        // Load CPI
        const cpiResponse = await fetch('/api/metrics/cpi_yoy');
        const cpiData = await cpiResponse.json();

        if (cpiData && cpiData.values && cpiData.values.length > 0) {
            const current = cpiData.values[cpiData.values.length - 1];
            document.getElementById('cpi-value').textContent = current.toFixed(1) + '%';

            const statusEl = document.getElementById('cpi-status');
            if (current > 3) {
                statusEl.textContent = 'ABOVE TARGET';
                statusEl.className = 'badge bg-warning';
            } else if (current >= 1.5) {
                statusEl.textContent = 'NEAR TARGET';
                statusEl.className = 'badge bg-success';
            } else {
                statusEl.textContent = 'BELOW TARGET';
                statusEl.className = 'badge bg-info';
            }
        }

        // Load Fed Funds Rate
        const fedFundsResponse = await fetch('/api/metrics/fed_funds_rate');
        const fedFundsData = await fedFundsResponse.json();

        if (fedFundsData && fedFundsData.values && fedFundsData.values.length > 0) {
            const current = fedFundsData.values[fedFundsData.values.length - 1];
            document.getElementById('fed-funds-value').textContent = current.toFixed(2) + '%';
        }

        // Load Bond ETF data
        await loadBondETFs();

        // Load Credit Spreads
        await loadCreditSpreads();

        // Build charts
        buildTreasuryChart();
        buildYieldCurveChart();
        buildRealYieldChart();
        buildCreditSpreadsChart();

    } catch (error) {
        console.error('Error loading rates data:', error);
    }
}

async function loadCreditSpreads() {
    try {
        // Load HY Spread
        const hyResponse = await fetch('/api/metrics/hy_spread');
        const hyData = await hyResponse.json();

        if (hyData && hyData.values && hyData.values.length > 0) {
            fullHYSpreadData = hyData;
            const current = hyData.values[hyData.values.length - 1];
            document.getElementById('hy-spread-value').textContent = `${current.toFixed(0)} bp`;

            if (hyData.values.length > 30) {
                const change30d = current - hyData.values[hyData.values.length - 31];
                document.getElementById('hy-spread-change').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(0);
            }

            const statusEl = document.getElementById('hy-spread-status');
            if (current > 500) {
                statusEl.textContent = 'STRESS';
                statusEl.className = 'badge bg-danger';
            } else if (current > 350) {
                statusEl.textContent = 'ELEVATED';
                statusEl.className = 'badge bg-warning';
            } else if (current > 300) {
                statusEl.textContent = 'NORMAL';
                statusEl.className = 'badge bg-secondary';
            } else {
                statusEl.textContent = 'TIGHT';
                statusEl.className = 'badge bg-info';
            }
        }

        // Load IG Spread
        const igResponse = await fetch('/api/metrics/ig_spread');
        const igData = await igResponse.json();

        if (igData && igData.values && igData.values.length > 0) {
            fullIGSpreadData = igData;
            const current = igData.values[igData.values.length - 1];
            document.getElementById('ig-spread-value').textContent = `${current.toFixed(0)} bp`;

            if (igData.values.length > 30) {
                const change30d = current - igData.values[igData.values.length - 31];
                document.getElementById('ig-spread-change').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(0);
            }

            const statusEl = document.getElementById('ig-spread-status');
            if (current > 150) {
                statusEl.textContent = 'STRESS';
                statusEl.className = 'badge bg-danger';
            } else if (current > 120) {
                statusEl.textContent = 'ELEVATED';
                statusEl.className = 'badge bg-warning';
            } else if (current > 100) {
                statusEl.textContent = 'NORMAL';
                statusEl.className = 'badge bg-secondary';
            } else {
                statusEl.textContent = 'TIGHT';
                statusEl.className = 'badge bg-info';
            }
        }

        // Load CCC Spread for ratio calculation
        const cccResponse = await fetch('/api/metrics/ccc_spread');
        const cccData = await cccResponse.json();

        if (cccData && cccData.values && cccData.values.length > 0) {
            fullCCCSpreadData = cccData;

            // Calculate CCC/HY ratio
            if (fullHYSpreadData && fullHYSpreadData.values.length > 0) {
                const cccCurrent = cccData.values[cccData.values.length - 1];
                const hyCurrent = fullHYSpreadData.values[fullHYSpreadData.values.length - 1];
                const ratio = cccCurrent / hyCurrent;

                document.getElementById('ccc-hy-ratio-value').textContent = ratio.toFixed(2) + 'x';

                const statusEl = document.getElementById('ccc-hy-ratio-status');
                if (ratio > 3.5) {
                    statusEl.textContent = 'DISTRESS';
                    statusEl.className = 'badge bg-danger';
                } else if (ratio > 3.0) {
                    statusEl.textContent = 'ELEVATED';
                    statusEl.className = 'badge bg-warning';
                } else {
                    statusEl.textContent = 'NORMAL';
                    statusEl.className = 'badge bg-secondary';
                }
            }
        }

    } catch (error) {
        console.error('Error loading credit spreads:', error);
    }
}

function updateCurveStatus(yc10y2yData, yc10y3mData) {
    const current10y2y = yc10y2yData.values[yc10y2yData.values.length - 1];
    const current10y3m = yc10y3mData.values[yc10y3mData.values.length - 1];

    const statusText = document.getElementById('curve-status-text');
    const statusDetail = document.getElementById('curve-status-detail');
    const signalBadge = document.getElementById('curve-signal-badge');

    // Check for inversion
    const is10y2yInverted = current10y2y < 0;
    const is10y3mInverted = current10y3m < 0;

    if (is10y2yInverted && is10y3mInverted) {
        statusText.textContent = 'Inverted';
        statusDetail.textContent = 'Both spreads negative - recession risk elevated';
        signalBadge.textContent = 'WARNING';
        signalBadge.className = 'badge bg-danger';
    } else if (is10y2yInverted || is10y3mInverted) {
        statusText.textContent = 'Mixed';
        statusDetail.textContent = 'Partial inversion - monitor closely';
        signalBadge.textContent = 'CAUTION';
        signalBadge.className = 'badge bg-warning';
    } else if (current10y2y < 0.25 || current10y3m < 0.25) {
        statusText.textContent = 'Flat';
        statusDetail.textContent = 'Curve is relatively flat';
        signalBadge.textContent = 'NEUTRAL';
        signalBadge.className = 'badge bg-secondary';
    } else {
        statusText.textContent = 'Normal';
        statusDetail.textContent = 'Positively sloped curve';
        signalBadge.textContent = 'HEALTHY';
        signalBadge.className = 'badge bg-success';
    }
}

async function loadBondETFs() {
    const etfs = [
        { ticker: 'TLT', name: '20+ Year Treasury', duration: '~17 years' },
        { ticker: 'IEF', name: '7-10 Year Treasury', duration: '~7.5 years' },
        { ticker: 'SHY', name: '1-3 Year Treasury', duration: '~2 years' },
        { ticker: 'TIP', name: 'TIPS (Inflation Protected)', duration: '~7 years' }
    ];

    const tableBody = document.getElementById('bond-etf-table');
    const rows = [];

    for (const etf of etfs) {
        try {
            // Try to load ETF data - these may or may not exist
            const response = await fetch(`/api/metrics/${etf.ticker.toLowerCase()}_price`);
            if (response.ok) {
                const data = await response.json();
                if (data && data.values && data.values.length > 0) {
                    const current = data.values[data.values.length - 1];
                    let change5d = '--';
                    let change30d = '--';

                    if (data.values.length > 5) {
                        const pct5d = ((current / data.values[data.values.length - 6]) - 1) * 100;
                        change5d = `<span class="${pct5d >= 0 ? 'text-success' : 'text-danger'}">${pct5d >= 0 ? '+' : ''}${pct5d.toFixed(1)}%</span>`;
                    }
                    if (data.values.length > 30) {
                        const pct30d = ((current / data.values[data.values.length - 31]) - 1) * 100;
                        change30d = `<span class="${pct30d >= 0 ? 'text-success' : 'text-danger'}">${pct30d >= 0 ? '+' : ''}${pct30d.toFixed(1)}%</span>`;
                    }

                    rows.push(`
                        <tr>
                            <td><strong>${etf.ticker}</strong></td>
                            <td>${etf.name}</td>
                            <td>$${current.toFixed(2)}</td>
                            <td>${change5d}</td>
                            <td>${change30d}</td>
                            <td><small class="text-muted">${etf.duration}</small></td>
                        </tr>
                    `);
                    continue;
                }
            }
        } catch (e) {
            // ETF data not available
        }

        // Fallback row
        rows.push(`
            <tr>
                <td><strong>${etf.ticker}</strong></td>
                <td>${etf.name}</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td><small class="text-muted">${etf.duration}</small></td>
            </tr>
        `);
    }

    tableBody.innerHTML = rows.join('');
}

function buildTreasuryChart() {
    if (!fullTreasury10yData) return;

    const filtered = filterByTimeframe(fullTreasury10yData.dates, fullTreasury10yData.values, treasuryTimeframe);
    if (filtered.dates.length === 0) return;

    const startDate = filtered.dates[0];
    const endDate = filtered.dates[filtered.dates.length - 1];
    const recessionAnnotations = getRecessionAnnotations(startDate, endDate);
    const timeUnit = getTimeUnit(startDate, endDate);

    if (treasuryYieldChart) treasuryYieldChart.destroy();

    const ctx = document.getElementById('treasury-yield-chart').getContext('2d');
    treasuryYieldChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: filtered.dates,
            datasets: [{
                label: '10-Year Treasury Yield',
                data: filtered.values,
                borderColor: 'rgb(13, 110, 253)',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                borderWidth: 2,
                fill: true,
                pointRadius: 0,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                annotation: { annotations: recessionAnnotations },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: timeUnit, displayFormats: { day: 'MMM d', week: 'MMM d', month: 'MMM yyyy', year: 'yyyy' } }
                },
                y: {
                    title: { display: true, text: 'Yield (%)' }
                }
            }
        }
    });
}

function buildYieldCurveChart() {
    if (!fullYieldCurve10y2yData) return;

    const filtered10y2y = filterByTimeframe(fullYieldCurve10y2yData.dates, fullYieldCurve10y2yData.values, curveTimeframe);
    if (filtered10y2y.dates.length === 0) return;

    // Align 10Y-3M data to 10Y-2Y dates
    let aligned10y3m = null;
    if (fullYieldCurve10y3mData) {
        aligned10y3m = alignDataByDate(filtered10y2y.dates, fullYieldCurve10y3mData.dates, fullYieldCurve10y3mData.values);
    }

    const startDate = filtered10y2y.dates[0];
    const endDate = filtered10y2y.dates[filtered10y2y.dates.length - 1];
    const recessionAnnotations = getRecessionAnnotations(startDate, endDate);
    const timeUnit = getTimeUnit(startDate, endDate);

    // Add zero line annotation
    recessionAnnotations['zeroLine'] = {
        type: 'line',
        yMin: 0,
        yMax: 0,
        borderColor: 'rgba(220, 53, 69, 0.7)',
        borderWidth: 2,
        borderDash: [5, 5],
        label: {
            display: true,
            content: 'Inversion Threshold',
            position: 'end',
            backgroundColor: 'rgba(220, 53, 69, 0.8)',
            color: 'white',
            font: { size: 10 }
        }
    };

    if (yieldCurveChart) yieldCurveChart.destroy();

    const datasets = [{
        label: '10Y-2Y Spread',
        data: filtered10y2y.values.map(v => v * 100), // Convert to bps
        borderColor: 'rgb(13, 110, 253)',
        backgroundColor: 'rgba(13, 110, 253, 0.1)',
        borderWidth: 2,
        fill: true,
        pointRadius: 0,
        tension: 0.1
    }];

    if (aligned10y3m) {
        datasets.push({
            label: '10Y-3M Spread',
            data: aligned10y3m.map(v => v != null ? v * 100 : null), // Convert to bps
            borderColor: 'rgb(255, 193, 7)',
            borderWidth: 2,
            fill: false,
            pointRadius: 0,
            tension: 0.1
        });
    }

    const ctx = document.getElementById('yield-curve-chart').getContext('2d');
    yieldCurveChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: filtered10y2y.dates,
            datasets: datasets
        },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                annotation: { annotations: recessionAnnotations },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(0) + ' bps';
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: timeUnit, displayFormats: { day: 'MMM d', week: 'MMM d', month: 'MMM yyyy', year: 'yyyy' } }
                },
                y: {
                    title: { display: true, text: 'Spread (basis points)' }
                }
            }
        }
    });
}

function buildRealYieldChart() {
    if (!fullRealYieldData) return;

    const filteredReal = filterByTimeframe(fullRealYieldData.dates, fullRealYieldData.values, inflationTimeframe);
    if (filteredReal.dates.length === 0) return;

    // Align breakeven data
    let alignedBreakeven = null;
    if (fullBreakevenData) {
        alignedBreakeven = alignDataByDate(filteredReal.dates, fullBreakevenData.dates, fullBreakevenData.values);
    }

    const startDate = filteredReal.dates[0];
    const endDate = filteredReal.dates[filteredReal.dates.length - 1];
    const recessionAnnotations = getRecessionAnnotations(startDate, endDate);
    const timeUnit = getTimeUnit(startDate, endDate);

    // Add zero line for real yields
    recessionAnnotations['zeroLine'] = {
        type: 'line',
        yMin: 0,
        yMax: 0,
        borderColor: 'rgba(128, 128, 128, 0.5)',
        borderWidth: 1,
        borderDash: [3, 3]
    };

    if (realYieldChart) realYieldChart.destroy();

    const datasets = [{
        label: '10Y Real Yield (TIPS)',
        data: filteredReal.values,
        borderColor: 'rgb(13, 110, 253)',
        backgroundColor: 'rgba(13, 110, 253, 0.1)',
        borderWidth: 2,
        fill: true,
        pointRadius: 0,
        tension: 0.1,
        yAxisID: 'y'
    }];

    if (alignedBreakeven) {
        datasets.push({
            label: 'Breakeven Inflation',
            data: alignedBreakeven,
            borderColor: 'rgb(220, 53, 69)',
            borderWidth: 2,
            fill: false,
            pointRadius: 0,
            tension: 0.1,
            yAxisID: 'y1'
        });
    }

    const ctx = document.getElementById('real-yield-chart').getContext('2d');
    realYieldChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: filteredReal.dates,
            datasets: datasets
        },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                annotation: { annotations: recessionAnnotations },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: timeUnit, displayFormats: { day: 'MMM d', week: 'MMM d', month: 'MMM yyyy', year: 'yyyy' } }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'Real Yield (%)' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: { display: true, text: 'Breakeven Inflation (%)' },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
}

function buildCreditSpreadsChart() {
    if (!fullHYSpreadData) return;

    const filteredHY = filterByTimeframe(fullHYSpreadData.dates, fullHYSpreadData.values, creditTimeframe);
    if (filteredHY.dates.length === 0) return;

    // Align IG and CCC data to HY dates
    let alignedIG = null;
    let alignedCCC = null;
    if (fullIGSpreadData) {
        alignedIG = alignDataByDate(filteredHY.dates, fullIGSpreadData.dates, fullIGSpreadData.values);
    }
    if (fullCCCSpreadData) {
        alignedCCC = alignDataByDate(filteredHY.dates, fullCCCSpreadData.dates, fullCCCSpreadData.values);
    }

    const startDate = filteredHY.dates[0];
    const endDate = filteredHY.dates[filteredHY.dates.length - 1];
    const recessionAnnotations = getRecessionAnnotations(startDate, endDate);
    const timeUnit = getTimeUnit(startDate, endDate);

    // Add warning level annotations
    recessionAnnotations['warningLine'] = {
        type: 'line',
        yMin: 300,
        yMax: 300,
        borderColor: 'rgba(255, 193, 7, 0.6)',
        borderWidth: 1,
        borderDash: [5, 5],
        label: {
            display: true,
            content: 'First Warning (300bp)',
            position: 'end',
            backgroundColor: 'rgba(255, 193, 7, 0.8)',
            color: 'black',
            font: { size: 9 }
        }
    };
    recessionAnnotations['stressLine'] = {
        type: 'line',
        yMin: 500,
        yMax: 500,
        borderColor: 'rgba(220, 53, 69, 0.6)',
        borderWidth: 1,
        borderDash: [5, 5],
        label: {
            display: true,
            content: 'Stress (500bp)',
            position: 'end',
            backgroundColor: 'rgba(220, 53, 69, 0.8)',
            color: 'white',
            font: { size: 9 }
        }
    };

    if (creditSpreadsChart) creditSpreadsChart.destroy();

    const datasets = [{
        label: 'High Yield',
        data: filteredHY.values,
        borderColor: 'rgb(220, 53, 69)',
        backgroundColor: 'rgba(220, 53, 69, 0.1)',
        borderWidth: 2,
        fill: true,
        pointRadius: 0,
        tension: 0.1
    }];

    if (alignedIG) {
        datasets.push({
            label: 'Investment Grade',
            data: alignedIG,
            borderColor: 'rgb(13, 110, 253)',
            borderWidth: 2,
            fill: false,
            pointRadius: 0,
            tension: 0.1
        });
    }

    if (alignedCCC) {
        datasets.push({
            label: 'CCC-Rated',
            data: alignedCCC,
            borderColor: 'rgb(255, 193, 7)',
            borderWidth: 2,
            fill: false,
            pointRadius: 0,
            tension: 0.1
        });
    }

    const ctx = document.getElementById('credit-spreads-chart').getContext('2d');
    creditSpreadsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: filteredHY.dates,
            datasets: datasets
        },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                annotation: { annotations: recessionAnnotations },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(0) + ' bp';
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: timeUnit, displayFormats: { day: 'MMM d', week: 'MMM d', month: 'MMM yyyy', year: 'yyyy' } }
                },
                y: {
                    title: { display: true, text: 'Spread (basis points)' }
                }
            }
        }
    });
}

// Load AI-generated rates summary
async function loadRatesSummary() {
    try {
        const response = await fetch('/api/rates-summary');
        const data = await response.json();

        const contentDiv = document.getElementById('rates-summary-content');
        const errorDiv = document.getElementById('rates-summary-error');
        const timestampSpan = document.getElementById('rates-summary-timestamp');

        if (data.error) {
            contentDiv.classList.add('d-none');
            errorDiv.classList.remove('d-none');
            return;
        }

        // Use marked library for markdown rendering if available
        if (typeof marked !== 'undefined') {
            marked.setOptions({ breaks: true, gfm: true, sanitize: false });
            contentDiv.innerHTML = marked.parse(data.summary);
        } else {
            contentDiv.innerHTML = data.summary
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        if (data.generated_at) {
            const genDate = new Date(data.generated_at);
            const dateStr = genDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const timeStr = genDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            timestampSpan.textContent = `${dateStr} at ${timeStr}`;
        }

    } catch (error) {
        console.error('Error loading rates summary:', error);
        document.getElementById('rates-summary-content').classList.add('d-none');
        document.getElementById('rates-summary-error').classList.remove('d-none');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadRatesSummary();
    loadRatesData();

    // Treasury chart timeframe buttons
    document.querySelectorAll('#treasury-timeframe-buttons button[data-timeframe]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('#treasury-timeframe-buttons button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            treasuryTimeframe = parseInt(this.getAttribute('data-timeframe'));
            buildTreasuryChart();
        });
    });

    // Curve chart timeframe buttons
    document.querySelectorAll('#curve-timeframe-buttons button[data-timeframe]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('#curve-timeframe-buttons button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            curveTimeframe = parseInt(this.getAttribute('data-timeframe'));
            buildYieldCurveChart();
        });
    });

    // Inflation chart timeframe buttons
    document.querySelectorAll('#inflation-timeframe-buttons button[data-timeframe]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('#inflation-timeframe-buttons button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            inflationTimeframe = parseInt(this.getAttribute('data-timeframe'));
            buildRealYieldChart();
        });
    });

    // Credit spreads timeframe buttons
    document.querySelectorAll('#credit-timeframe-buttons button[data-timeframe]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('#credit-timeframe-buttons button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            creditTimeframe = parseInt(this.getAttribute('data-timeframe'));
            buildCreditSpreadsChart();
        });
    });
});
</script>
{% endblock %}
