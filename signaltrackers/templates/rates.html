{% extends "base.html" %}

{% block title %}Interest Rates - SignalTrackers{% endblock %}

{% block extra_css %}
<!-- Component Styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/chart-container.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/collapsible-section.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/key-stats-panel.css') }}">
<style>
/* Mobile-First Rates Page Styles */
:root {
    /* Design system custom properties */
    --space-1: 0.25rem;
    --space-2: 0.5rem;
    --space-3: 0.75rem;
    --space-4: 1rem;
    --space-5: 1.5rem;
    --space-6: 2rem;
    --space-8: 3rem;
    --space-10: 4rem;

    --text-xs: 0.75rem;
    --text-sm: 0.875rem;
    --text-base: 1rem;
    --text-lg: 1.125rem;
    --text-xl: 1.25rem;
    --text-2xl: 1.5rem;
    --text-3xl: 1.875rem;

    --neutral-50: #f8f9fa;
    --neutral-100: #f1f3f5;
    --neutral-200: #dee2e6;
    --neutral-300: #ced4da;
    --neutral-500: #6c757d;
    --neutral-600: #495057;
    --neutral-700: #343a40;
    --neutral-800: #212529;

    --brand-blue-100: #cfe2ff;
    --brand-blue-500: #0d6efd;
    --success-600: #198754;
    --danger-600: #dc3545;
    --warning-600: #ffc107;
    --info-600: #0dcaf0;

    --container-xl: 1280px;
}

/* Page header */
.rates-header {
    padding: var(--space-4);
    background: white;
    border-bottom: 1px solid var(--neutral-200);
}

.rates-header__title {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--neutral-800);
    margin: 0 0 var(--space-2) 0;
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.rates-header__description {
    font-size: var(--text-sm);
    color: var(--neutral-600);
    margin: 0 0 var(--space-2) 0;
}

.rates-header__updated {
    font-size: var(--text-sm);
    color: var(--neutral-500);
    margin: 0;
}

/* Content page */
.content-page {
    background: var(--neutral-50);
    min-height: calc(100vh - 64px);
}

/* Content grid (mobile: stacked, tablet+: side-by-side) */
.content-grid {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    padding: var(--space-4);
}

/* Time range controls */
.time-range-controls {
    display: flex;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    background: white;
    margin: 0 var(--space-4);
    border-radius: 8px;
    flex-wrap: wrap;
}

.time-range-controls__button {
    min-height: 44px;
    min-width: 60px;
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-sm);
    font-weight: 600;
    border: 1px solid var(--neutral-300);
    border-radius: 6px;
    background: white;
    color: var(--neutral-700);
    cursor: pointer;
    transition: all 150ms ease-out;
}

.time-range-controls__button:hover {
    background: var(--neutral-50);
    border-color: var(--brand-blue-500);
}

.time-range-controls__button.active {
    background: var(--brand-blue-500);
    color: white;
    border-color: var(--brand-blue-500);
}

.time-range-controls__button:focus {
    outline: 2px solid var(--brand-blue-500);
    outline-offset: 2px;
}

/* Statistics grid within collapsible section */
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
}

.stat-item {
    text-align: center;
    padding: var(--space-3);
    background: var(--neutral-50);
    border-radius: 8px;
}

.stat-item__label {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--neutral-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-2);
}

.stat-item__value {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--neutral-800);
    font-family: monospace;
}

.stat-item__value--large {
    font-size: var(--text-2xl);
}

.stat-item__secondary {
    font-size: var(--text-xs);
    color: var(--neutral-500);
    margin-top: var(--space-1);
}

/* Info cards */
.info-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-4);
}

.info-card {
    padding: var(--space-4);
    background: var(--neutral-50);
    border-radius: 8px;
    border-left: 4px solid var(--info-600);
}

.info-card__title {
    font-size: var(--text-base);
    font-weight: 600;
    color: var(--neutral-700);
    margin-bottom: var(--space-2);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.info-card__content {
    font-size: var(--text-sm);
    color: var(--neutral-600);
    line-height: 1.6;
}

.info-card__content ul {
    margin: 0;
    padding-left: var(--space-5);
}

.info-card__content li {
    margin-bottom: var(--space-2);
}

/* ETF table */
.etf-table {
    width: 100%;
    font-size: var(--text-sm);
    border-collapse: collapse;
}

.etf-table thead th {
    background: var(--neutral-100);
    padding: var(--space-3);
    text-align: left;
    font-weight: 600;
    color: var(--neutral-700);
    border-bottom: 2px solid var(--neutral-300);
}

.etf-table tbody td {
    padding: var(--space-3);
    border-bottom: 1px solid var(--neutral-200);
}

.etf-table tbody tr:hover {
    background: var(--neutral-50);
}

/* Tablet+ layouts */
@media (min-width: 768px) {
    .rates-header {
        padding: var(--space-6);
    }

    .rates-header__title {
        font-size: var(--text-3xl);
    }

    .content-grid {
        display: grid;
        grid-template-columns: 1.5fr 1fr; /* 60/40 split */
        gap: var(--space-6);
        padding: var(--space-6);
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .info-grid {
        grid-template-columns: 1fr 1fr;
    }
}

/* Desktop layouts */
@media (min-width: 1024px) {
    .content-grid {
        grid-template-columns: 2fr 1fr; /* 66/33 split */
        gap: var(--space-8);
        max-width: var(--container-xl);
        margin: 0 auto;
        padding: var(--space-8);
    }

    .stats-grid {
        grid-template-columns: 1fr 1fr;
    }

    .info-grid {
        grid-template-columns: 1fr 1fr 1fr;
    }
}

@media (min-width: 1280px) {
    .content-grid {
        gap: var(--space-10);
    }
}
</style>
{% endblock %}

{% block content %}
<main class="content-page">
    <!-- Page Header -->
    <header class="rates-header">
        <h1 class="rates-header__title">
            <i class="bi bi-graph-down-arrow text-primary"></i> Interest Rates
        </h1>
        <p class="rates-header__description">Tracking Treasury yields, curve shape, and inflation expectations</p>
        <p class="rates-header__updated">Last Updated: <span id="last-updated-time">Loading...</span></p>
    </header>

    <!-- Content Grid: Stacked on mobile, side-by-side on tablet+ -->
    <div class="content-grid">
        <!-- Left Column: Chart (mobile: full width, tablet+: 60-66% width) -->
        <div>
            <!-- Chart Container (HERO ELEMENT on mobile) -->
            <div class="chart-container">
                <canvas id="treasury-yield-chart"></canvas>
            </div>

            <!-- Time Range Controls (below chart) -->
            <div class="time-range-controls" id="treasury-timeframe-buttons">
                <button type="button" class="time-range-controls__button" data-timeframe="30">1M</button>
                <button type="button" class="time-range-controls__button" data-timeframe="90">3M</button>
                <button type="button" class="time-range-controls__button" data-timeframe="180">6M</button>
                <button type="button" class="time-range-controls__button active" data-timeframe="365">1Y</button>
                <button type="button" class="time-range-controls__button" data-timeframe="1825">5Y</button>
                <button type="button" class="time-range-controls__button" data-timeframe="3650">10Y</button>
                <button type="button" class="time-range-controls__button" data-timeframe="0">All</button>
            </div>
        </div>

        <!-- Right Column: Key Stats Panel (hidden on mobile, visible tablet+) -->
        <aside class="key-stats-panel">
            <h3 class="key-stats-panel__title">Key Metrics</h3>

            <div class="stat-card stat-card--info">
                <div class="stat-card__label">10-Year Treasury</div>
                <div class="stat-card__value" id="key-treasury-10y-value">--%</div>
                <div class="stat-card__secondary" id="key-treasury-10y-change">--</div>
            </div>

            <div class="stat-card stat-card--warning">
                <div class="stat-card__label">Yield Curve (10Y-2Y)</div>
                <div class="stat-card__value" id="key-yield-curve-value">--%</div>
                <div class="stat-card__secondary" id="key-yield-curve-status">--</div>
            </div>

            <div class="stat-card stat-card--neutral">
                <div class="stat-card__label">Real Yield</div>
                <div class="stat-card__value" id="key-real-yield-value">--%</div>
                <div class="stat-card__secondary">TIPS 10Y</div>
            </div>

            <div class="stat-card stat-card--success">
                <div class="stat-card__label">Breakeven Inflation</div>
                <div class="stat-card__value" id="key-breakeven-value">--%</div>
                <div class="stat-card__secondary">10Y forecast</div>
            </div>

            <div class="stat-card stat-card--danger">
                <div class="stat-card__label">HY Spread</div>
                <div class="stat-card__value" id="key-hy-spread-value">-- bp</div>
                <div class="stat-card__secondary">Credit risk</div>
            </div>
        </aside>
    </div>

    <!-- Collapsible Section: AI Daily Briefing -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="ai-briefing">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-chat-square-text-fill"></i> Daily Rates Briefing (AI)</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div style="background: white; padding: var(--space-4); border-radius: 8px;">
                <div id="rates-summary-content" class="summary-text">
                    <p class="text-muted mb-0"><i class="bi bi-hourglass-split"></i> Loading daily briefing...</p>
                </div>
                <div id="rates-summary-error" class="text-muted d-none">
                    <p class="mb-0"><i class="bi bi-info-circle"></i> No briefing available yet. Click "Reload Data" on the main dashboard to generate one.</p>
                </div>
                <div id="rates-summary-timestamp" style="margin-top: var(--space-3); font-size: var(--text-xs); color: var(--neutral-500);"></div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: Market Statistics -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="market-stats">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title">Market Statistics</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-item__label">10-Year Treasury</div>
                    <div class="stat-item__value stat-item__value--large" id="treasury-10y-value">--%</div>
                    <div class="stat-item__secondary" id="treasury-10y-change">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">Yield Curve (10Y-2Y)</div>
                    <div class="stat-item__value" id="yield-curve-value">--%</div>
                    <div class="stat-item__secondary" id="yield-curve-status">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">Yield Curve (10Y-3M)</div>
                    <div class="stat-item__value" id="yield-curve-3m-value">--%</div>
                    <div class="stat-item__secondary" id="yield-curve-3m-status">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">Real Yield (10Y TIPS)</div>
                    <div class="stat-item__value" id="real-yield-value">--%</div>
                    <div class="stat-item__secondary" id="real-yield-status">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">Breakeven Inflation</div>
                    <div class="stat-item__value" id="breakeven-value">--%</div>
                    <div class="stat-item__secondary" id="breakeven-status">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">CPI (YoY)</div>
                    <div class="stat-item__value" id="cpi-value">--%</div>
                    <div class="stat-item__secondary" id="cpi-status">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">Fed Funds Rate</div>
                    <div class="stat-item__value" id="fed-funds-value">--%</div>
                    <div class="stat-item__secondary">Policy rate</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item__label">Curve Status</div>
                    <div class="stat-item__value" id="curve-status-text">--</div>
                    <div class="stat-item__secondary" id="curve-status-detail">--</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: Additional Charts -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="additional-charts">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-graph-up"></i> Additional Charts</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div style="margin-bottom: var(--space-6);">
                <h4 style="margin: 0 0 var(--space-3) 0; font-size: var(--text-lg); font-weight: 600;">Yield Curve Spreads</h4>
                <div class="chart-container" style="height: 400px; margin: 0;">
                    <canvas id="yield-curve-chart"></canvas>
                </div>
                <div class="time-range-controls" id="curve-timeframe-buttons">
                    <button type="button" class="time-range-controls__button" data-timeframe="30">1M</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="90">3M</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="180">6M</button>
                    <button type="button" class="time-range-controls__button active" data-timeframe="365">1Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="1825">5Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="3650">10Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="0">All</button>
                </div>
            </div>

            <div style="margin-bottom: var(--space-6);">
                <h4 style="margin: 0 0 var(--space-3) 0; font-size: var(--text-lg); font-weight: 600;">Real Yields & Inflation Expectations</h4>
                <div class="chart-container" style="height: 400px; margin: 0;">
                    <canvas id="real-yield-chart"></canvas>
                </div>
                <div class="time-range-controls" id="inflation-timeframe-buttons">
                    <button type="button" class="time-range-controls__button" data-timeframe="30">1M</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="90">3M</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="180">6M</button>
                    <button type="button" class="time-range-controls__button active" data-timeframe="365">1Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="1825">5Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="3650">10Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="0">All</button>
                </div>
            </div>

            <div style="margin-bottom: var(--space-6);">
                <h4 style="margin: 0 0 var(--space-3) 0; font-size: var(--text-lg); font-weight: 600;">Credit Spreads</h4>
                <div class="chart-container" style="height: 400px; margin: 0;">
                    <canvas id="credit-spreads-chart"></canvas>
                </div>
                <div class="time-range-controls" id="credit-timeframe-buttons">
                    <button type="button" class="time-range-controls__button" data-timeframe="30">1M</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="90">3M</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="180">6M</button>
                    <button type="button" class="time-range-controls__button active" data-timeframe="365">1Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="1825">5Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="3650">10Y</button>
                    <button type="button" class="time-range-controls__button" data-timeframe="0">All</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: Understanding Rates -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="understanding-rates">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-lightbulb-fill"></i> Understanding Interest Rates</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-card__title"><i class="bi bi-percent text-primary"></i> Treasury Yields</div>
                    <div class="info-card__content">
                        <p class="mb-0">The 10-year Treasury yield is the benchmark "risk-free" rate. Higher yields = tighter financial conditions, headwind for growth stocks and bonds. Lower yields = easier conditions, tailwind for risk assets.</p>
                    </div>
                </div>
                <div class="info-card">
                    <div class="info-card__title"><i class="bi bi-arrow-left-right text-warning"></i> Yield Curve</div>
                    <div class="info-card__content">
                        <p class="mb-0">The spread between long and short rates. <strong>Inverted curve</strong> (negative spread) has preceded every recession since 1970. <strong>Steepening</strong> after inversion often signals recession is imminent.</p>
                    </div>
                </div>
                <div class="info-card">
                    <div class="info-card__title"><i class="bi bi-fire text-danger"></i> Real Yields</div>
                    <div class="info-card__content">
                        <p class="mb-0">Real yield = nominal yield minus inflation expectations. Positive real yields = "restrictive" policy. Breakeven inflation shows what markets expect for inflation over the next 10 years.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: Warning Signs -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="warning-signs">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-exclamation-triangle"></i> Warning Signs</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div class="info-card" style="border-left-color: var(--danger-600);">
                <div class="info-card__content">
                    <ul class="mb-0">
                        <li><strong>Yield curve inversion</strong> - When short rates exceed long rates, recession risk rises</li>
                        <li><strong>Curve steepening after inversion</strong> - Often signals recession is beginning</li>
                        <li><strong>Real yields rising sharply</strong> - Tightening financial conditions, equity headwind</li>
                        <li><strong>Breakevens spiking</strong> - Inflation fears increasing, Fed may need to tighten more</li>
                        <li><strong>10Y above 5%</strong> - Historically restrictive, pressures valuations</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: Key Levels to Watch -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="key-levels">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-bookmark-check"></i> Key Levels to Watch</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div class="info-card" style="border-left-color: var(--info-600);">
                <div class="info-card__content">
                    <ul class="mb-0">
                        <li><strong>10Y at 4.0%</strong> - Psychologically important level, below = more accommodative</li>
                        <li><strong>10Y at 5.0%</strong> - "Restrictive" territory, equity multiple compression</li>
                        <li><strong>Curve at 0%</strong> - Inversion/un-inversion threshold</li>
                        <li><strong>Real yield at 2%</strong> - Considered "tight" policy stance</li>
                        <li><strong>Breakeven at 2.5%</strong> - Above Fed's 2% target = inflation concerns</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Section: ETF Performance -->
    <div class="collapsible-section" data-collapsed="true" data-section-id="etf-performance">
        <button class="collapsible-section__header" aria-expanded="false">
            <h2 class="collapsible-section__title"><i class="bi bi-bar-chart-line"></i> Treasury ETF Performance</h2>
            <svg class="collapsible-section__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div class="collapsible-section__content" hidden>
            <div style="background: white; padding: var(--space-4); border-radius: 8px;">
                <table class="etf-table">
                    <thead>
                        <tr>
                            <th>ETF</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>5-Day</th>
                            <th>30-Day</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody id="bond-etf-table">
                        <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                    </tbody>
                </table>
                <div style="margin-top: var(--space-3); font-size: var(--text-xs); color: var(--neutral-500);">
                    <i class="bi bi-info-circle"></i> Bond prices move inversely to yields. TLT (long duration) is most sensitive to rate changes. SHY (short duration) is most stable.
                </div>
            </div>
        </div>
    </div>

</main>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
let recessionData = [];
let treasuryYieldChart = null;
let yieldCurveChart = null;
let realYieldChart = null;
let creditSpreadsChart = null;

// Full data storage
let fullTreasury10yData = null;
let fullYieldCurve10y2yData = null;
let fullYieldCurve10y3mData = null;
let fullRealYieldData = null;
let fullBreakevenData = null;
let fullHYSpreadData = null;
let fullIGSpreadData = null;
let fullCCCSpreadData = null;

// Current timeframes for each chart
let treasuryTimeframe = 365;
let curveTimeframe = 365;
let inflationTimeframe = 365;
let creditTimeframe = 365;

// Fetch recession data on load
fetch('/api/recessions')
    .then(response => response.json())
    .then(data => {
        recessionData = data;
        // Re-render charts if data already loaded
        if (fullTreasury10yData) {
            buildTreasuryChart();
            buildYieldCurveChart();
            buildRealYieldChart();
            buildCreditSpreadsChart();
        }
    })
    .catch(error => {
        console.error('Error loading recession data:', error);
    });

// Generate recession annotations for chart
function getRecessionAnnotations(startDate, endDate) {
    if (!recessionData || recessionData.length === 0) return {};

    const chartStart = new Date(startDate);
    const chartEnd = new Date(endDate);
    const annotations = {};

    recessionData.forEach((recession, idx) => {
        const recStart = new Date(recession.start_date);
        const recEnd = new Date(recession.end_date);

        if (recEnd >= chartStart && recStart <= chartEnd) {
            const displayStart = recStart < chartStart ? chartStart : recStart;
            const displayEnd = recEnd > chartEnd ? chartEnd : recEnd;

            annotations[`recession_${idx}`] = {
                type: 'box',
                xMin: displayStart.toISOString().split('T')[0],
                xMax: displayEnd.toISOString().split('T')[0],
                backgroundColor: 'rgba(128, 128, 128, 0.15)',
                borderWidth: 0,
                label: { display: false }
            };
        }
    });

    return annotations;
}

// Filter data by timeframe
function filterByTimeframe(dates, values, days) {
    if (days === 0) return { dates, values }; // All data

    const now = new Date();
    const cutoffDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);

    const filteredDates = [];
    const filteredValues = [];

    dates.forEach((dateStr, idx) => {
        const date = new Date(dateStr);
        if (date >= cutoffDate) {
            filteredDates.push(dateStr);
            filteredValues.push(values[idx]);
        }
    });

    return { dates: filteredDates, values: filteredValues };
}

// Align datasets by date
function alignDataByDate(primaryDates, secondaryDates, secondaryValues) {
    const dateMap = new Map();
    secondaryDates.forEach((date, i) => {
        dateMap.set(date, secondaryValues[i]);
    });

    return primaryDates.map(date => dateMap.has(date) ? dateMap.get(date) : null);
}

// Determine time unit based on date range
function getTimeUnit(startDate, endDate) {
    const dateRange = new Date(endDate) - new Date(startDate);
    const dayRange = dateRange / (1000 * 60 * 60 * 24);
    if (dayRange <= 90) return 'day';
    if (dayRange <= 365) return 'week';
    if (dayRange <= 1825) return 'month';
    return 'year';
}

// Load all rates data
async function loadRatesData() {
    try {
        // Load 10-Year Treasury
        const treasury10yResponse = await fetch('/api/metrics/treasury_10y');
        const treasury10yData = await treasury10yResponse.json();

        if (treasury10yData && treasury10yData.values && treasury10yData.values.length > 0) {
            fullTreasury10yData = treasury10yData;
            const current = treasury10yData.values[treasury10yData.values.length - 1];
            document.getElementById('treasury-10y-value').textContent = current.toFixed(2) + '%';
            document.getElementById('key-treasury-10y-value').textContent = current.toFixed(2) + '%';

            if (treasury10yData.values.length > 30) {
                const change30d = (current - treasury10yData.values[treasury10yData.values.length - 31]) * 100;
                document.getElementById('treasury-10y-change').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(0) + ' bps (30d)';
                document.getElementById('key-treasury-10y-change').textContent = (change30d >= 0 ? '+' : '') + change30d.toFixed(0) + ' bps (30d)';
            }
        }

        // Load Yield Curve 10Y-2Y
        const yc10y2yResponse = await fetch('/api/metrics/yield_curve_10y2y');
        const yc10y2yData = await yc10y2yResponse.json();

        if (yc10y2yData && yc10y2yData.values && yc10y2yData.values.length > 0) {
            fullYieldCurve10y2yData = yc10y2yData;
            const current = yc10y2yData.values[yc10y2yData.values.length - 1];
            document.getElementById('yield-curve-value').textContent = (current * 100).toFixed(0) + ' bps';
            document.getElementById('key-yield-curve-value').textContent = (current * 100).toFixed(0) + ' bps';

            const statusText = current < 0 ? 'Inverted' : current < 0.5 ? 'Flat' : 'Normal';
            document.getElementById('yield-curve-status').textContent = statusText;
            document.getElementById('key-yield-curve-status').textContent = statusText;
        }

        // Load Yield Curve 10Y-3M
        const yc10y3mResponse = await fetch('/api/metrics/yield_curve_10y3m');
        const yc10y3mData = await yc10y3mResponse.json();

        if (yc10y3mData && yc10y3mData.values && yc10y3mData.values.length > 0) {
            fullYieldCurve10y3mData = yc10y3mData;
            const current = yc10y3mData.values[yc10y3mData.values.length - 1];
            document.getElementById('yield-curve-3m-value').textContent = (current * 100).toFixed(0) + ' bps';

            const statusText = current < 0 ? 'Inverted' : current < 0.5 ? 'Flat' : 'Normal';
            document.getElementById('yield-curve-3m-status').textContent = statusText;

            // Update curve status summary
            updateCurveStatus(yc10y2yData, yc10y3mData);
        }

        // Load Real Yield
        const realYieldResponse = await fetch('/api/metrics/real_yield_10y');
        const realYieldData = await realYieldResponse.json();

        if (realYieldData && realYieldData.values && realYieldData.values.length > 0) {
            fullRealYieldData = realYieldData;
            const current = realYieldData.values[realYieldData.values.length - 1];
            document.getElementById('real-yield-value').textContent = current.toFixed(2) + '%';
            document.getElementById('key-real-yield-value').textContent = current.toFixed(2) + '%';

            const statusText = current > 2 ? 'Restrictive' : current > 0.5 ? 'Tight' : current > 0 ? 'Neutral' : 'Accommodative';
            document.getElementById('real-yield-status').textContent = statusText;
        }

        // Load Breakeven Inflation
        const breakevenResponse = await fetch('/api/metrics/breakeven_inflation_10y');
        const breakevenData = await breakevenResponse.json();

        if (breakevenData && breakevenData.values && breakevenData.values.length > 0) {
            fullBreakevenData = breakevenData;
            const current = breakevenData.values[breakevenData.values.length - 1];
            document.getElementById('breakeven-value').textContent = current.toFixed(2) + '%';
            document.getElementById('key-breakeven-value').textContent = current.toFixed(2) + '%';

            const statusText = current > 2.5 ? 'Elevated' : current >= 2.0 ? 'At Target' : 'Below Target';
            document.getElementById('breakeven-status').textContent = statusText;
        }

        // Load CPI
        const cpiResponse = await fetch('/api/metrics/cpi_yoy');
        const cpiData = await cpiResponse.json();

        if (cpiData && cpiData.values && cpiData.values.length > 0) {
            const current = cpiData.values[cpiData.values.length - 1];
            document.getElementById('cpi-value').textContent = current.toFixed(1) + '%';

            const statusText = current > 3 ? 'Above Target' : current >= 1.5 ? 'Near Target' : 'Below Target';
            document.getElementById('cpi-status').textContent = statusText;
        }

        // Load Fed Funds Rate
        const fedFundsResponse = await fetch('/api/metrics/fed_funds_rate');
        const fedFundsData = await fedFundsResponse.json();

        if (fedFundsData && fedFundsData.values && fedFundsData.values.length > 0) {
            const current = fedFundsData.values[fedFundsData.values.length - 1];
            document.getElementById('fed-funds-value').textContent = current.toFixed(2) + '%';
        }

        // Load Credit Spreads
        await loadCreditSpreads();

        // Load Bond ETFs
        await loadBondETFs();

        // Build charts
        buildTreasuryChart();
        buildYieldCurveChart();
        buildRealYieldChart();
        buildCreditSpreadsChart();

        // Update last updated time
        const now = new Date();
        document.getElementById('last-updated-time').textContent = now.toLocaleString();

    } catch (error) {
        console.error('Error loading rates data:', error);
    }
}

async function loadCreditSpreads() {
    try {
        // Load HY Spread
        const hyResponse = await fetch('/api/metrics/hy_spread');
        const hyData = await hyResponse.json();

        if (hyData && hyData.values && hyData.values.length > 0) {
            fullHYSpreadData = hyData;
            const currentBps = hyData.values[hyData.values.length - 1] * 100;
            document.getElementById('key-hy-spread-value').textContent = `${currentBps.toFixed(0)} bp`;
        }

        // Load IG Spread
        const igResponse = await fetch('/api/metrics/ig_spread');
        const igData = await igResponse.json();

        if (igData && igData.values && igData.values.length > 0) {
            fullIGSpreadData = igData;
        }

        // Load CCC Spread
        const cccResponse = await fetch('/api/metrics/ccc_spread');
        const cccData = await cccResponse.json();

        if (cccData && cccData.values && cccData.values.length > 0) {
            fullCCCSpreadData = cccData;
        }

    } catch (error) {
        console.error('Error loading credit spreads:', error);
    }
}

function updateCurveStatus(yc10y2yData, yc10y3mData) {
    const current10y2y = yc10y2yData.values[yc10y2yData.values.length - 1];
    const current10y3m = yc10y3mData.values[yc10y3mData.values.length - 1];

    const statusText = document.getElementById('curve-status-text');
    const statusDetail = document.getElementById('curve-status-detail');

    const is10y2yInverted = current10y2y < 0;
    const is10y3mInverted = current10y3m < 0;

    if (is10y2yInverted && is10y3mInverted) {
        statusText.textContent = 'Inverted';
        statusDetail.textContent = 'Both spreads negative - recession risk elevated';
    } else if (is10y2yInverted || is10y3mInverted) {
        statusText.textContent = 'Mixed';
        statusDetail.textContent = 'Partial inversion - monitor closely';
    } else if (current10y2y < 0.25 || current10y3m < 0.25) {
        statusText.textContent = 'Flat';
        statusDetail.textContent = 'Curve is relatively flat';
    } else {
        statusText.textContent = 'Normal';
        statusDetail.textContent = 'Positively sloped curve';
    }
}

async function loadBondETFs() {
    const etfs = [
        { ticker: 'TLT', name: '20+ Year Treasury', duration: '~17 years' },
        { ticker: 'IEF', name: '7-10 Year Treasury', duration: '~7.5 years' },
        { ticker: 'SHY', name: '1-3 Year Treasury', duration: '~2 years' },
        { ticker: 'TIP', name: 'TIPS (Inflation Protected)', duration: '~7 years' }
    ];

    const tableBody = document.getElementById('bond-etf-table');
    const rows = [];

    for (const etf of etfs) {
        rows.push(`
            <tr>
                <td><strong>${etf.ticker}</strong></td>
                <td>${etf.name}</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td><small class="text-muted">${etf.duration}</small></td>
            </tr>
        `);
    }

    tableBody.innerHTML = rows.join('');
}

function buildTreasuryChart() {
    if (!fullTreasury10yData) return;

    const filtered = filterByTimeframe(fullTreasury10yData.dates, fullTreasury10yData.values, treasuryTimeframe);
    if (filtered.dates.length === 0) return;

    const startDate = filtered.dates[0];
    const endDate = filtered.dates[filtered.dates.length - 1];
    const recessionAnnotations = getRecessionAnnotations(startDate, endDate);
    const timeUnit = getTimeUnit(startDate, endDate);

    if (treasuryYieldChart) treasuryYieldChart.destroy();

    const ctx = document.getElementById('treasury-yield-chart').getContext('2d');
    treasuryYieldChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: filtered.dates,
            datasets: [{
                label: '10-Year Treasury Yield',
                data: filtered.values,
                borderColor: 'rgb(13, 110, 253)',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                borderWidth: 2,
                fill: true,
                pointRadius: 0,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                annotation: { annotations: recessionAnnotations },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: timeUnit, displayFormats: { day: 'MMM d', week: 'MMM d', month: 'MMM yyyy', year: 'yyyy' } }
                },
                y: {
                    title: { display: true, text: 'Yield (%)' }
                }
            }
        }
    });
}

function buildYieldCurveChart() {
    if (!fullYieldCurve10y2yData) return;

    const filtered10y2y = filterByTimeframe(fullYieldCurve10y2yData.dates, fullYieldCurve10y2yData.values, curveTimeframe);
    if (filtered10y2y.dates.length === 0) return;

    let aligned10y3m = null;
    if (fullYieldCurve10y3mData) {
        aligned10y3m = alignDataByDate(filtered10y2y.dates, fullYieldCurve10y3mData.dates, fullYieldCurve10y3mData.values);
    }

    const startDate = filtered10y2y.dates[0];
    const endDate = filtered10y2y.dates[filtered10y2y.dates.length - 1];
    const recessionAnnotations = getRecessionAnnotations(startDate, endDate);
    const timeUnit = getTimeUnit(startDate, endDate);

    recessionAnnotations['zeroLine'] = {
        type: 'line',
        yMin: 0,
        yMax: 0,
        borderColor: 'rgba(220, 53, 69, 0.7)',
        borderWidth: 2,
        borderDash: [5, 5],
        label: {
            display: true,
            content: 'Inversion Threshold',
            position: 'end',
            backgroundColor: 'rgba(220, 53, 69, 0.8)',
            color: 'white',
            font: { size: 10 }
        }
    };

    if (yieldCurveChart) yieldCurveChart.destroy();

    const datasets = [{
        label: '10Y-2Y Spread',
        data: filtered10y2y.values.map(v => v * 100),
        borderColor: 'rgb(13, 110, 253)',
        backgroundColor: 'rgba(13, 110, 253, 0.1)',
        borderWidth: 2,
        fill: true,
        pointRadius: 0,
        tension: 0.1
    }];

    if (aligned10y3m) {
        datasets.push({
            label: '10Y-3M Spread',
            data: aligned10y3m.map(v => v != null ? v * 100 : null),
            borderColor: 'rgb(255, 193, 7)',
            borderWidth: 2,
            fill: false,
            pointRadius: 0,
            tension: 0.1
        });
    }

    const ctx = document.getElementById('yield-curve-chart').getContext('2d');
    yieldCurveChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: filtered10y2y.dates,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                annotation: { annotations: recessionAnnotations },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(0) + ' bps';
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: timeUnit, displayFormats: { day: 'MMM d', week: 'MMM d', month: 'MMM yyyy', year: 'yyyy' } }
                },
                y: {
                    title: { display: true, text: 'Spread (basis points)' }
                }
            }
        }
    });
}

function buildRealYieldChart() {
    if (!fullRealYieldData) return;

    const filteredReal = filterByTimeframe(fullRealYieldData.dates, fullRealYieldData.values, inflationTimeframe);
    if (filteredReal.dates.length === 0) return;

    let alignedBreakeven = null;
    if (fullBreakevenData) {
        alignedBreakeven = alignDataByDate(filteredReal.dates, fullBreakevenData.dates, fullBreakevenData.values);
    }

    const startDate = filteredReal.dates[0];
    const endDate = filteredReal.dates[filteredReal.dates.length - 1];
    const recessionAnnotations = getRecessionAnnotations(startDate, endDate);
    const timeUnit = getTimeUnit(startDate, endDate);

    recessionAnnotations['zeroLine'] = {
        type: 'line',
        yMin: 0,
        yMax: 0,
        borderColor: 'rgba(128, 128, 128, 0.5)',
        borderWidth: 1,
        borderDash: [3, 3]
    };

    if (realYieldChart) realYieldChart.destroy();

    const datasets = [{
        label: '10Y Real Yield (TIPS)',
        data: filteredReal.values,
        borderColor: 'rgb(13, 110, 253)',
        backgroundColor: 'rgba(13, 110, 253, 0.1)',
        borderWidth: 2,
        fill: true,
        pointRadius: 0,
        tension: 0.1,
        yAxisID: 'y'
    }];

    if (alignedBreakeven) {
        datasets.push({
            label: 'Breakeven Inflation',
            data: alignedBreakeven,
            borderColor: 'rgb(220, 53, 69)',
            borderWidth: 2,
            fill: false,
            pointRadius: 0,
            tension: 0.1,
            yAxisID: 'y1'
        });
    }

    const ctx = document.getElementById('real-yield-chart').getContext('2d');
    realYieldChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: filteredReal.dates,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                annotation: { annotations: recessionAnnotations },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: timeUnit, displayFormats: { day: 'MMM d', week: 'MMM d', month: 'MMM yyyy', year: 'yyyy' } }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'Real Yield (%)' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: { display: true, text: 'Breakeven Inflation (%)' },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
}

function buildCreditSpreadsChart() {
    if (!fullHYSpreadData) return;

    const filteredHY = filterByTimeframe(fullHYSpreadData.dates, fullHYSpreadData.values, creditTimeframe);
    if (filteredHY.dates.length === 0) return;

    const hyBps = filteredHY.values.map(v => v * 100);

    let alignedIGBps = null;
    let alignedCCCBps = null;
    if (fullIGSpreadData) {
        const alignedIG = alignDataByDate(filteredHY.dates, fullIGSpreadData.dates, fullIGSpreadData.values);
        alignedIGBps = alignedIG.map(v => v !== null ? v * 100 : null);
    }
    if (fullCCCSpreadData) {
        const alignedCCC = alignDataByDate(filteredHY.dates, fullCCCSpreadData.dates, fullCCCSpreadData.values);
        alignedCCCBps = alignedCCC.map(v => v !== null ? v * 100 : null);
    }

    const startDate = filteredHY.dates[0];
    const endDate = filteredHY.dates[filteredHY.dates.length - 1];
    const recessionAnnotations = getRecessionAnnotations(startDate, endDate);
    const timeUnit = getTimeUnit(startDate, endDate);

    recessionAnnotations['warningLine'] = {
        type: 'line',
        yMin: 300,
        yMax: 300,
        borderColor: 'rgba(255, 193, 7, 0.6)',
        borderWidth: 1,
        borderDash: [5, 5],
        label: {
            display: true,
            content: 'First Warning (300bp)',
            position: 'end',
            backgroundColor: 'rgba(255, 193, 7, 0.8)',
            color: 'black',
            font: { size: 9 }
        }
    };

    if (creditSpreadsChart) creditSpreadsChart.destroy();

    const datasets = [{
        label: 'High Yield',
        data: hyBps,
        borderColor: 'rgb(220, 53, 69)',
        backgroundColor: 'rgba(220, 53, 69, 0.1)',
        borderWidth: 2,
        fill: true,
        pointRadius: 0,
        tension: 0.1
    }];

    if (alignedIGBps) {
        datasets.push({
            label: 'Investment Grade',
            data: alignedIGBps,
            borderColor: 'rgb(13, 110, 253)',
            borderWidth: 2,
            fill: false,
            pointRadius: 0,
            tension: 0.1
        });
    }

    if (alignedCCCBps) {
        datasets.push({
            label: 'CCC-Rated',
            data: alignedCCCBps,
            borderColor: 'rgb(255, 193, 7)',
            borderWidth: 2,
            fill: false,
            pointRadius: 0,
            tension: 0.1
        });
    }

    const ctx = document.getElementById('credit-spreads-chart').getContext('2d');
    creditSpreadsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: filteredHY.dates,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                annotation: { annotations: recessionAnnotations },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(0) + ' bp';
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: timeUnit, displayFormats: { day: 'MMM d', week: 'MMM d', month: 'MMM yyyy', year: 'yyyy' } }
                },
                y: {
                    title: { display: true, text: 'Spread (basis points)' }
                }
            }
        }
    });
}

// Load AI-generated rates summary
async function loadRatesSummary() {
    try {
        const response = await fetch('/api/rates-summary');
        const data = await response.json();

        const contentDiv = document.getElementById('rates-summary-content');
        const errorDiv = document.getElementById('rates-summary-error');
        const timestampDiv = document.getElementById('rates-summary-timestamp');

        if (data.error) {
            contentDiv.classList.add('d-none');
            errorDiv.classList.remove('d-none');
            return;
        }

        if (typeof marked !== 'undefined') {
            marked.setOptions({ breaks: true, gfm: true, sanitize: false });
            contentDiv.innerHTML = marked.parse(data.summary);
        } else {
            contentDiv.innerHTML = data.summary
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        if (data.generated_at) {
            const genDate = new Date(data.generated_at);
            const dateStr = genDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const timeStr = genDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            timestampDiv.textContent = `Generated: ${dateStr} at ${timeStr}`;
        }

    } catch (error) {
        console.error('Error loading rates summary:', error);
        document.getElementById('rates-summary-content').classList.add('d-none');
        document.getElementById('rates-summary-error').classList.remove('d-none');
    }
}

// Initialize collapsible sections
function initCollapsibleSections() {
    const sections = document.querySelectorAll('.collapsible-section');

    sections.forEach(section => {
        const header = section.querySelector('.collapsible-section__header');
        const content = section.querySelector('.collapsible-section__content');

        header.addEventListener('click', () => {
            const isExpanded = header.getAttribute('aria-expanded') === 'true';

            header.setAttribute('aria-expanded', !isExpanded);
            content.hidden = isExpanded;
        });

        header.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                header.click();
            }
        });
    });
}

// Initialize time range controls
function initTimeRangeControls() {
    // Treasury chart
    document.querySelectorAll('#treasury-timeframe-buttons button[data-timeframe]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('#treasury-timeframe-buttons button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            treasuryTimeframe = parseInt(this.getAttribute('data-timeframe'));
            buildTreasuryChart();
        });
    });

    // Curve chart
    document.querySelectorAll('#curve-timeframe-buttons button[data-timeframe]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('#curve-timeframe-buttons button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            curveTimeframe = parseInt(this.getAttribute('data-timeframe'));
            buildYieldCurveChart();
        });
    });

    // Inflation chart
    document.querySelectorAll('#inflation-timeframe-buttons button[data-timeframe]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('#inflation-timeframe-buttons button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            inflationTimeframe = parseInt(this.getAttribute('data-timeframe'));
            buildRealYieldChart();
        });
    });

    // Credit spreads
    document.querySelectorAll('#credit-timeframe-buttons button[data-timeframe]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('#credit-timeframe-buttons button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            creditTimeframe = parseInt(this.getAttribute('data-timeframe'));
            buildCreditSpreadsChart();
        });
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadRatesSummary();
    loadRatesData();
    initCollapsibleSections();
    initTimeRangeControls();
});
</script>
{% endblock %}
