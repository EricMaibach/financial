# SignalTrackers Financial Dashboard
# Docker Compose for PREVIEW DEPLOYMENT (Portainer)
#
# Used to run the current open PR for human review before merging.
# Image is built and pushed by the Engineer agent when a PR is created.
#
# Usage in Portainer:
#   1. Create a new stack named "signaltrackers-preview"
#   2. Paste this file into the stack editor
#   3. Set environment variables in Portainer stack settings (same as production)
#   4. Configure GHCR credentials in Portainer (Registries) so it can pull the image
#   5. Enable the stack webhook and save the URL for agent use
#   6. Deploy
#
# Preview runs on port 5016 to avoid conflict with production (5000).
# Data is stored in named volumes isolated from production.

version: '3.8'

services:
  signaltrackers-preview:
    image: ghcr.io/ericmaibach/financial:preview
    container_name: signaltrackers-preview
    ports:
      - "5016:5000"
    environment:
      # Application Security
      - SECRET_KEY=${SECRET_KEY:-dev-key-change-in-production}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-}

      # AI Provider: 'openai' or 'anthropic' (for scheduled briefings)
      - AI_PROVIDER=${AI_PROVIDER:-anthropic}

      # System API Keys
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - FRED_API_KEY=${FRED_API_KEY:-}
      - TAVILY_API_KEY=${TAVILY_API_KEY:-}

      # Anthropic effort level (low/medium/high/max)
      - ANTHROPIC_EFFORT=${ANTHROPIC_EFFORT:-medium}

      # Email Configuration
      - MAIL_SERVER=${MAIL_SERVER:-smtp-relay.brevo.com}
      - MAIL_PORT=${MAIL_PORT:-587}
      - MAIL_USE_TLS=${MAIL_USE_TLS:-True}
      - MAIL_USE_SSL=${MAIL_USE_SSL:-False}
      - MAIL_USERNAME=${MAIL_USERNAME:-}
      - MAIL_PASSWORD=${MAIL_PASSWORD:-}
      - MAIL_DEFAULT_SENDER=${MAIL_DEFAULT_SENDER:-}
      - BASE_URL=${BASE_URL:-http://192.168.1.101:5016}
    volumes:
      # Named volumes â€” isolated from production data
      - signaltrackers-preview-data:/app/data
      - signaltrackers-preview-logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  signaltrackers-preview-data:
  signaltrackers-preview-logs:
